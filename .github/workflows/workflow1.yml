name: Build Native Flutter APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# This allows the workflow to commit without PAT
permissions:
  contents: write
  actions: read

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # ====================================
      # STEP 1: Checkout Repository
      # ====================================
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      # ====================================
      # STEP 2: Setup Java
      # ====================================
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      # ====================================
      # STEP 3: Setup Flutter
      # ====================================
      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ” Verify Flutter Installation
        run: |
          flutter --version
          flutter doctor -v

      # ====================================
      # STEP 4: Create Flutter Project
      # ====================================
      - name: ðŸ—ï¸ Create Flutter Project
        run: |
          rm -rf flutter_app
          flutter create --org com.complianceos --project-name compliance_os flutter_app
          echo "âœ… Flutter project created"

      # ====================================
      # STEP 5: Configure pubspec.yaml
      # ====================================
      - name: ðŸ“¦ Configure Dependencies
        run: |
          cd flutter_app
          
          cat > pubspec.yaml << 'PUBSPEC_EOF'
name: compliance_os
description: ComplianceOS - Tasks, Calendar, Clients Management
publish_to: 'none'
version: 1.0.0+1

environment:
  sdk: '>=3.0.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter
  
  # Firebase
  firebase_core: ^2.27.0
  firebase_auth: ^4.17.8
  cloud_firestore: ^4.15.8
  
  # HTTP & API
  http: ^1.2.0
  dio: ^5.4.1
  
  # State Management
  provider: ^6.1.2
  
  # Storage
  shared_preferences: ^2.2.2
  flutter_secure_storage: ^9.0.0
  
  # UI Components
  cupertino_icons: ^1.0.6
  google_fonts: ^6.1.0
  flutter_svg: ^2.0.10
  shimmer: ^3.0.0
  
  # Date & Time
  intl: ^0.19.0
  table_calendar: ^3.0.9
  
  # File Handling
  file_picker: ^6.2.0
  open_filex: ^4.4.0
  path_provider: ^2.1.2
  
  # Permissions
  permission_handler: ^11.3.0
  
  # URL
  url_launcher: ^6.2.5
  
  # Splash
  flutter_native_splash: ^2.3.10
  
  # Icons
  flutter_launcher_icons: ^0.13.1

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.0

flutter:
  uses-material-design: true
  
  assets:
    - assets/images/
    - assets/icons/

flutter_native_splash:
  color: "#0078D4"
  color_dark: "#0f0f10"
  image: assets/images/splash_logo.png
  android: true
  ios: false
  android_12:
    color: "#0078D4"
    color_dark: "#0f0f10"

flutter_launcher_icons:
  android: true
  ios: false
  image_path: "assets/images/app_icon.png"
  adaptive_icon_background: "#0078D4"
  adaptive_icon_foreground: "assets/images/app_icon.png"
PUBSPEC_EOF
          
          echo "âœ… pubspec.yaml configured"

      # ====================================
      # STEP 6: Create Assets
      # ====================================
      - name: ðŸŽ¨ Create Assets
        run: |
          cd flutter_app
          mkdir -p assets/images assets/icons
          
          # Create a simple SVG-based PNG for splash (base64 encoded minimal logo)
          # In production, replace with actual logo
          convert -size 512x512 xc:'#0078D4' -fill white -gravity center \
            -font DejaVu-Sans-Bold -pointsize 72 -annotate 0 'COS' \
            assets/images/splash_logo.png 2>/dev/null || \
          echo "Using placeholder splash"
          
          convert -size 512x512 xc:'#0078D4' -fill white -gravity center \
            -font DejaVu-Sans-Bold -pointsize 72 -annotate 0 'COS' \
            assets/images/app_icon.png 2>/dev/null || \
          echo "Using placeholder icon"
          
          # Create placeholder files if ImageMagick not available
          if [ ! -f assets/images/splash_logo.png ]; then
            # Create a minimal 1x1 PNG placeholder
            echo -n 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==' | base64 -d > assets/images/splash_logo.png
            cp assets/images/splash_logo.png assets/images/app_icon.png
          fi
          
          echo "âœ… Assets created"

      # ====================================
      # STEP 7: Create Theme Configuration
      # ====================================
      - name: ðŸŽ¨ Create Theme
        run: |
          cd flutter_app
          mkdir -p lib/config lib/models lib/services lib/providers lib/screens lib/widgets
          
          cat > lib/config/theme.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class AppTheme {
  // Colors
  static const Color primary = Color(0xFF0078D4);
  static const Color primaryHover = Color(0xFF006CC1);
  static const Color danger = Color(0xFFEF4444);
  static const Color warning = Color(0xFFF59E0B);
  static const Color success = Color(0xFF16A34A);
  
  // Light Theme Colors
  static const Color lightBg = Color(0xFFF3F3F3);
  static const Color lightPanel = Color(0xFFFFFFFF);
  static const Color lightText = Color(0xFF1B1B1B);
  static const Color lightMuted = Color(0xFF5D5D5D);
  static const Color lightBorder = Color(0x0F000000);
  
  // Dark Theme Colors
  static const Color darkBg = Color(0xFF0F0F10);
  static const Color darkPanel = Color(0xFF0F172A);
  static const Color darkText = Color(0xFFF4F4F5);
  static const Color darkMuted = Color(0xFFB6B6B6);
  static const Color darkBorder = Color(0x1AFFFFFF);

  // Accent colors for views
  static const Map<String, Color> viewAccents = {
    'home': Color(0xFF0EA5E9),
    'work': Color(0xFF8B5CF6),
    'calendar': Color(0xFFF97316),
    'clients': Color(0xFF22C55E),
    'studio': Color(0xFF06B6D4),
    'ops': Color(0xFFEF4444),
    'help': Color(0xFFA855F7),
  };

  static ThemeData lightTheme = ThemeData(
    useMaterial3: true,
    brightness: Brightness.light,
    colorScheme: ColorScheme.fromSeed(
      seedColor: primary,
      brightness: Brightness.light,
      background: lightBg,
      surface: lightPanel,
    ),
    scaffoldBackgroundColor: lightBg,
    textTheme: GoogleFonts.interTextTheme().apply(
      bodyColor: lightText,
      displayColor: lightText,
    ),
    appBarTheme: AppBarTheme(
      backgroundColor: lightPanel.withOpacity(0.7),
      foregroundColor: lightText,
      elevation: 0,
      centerTitle: false,
      titleTextStyle: GoogleFonts.inter(
        fontSize: 18,
        fontWeight: FontWeight.w900,
        color: lightText,
      ),
    ),
    cardTheme: CardTheme(
      color: lightPanel.withOpacity(0.92),
      elevation: 0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(24),
        side: BorderSide(color: lightBorder),
      ),
    ),
    elevatedButtonTheme: ElevatedButtonThemeData(
      style: ElevatedButton.styleFrom(
        backgroundColor: primary,
        foregroundColor: Colors.white,
        elevation: 0,
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        textStyle: GoogleFonts.inter(
          fontWeight: FontWeight.w800,
          fontSize: 14,
        ),
      ),
    ),
    outlinedButtonTheme: OutlinedButtonThemeData(
      style: OutlinedButton.styleFrom(
        foregroundColor: lightText,
        side: BorderSide(color: lightBorder),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        textStyle: GoogleFonts.inter(
          fontWeight: FontWeight.w800,
          fontSize: 14,
        ),
      ),
    ),
    inputDecorationTheme: InputDecorationTheme(
      filled: true,
      fillColor: lightPanel.withOpacity(0.92),
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: lightBorder),
      ),
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: lightBorder),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: const BorderSide(color: primary, width: 2),
      ),
      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
      hintStyle: GoogleFonts.inter(
        color: lightMuted,
        fontWeight: FontWeight.w600,
      ),
    ),
    dividerTheme: DividerThemeData(
      color: lightBorder,
      thickness: 1,
    ),
    chipTheme: ChipThemeData(
      backgroundColor: lightPanel.withOpacity(0.62),
      labelStyle: GoogleFonts.inter(
        fontWeight: FontWeight.w900,
        fontSize: 12,
      ),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(999),
        side: BorderSide(color: lightBorder),
      ),
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
    ),
    navigationRailTheme: NavigationRailThemeData(
      backgroundColor: lightPanel.withOpacity(0.7),
      selectedIconTheme: const IconThemeData(color: primary),
      unselectedIconTheme: IconThemeData(color: lightMuted),
      selectedLabelTextStyle: GoogleFonts.inter(
        fontWeight: FontWeight.w900,
        color: lightText,
      ),
      unselectedLabelTextStyle: GoogleFonts.inter(
        fontWeight: FontWeight.w900,
        color: lightMuted,
      ),
    ),
    bottomNavigationBarTheme: BottomNavigationBarThemeData(
      backgroundColor: lightPanel.withOpacity(0.92),
      selectedItemColor: primary,
      unselectedItemColor: lightMuted,
      type: BottomNavigationBarType.fixed,
      selectedLabelStyle: GoogleFonts.inter(
        fontWeight: FontWeight.w800,
        fontSize: 11,
      ),
      unselectedLabelStyle: GoogleFonts.inter(
        fontWeight: FontWeight.w700,
        fontSize: 11,
      ),
    ),
    snackBarTheme: SnackBarThemeData(
      backgroundColor: const Color(0xFF111827),
      contentTextStyle: GoogleFonts.inter(
        color: Colors.white,
        fontWeight: FontWeight.w700,
      ),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      behavior: SnackBarBehavior.floating,
    ),
  );

  static ThemeData darkTheme = ThemeData(
    useMaterial3: true,
    brightness: Brightness.dark,
    colorScheme: ColorScheme.fromSeed(
      seedColor: primary,
      brightness: Brightness.dark,
      background: darkBg,
      surface: darkPanel,
    ),
    scaffoldBackgroundColor: darkBg,
    textTheme: GoogleFonts.interTextTheme(ThemeData.dark().textTheme).apply(
      bodyColor: darkText,
      displayColor: darkText,
    ),
    appBarTheme: AppBarTheme(
      backgroundColor: darkPanel.withOpacity(0.6),
      foregroundColor: darkText,
      elevation: 0,
      centerTitle: false,
      titleTextStyle: GoogleFonts.inter(
        fontSize: 18,
        fontWeight: FontWeight.w900,
        color: darkText,
      ),
    ),
    cardTheme: CardTheme(
      color: darkPanel.withOpacity(0.6),
      elevation: 0,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(24),
        side: BorderSide(color: darkBorder),
      ),
    ),
    elevatedButtonTheme: ElevatedButtonThemeData(
      style: ElevatedButton.styleFrom(
        backgroundColor: primary,
        foregroundColor: Colors.white,
        elevation: 0,
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        textStyle: GoogleFonts.inter(
          fontWeight: FontWeight.w800,
          fontSize: 14,
        ),
      ),
    ),
    outlinedButtonTheme: OutlinedButtonThemeData(
      style: OutlinedButton.styleFrom(
        foregroundColor: darkText,
        side: BorderSide(color: darkBorder),
        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        textStyle: GoogleFonts.inter(
          fontWeight: FontWeight.w800,
          fontSize: 14,
        ),
      ),
    ),
    inputDecorationTheme: InputDecorationTheme(
      filled: true,
      fillColor: const Color(0xFF0B1220).withOpacity(0.7),
      border: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: darkBorder),
      ),
      enabledBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: BorderSide(color: darkBorder),
      ),
      focusedBorder: OutlineInputBorder(
        borderRadius: BorderRadius.circular(12),
        borderSide: const BorderSide(color: primary, width: 2),
      ),
      contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 14),
      hintStyle: GoogleFonts.inter(
        color: darkMuted,
        fontWeight: FontWeight.w600,
      ),
    ),
    dividerTheme: DividerThemeData(
      color: darkBorder,
      thickness: 1,
    ),
    chipTheme: ChipThemeData(
      backgroundColor: Colors.white.withOpacity(0.06),
      labelStyle: GoogleFonts.inter(
        fontWeight: FontWeight.w900,
        fontSize: 12,
      ),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(999),
        side: BorderSide(color: darkBorder),
      ),
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 8),
    ),
    navigationRailTheme: NavigationRailThemeData(
      backgroundColor: darkPanel.withOpacity(0.6),
      selectedIconTheme: const IconThemeData(color: primary),
      unselectedIconTheme: IconThemeData(color: darkMuted),
      selectedLabelTextStyle: GoogleFonts.inter(
        fontWeight: FontWeight.w900,
        color: darkText,
      ),
      unselectedLabelTextStyle: GoogleFonts.inter(
        fontWeight: FontWeight.w900,
        color: darkMuted,
      ),
    ),
    bottomNavigationBarTheme: BottomNavigationBarThemeData(
      backgroundColor: darkPanel.withOpacity(0.92),
      selectedItemColor: primary,
      unselectedItemColor: darkMuted,
      type: BottomNavigationBarType.fixed,
      selectedLabelStyle: GoogleFonts.inter(
        fontWeight: FontWeight.w800,
        fontSize: 11,
      ),
      unselectedLabelStyle: GoogleFonts.inter(
        fontWeight: FontWeight.w700,
        fontSize: 11,
      ),
    ),
    snackBarTheme: SnackBarThemeData(
      backgroundColor: const Color(0xFF111827).withOpacity(0.95),
      contentTextStyle: GoogleFonts.inter(
        color: Colors.white,
        fontWeight: FontWeight.w700,
      ),
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      behavior: SnackBarBehavior.floating,
    ),
  );
}
DART_EOF
          
          echo "âœ… Theme created"

      # ====================================
      # STEP 8: Create Constants
      # ====================================
      - name: âš™ï¸ Create Constants
        run: |
          cd flutter_app
          
          cat > lib/config/constants.dart << 'DART_EOF'
class AppConstants {
  // API Configuration
  static const String backendBaseUrl = "https://lease-moore-others-montreal.trycloudflare.com/.netlify/functions";
  static const String timezone = "Asia/Kolkata";
  
  // Firebase Configuration
  static const String firebaseApiKey = "AIzaSyCnWS-V96J6YDBVYKOeL5p8aa45GPTdSEg";
  static const String firebaseAuthDomain = "compliance-management-484405.firebaseapp.com";
  static const String firebaseProjectId = "compliance-management-484405";
  static const String firebaseStorageBucket = "compliance-management-484405.firebasestorage.app";
  static const String firebaseMessagingSenderId = "4348274796";
  static const String firebaseAppId = "1:4348274796:web:a9e1720c2ae223035bd049";
  
  // Roles
  static const String rolePartner = 'PARTNER';
  static const String roleManager = 'MANAGER';
  static const String roleAssociate = 'ASSOCIATE';
  
  // Task Statuses
  static const List<String> taskStatuses = [
    'PENDING',
    'IN_PROGRESS',
    'CLIENT_PENDING',
    'APPROVAL_PENDING',
    'COMPLETED',
  ];
  
  // Categories
  static const List<String> categories = [
    'GST',
    'TDS',
    'INCOME_TAX',
    'ROC',
    'ACCOUNTING',
    'AUDIT',
    'OTHER',
  ];
  
  // Priorities
  static const List<String> priorities = [
    'HIGH',
    'MEDIUM',
    'LOW',
  ];
  
  // Recurrence types
  static const List<String> recurrenceTypes = [
    'AD_HOC',
    'DAILY',
    'WEEKLY',
    'BIWEEKLY',
    'MONTHLY',
    'BIMONTHLY',
    'QUARTERLY',
    'HALF_YEARLY',
    'YEARLY',
  ];
}
DART_EOF
          
          echo "âœ… Constants created"

      # ====================================
      # STEP 9: Create Models
      # ====================================
      - name: ðŸ“Š Create Models
        run: |
          cd flutter_app
          
          cat > lib/models/user_model.dart << 'DART_EOF'
class UserModel {
  final String uid;
  final String email;
  final String displayName;
  final String role;
  final bool active;
  final String? managerEmail;

  UserModel({
    required this.uid,
    required this.email,
    required this.displayName,
    required this.role,
    this.active = true,
    this.managerEmail,
  });

  bool get isPartner => role.toUpperCase() == 'PARTNER';
  bool get isManager => role.toUpperCase() == 'MANAGER';
  bool get isAssociate => role.toUpperCase() == 'ASSOCIATE';
  bool get canSeeAllTasks => isPartner || isManager;
  bool get canEditDetails => isPartner || isManager;

  factory UserModel.fromJson(Map<String, dynamic> json) {
    String normalizedRole = (json['role'] ?? 'ASSOCIATE').toString().toUpperCase().trim();
    if (normalizedRole.isEmpty || normalizedRole == 'WORKER') {
      normalizedRole = 'ASSOCIATE';
    }
    
    return UserModel(
      uid: json['uid'] ?? '',
      email: json['email'] ?? '',
      displayName: json['displayName'] ?? '',
      role: normalizedRole,
      active: json['active'] ?? true,
      managerEmail: json['managerEmail'],
    );
  }

  Map<String, dynamic> toJson() => {
    'uid': uid,
    'email': email,
    'displayName': displayName,
    'role': role,
    'active': active,
    'managerEmail': managerEmail,
  };
}
DART_EOF

          cat > lib/models/client_model.dart << 'DART_EOF'
class ClientModel {
  final String id;
  final String name;
  final String? pan;
  final String? gstin;
  final String? cin;
  final String? assessmentYear;
  final String? engagementType;
  final String? primaryEmail;
  final List<String> ccEmails;
  final List<String> bccEmails;

  ClientModel({
    required this.id,
    required this.name,
    this.pan,
    this.gstin,
    this.cin,
    this.assessmentYear,
    this.engagementType,
    this.primaryEmail,
    this.ccEmails = const [],
    this.bccEmails = const [],
  });

  factory ClientModel.fromJson(Map<String, dynamic> json, String id) {
    return ClientModel(
      id: id,
      name: json['name'] ?? '',
      pan: json['pan'],
      gstin: json['gstin'],
      cin: json['cin'],
      assessmentYear: json['assessmentYear'],
      engagementType: json['engagementType'],
      primaryEmail: json['primaryEmail'],
      ccEmails: List<String>.from(json['ccEmails'] ?? []),
      bccEmails: List<String>.from(json['bccEmails'] ?? []),
    );
  }

  Map<String, dynamic> toJson() => {
    'name': name,
    'pan': pan,
    'gstin': gstin,
    'cin': cin,
    'assessmentYear': assessmentYear,
    'engagementType': engagementType,
    'primaryEmail': primaryEmail,
    'ccEmails': ccEmails,
    'bccEmails': bccEmails,
  };
}
DART_EOF

          cat > lib/models/task_model.dart << 'DART_EOF'
class TaskModel {
  final String id;
  final String? clientId;
  final String? clientName;
  final String title;
  final String? type;
  final String? category;
  final String? priority;
  final String? status;
  final String? statusNote;
  final String? delayReason;
  final String? delayNotes;
  final String? startDateYmd;
  final String? dueDateYmd;
  final String? snoozedUntilYmd;
  final String? assignedToEmail;
  final String? assignedToUid;
  final String? seriesId;
  final int? triggerDaysBefore;
  final bool sendClientStartMail;
  final bool sendClientCompletionMail;
  final bool clientStartMailSent;
  final String? clientStartGmailThreadId;
  final String? calendarHtmlLink;
  final List<Map<String, dynamic>> attachments;

  TaskModel({
    required this.id,
    this.clientId,
    this.clientName,
    required this.title,
    this.type,
    this.category,
    this.priority,
    this.status,
    this.statusNote,
    this.delayReason,
    this.delayNotes,
    this.startDateYmd,
    this.dueDateYmd,
    this.snoozedUntilYmd,
    this.assignedToEmail,
    this.assignedToUid,
    this.seriesId,
    this.triggerDaysBefore,
    this.sendClientStartMail = true,
    this.sendClientCompletionMail = true,
    this.clientStartMailSent = false,
    this.clientStartGmailThreadId,
    this.calendarHtmlLink,
    this.attachments = const [],
  });

  bool get isCompleted => status == 'COMPLETED';
  
  bool isSnoozedNow(String todayYmd) {
    if (snoozedUntilYmd == null || snoozedUntilYmd!.isEmpty) return false;
    if (isCompleted) return false;
    return snoozedUntilYmd!.compareTo(todayYmd) > 0;
  }

  String get normalizedCategory {
    final u = (category ?? '').toUpperCase().replaceAll(' ', '_');
    if (u == 'INCOME_TAX' || u == 'INCOME_TAX_RETURN' || u == 'INCOME') {
      return 'INCOME_TAX';
    }
    if (['GST', 'TDS', 'ROC', 'ACCOUNTING', 'AUDIT'].contains(u)) {
      return u;
    }
    return 'OTHER';
  }

  factory TaskModel.fromJson(Map<String, dynamic> json, String id) {
    return TaskModel(
      id: id,
      clientId: json['clientId'],
      clientName: json['clientName'],
      title: json['title'] ?? '',
      type: json['type'],
      category: json['category'],
      priority: json['priority'] ?? 'MEDIUM',
      status: json['status'] ?? 'PENDING',
      statusNote: json['statusNote'],
      delayReason: json['delayReason'],
      delayNotes: json['delayNotes'],
      startDateYmd: json['startDateYmd'],
      dueDateYmd: json['dueDateYmd'],
      snoozedUntilYmd: json['snoozedUntilYmd'],
      assignedToEmail: json['assignedToEmail'],
      assignedToUid: json['assignedToUid'],
      seriesId: json['seriesId'],
      triggerDaysBefore: json['triggerDaysBefore'],
      sendClientStartMail: json['sendClientStartMail'] ?? true,
      sendClientCompletionMail: json['sendClientCompletionMail'] ?? true,
      clientStartMailSent: json['clientStartMailSent'] ?? false,
      clientStartGmailThreadId: json['clientStartGmailThreadId'],
      calendarHtmlLink: json['calendarHtmlLink'],
      attachments: List<Map<String, dynamic>>.from(json['attachments'] ?? []),
    );
  }

  Map<String, dynamic> toJson() => {
    'clientId': clientId,
    'clientName': clientName,
    'title': title,
    'type': type,
    'category': category,
    'priority': priority,
    'status': status,
    'statusNote': statusNote,
    'delayReason': delayReason,
    'delayNotes': delayNotes,
    'startDateYmd': startDateYmd,
    'dueDateYmd': dueDateYmd,
    'snoozedUntilYmd': snoozedUntilYmd,
    'assignedToEmail': assignedToEmail,
    'assignedToUid': assignedToUid,
    'seriesId': seriesId,
    'triggerDaysBefore': triggerDaysBefore,
    'sendClientStartMail': sendClientStartMail,
    'sendClientCompletionMail': sendClientCompletionMail,
    'clientStartMailSent': clientStartMailSent,
    'clientStartGmailThreadId': clientStartGmailThreadId,
    'calendarHtmlLink': calendarHtmlLink,
    'attachments': attachments,
  };
}
DART_EOF

          cat > lib/models/comment_model.dart << 'DART_EOF'
import 'package:cloud_firestore/cloud_firestore.dart';

class CommentModel {
  final String id;
  final String text;
  final String authorEmail;
  final String? authorName;
  final DateTime createdAt;

  CommentModel({
    required this.id,
    required this.text,
    required this.authorEmail,
    this.authorName,
    required this.createdAt,
  });

  factory CommentModel.fromJson(Map<String, dynamic> json, String id) {
    DateTime created = DateTime.now();
    if (json['createdAt'] is Timestamp) {
      created = (json['createdAt'] as Timestamp).toDate();
    }
    
    return CommentModel(
      id: id,
      text: json['text'] ?? '',
      authorEmail: json['authorEmail'] ?? '',
      authorName: json['authorName'],
      createdAt: created,
    );
  }
}
DART_EOF

          echo "âœ… Models created"

      # ====================================
      # STEP 10: Create API Service
      # ====================================
      - name: ðŸŒ Create API Service
        run: |
          cd flutter_app
          
          cat > lib/services/api_service.dart << 'DART_EOF'
import 'dart:convert';
import 'dart:typed_data';
import 'package:http/http.dart' as http;
import 'package:firebase_auth/firebase_auth.dart';
import '../config/constants.dart';

class ApiResponse {
  final bool ok;
  final dynamic data;
  final String? error;
  final int statusCode;

  ApiResponse({
    required this.ok,
    this.data,
    this.error,
    required this.statusCode,
  });
}

class ApiService {
  static final ApiService _instance = ApiService._internal();
  factory ApiService() => _instance;
  ApiService._internal();

  final String _baseUrl = AppConstants.backendBaseUrl;

  Future<String?> _getToken() async {
    final user = FirebaseAuth.instance.currentUser;
    if (user == null) return null;
    return await user.getIdToken();
  }

  Future<ApiResponse> post(String endpoint, Map<String, dynamic> body) async {
    try {
      final token = await _getToken();
      if (token == null) {
        return ApiResponse(
          ok: false,
          error: 'Not signed in',
          statusCode: 401,
        );
      }

      final url = '$_baseUrl$endpoint';
      final response = await http.post(
        Uri.parse(url),
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer $token',
        },
        body: jsonEncode(body),
      );

      dynamic data;
      try {
        data = jsonDecode(response.body);
      } catch (_) {
        data = {'raw': response.body};
      }

      final bool isOk = data is Map && data['ok'] == true || response.statusCode == 200;

      return ApiResponse(
        ok: isOk,
        data: data,
        error: data is Map ? data['error'] : null,
        statusCode: response.statusCode,
      );
    } catch (e) {
      return ApiResponse(
        ok: false,
        error: e.toString(),
        statusCode: 0,
      );
    }
  }

  Future<ApiResponse> uploadFile(String endpoint, Uint8List fileBytes, String fileName, Map<String, String> fields) async {
    try {
      final token = await _getToken();
      if (token == null) {
        return ApiResponse(
          ok: false,
          error: 'Not signed in',
          statusCode: 401,
        );
      }

      final url = '$_baseUrl$endpoint';
      final request = http.MultipartRequest('POST', Uri.parse(url));
      
      request.headers['Authorization'] = 'Bearer $token';
      
      fields.forEach((key, value) {
        request.fields[key] = value;
      });

      request.files.add(http.MultipartFile.fromBytes(
        'file',
        fileBytes,
        filename: fileName,
      ));

      final streamedResponse = await request.send();
      final response = await http.Response.fromStream(streamedResponse);

      dynamic data;
      try {
        data = jsonDecode(response.body);
      } catch (_) {
        data = {'raw': response.body};
      }

      final bool isOk = data is Map && data['ok'] == true || response.statusCode == 200;

      return ApiResponse(
        ok: isOk,
        data: data,
        error: data is Map ? data['error'] : null,
        statusCode: response.statusCode,
      );
    } catch (e) {
      return ApiResponse(
        ok: false,
        error: e.toString(),
        statusCode: 0,
      );
    }
  }

  // Auth
  Future<ApiResponse> initSelf({String? displayName}) async {
    return post('/users_initself', {'displayName': displayName ?? ''});
  }

  // Tasks
  Future<ApiResponse> updateTaskStatus({
    required String taskId,
    required String newStatus,
    String? statusNote,
    String? delayReason,
    String? delayNotes,
  }) async {
    return post('/tasks_updatestatus', {
      'taskId': taskId,
      'newStatus': newStatus,
      'statusNote': statusNote,
      'delayReason': delayReason,
      'delayNotes': delayNotes,
    });
  }

  Future<ApiResponse> updateTask(Map<String, dynamic> taskData) async {
    return post('/tasks_updatetask', taskData);
  }

  Future<ApiResponse> deleteTask(String taskId, {bool applyToSeries = false}) async {
    return post('/tasks_delete', {
      'taskId': taskId,
      'applyToSeries': applyToSeries,
    });
  }

  Future<ApiResponse> addComment(String taskId, String text) async {
    return post('/tasks_addcomment', {
      'taskId': taskId,
      'text': text,
    });
  }

  Future<ApiResponse> createTask(Map<String, dynamic> taskData) async {
    return post('/tasks_createone', taskData);
  }

  Future<ApiResponse> bulkUpdate({
    required List<String> taskIds,
    required String op,
    Map<String, dynamic>? payload,
  }) async {
    return post('/tasks_bulkUpdate', {
      'taskIds': taskIds,
      'op': op,
      ...?payload,
    });
  }

  // Clients
  Future<ApiResponse> createClient(Map<String, dynamic> clientData) async {
    return post('/clients_create', clientData);
  }

  Future<ApiResponse> updateClient(Map<String, dynamic> clientData) async {
    return post('/clients_update', clientData);
  }

  // Exports
  Future<ApiResponse> exportFirmRangeXlsx({
    required String fromDmy,
    required String toDmy,
    bool includeAudit = true,
  }) async {
    return post('/exports_firmRangeWithHistoryXlsx', {
      'fromDmy': fromDmy,
      'toDmy': toDmy,
      'includeAudit': includeAudit,
    });
  }

  Future<ApiResponse> exportClientHistoryXlsx({
    required String clientId,
    required String fromYmd,
    required String toYmd,
  }) async {
    return post('/exports_clientHistoryXlsx', {
      'clientId': clientId,
      'fromYmd': fromYmd,
      'toYmd': toYmd,
    });
  }

  Future<ApiResponse> exportTaskHistoryXlsx(String taskId) async {
    return post('/exports_taskHistoryXlsx', {'taskId': taskId});
  }

  Future<ApiResponse> quickExport(String mode) async {
    return post('/exports_quickXlsx', {'mode': mode});
  }

  // Reports
  Future<ApiResponse> reportFirmRangePdf({
    required String fromDmy,
    required String toDmy,
  }) async {
    return post('/reports_firmRangePdf', {
      'fromDmy': fromDmy,
      'toDmy': toDmy,
    });
  }

  Future<ApiResponse> reportClientHistoryPdf({
    required String clientId,
    required String fromYmd,
    required String toYmd,
  }) async {
    return post('/reports_clientHistoryPdf', {
      'clientId': clientId,
      'fromYmd': fromYmd,
      'toYmd': toYmd,
    });
  }

  Future<ApiResponse> reportTaskHistoryPdf(String taskId) async {
    return post('/reports_taskHistoryPdf', {'taskId': taskId});
  }

  Future<ApiResponse> reportDailyDigestPdf() async {
    return post('/reports_dailyDigestPdf', {});
  }

  Future<ApiResponse> reportMonthlyPdf(String monthYmd) async {
    return post('/reports_monthlyPdf', {'monthYmd': monthYmd});
  }

  // Settings (Partner only)
  Future<ApiResponse> getSettings() async {
    return post('/settings_get', {});
  }

  Future<ApiResponse> updateSettings(Map<String, dynamic> settings) async {
    return post('/settings_update', settings);
  }

  Future<ApiResponse> getCalendarSettings() async {
    return post('/settings_calendar_get', {});
  }

  Future<ApiResponse> updateCalendarSettings(Map<String, dynamic> settings) async {
    return post('/settings_calendar_update', settings);
  }

  // Users (Partner only)
  Future<ApiResponse> listUsers() async {
    return post('/users_list', {});
  }

  Future<ApiResponse> setUserRole({
    required String uid,
    required String role,
    bool active = true,
  }) async {
    return post('/users_setrole', {
      'uid': uid,
      'role': role,
      'active': active,
    });
  }

  Future<ApiResponse> setUserManager({
    required String uid,
    required String managerEmail,
  }) async {
    return post('/users_setmanager', {
      'uid': uid,
      'managerEmail': managerEmail,
    });
  }

  Future<ApiResponse> setUserDisplayName({
    required String uid,
    required String displayName,
  }) async {
    return post('/users_setdisplayname', {
      'uid': uid,
      'displayName': displayName,
    });
  }

  // Series
  Future<ApiResponse> rebuildSeries({
    required String seriesId,
    required int addCount,
  }) async {
    return post('/series_rebuild', {
      'seriesId': seriesId,
      'addCount': addCount,
    });
  }

  Future<ApiResponse> reassignSeries({
    required String seriesId,
    required String assignedToEmail,
  }) async {
    return post('/series_reassign', {
      'seriesId': seriesId,
      'assignedToEmail': assignedToEmail,
    });
  }
}
DART_EOF
          
          echo "âœ… API Service created"

      # ====================================
      # STEP 11: Create Providers
      # ====================================
      - name: ðŸ”„ Create Providers
        run: |
          cd flutter_app
          
          cat > lib/providers/auth_provider.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import '../models/user_model.dart';
import '../services/api_service.dart';

class AuthProvider extends ChangeNotifier {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final ApiService _api = ApiService();

  User? _firebaseUser;
  UserModel? _userModel;
  bool _isLoading = false;
  String? _error;

  User? get firebaseUser => _firebaseUser;
  UserModel? get user => _userModel;
  bool get isLoading => _isLoading;
  String? get error => _error;
  bool get isAuthenticated => _firebaseUser != null;
  
  bool get isPartner => _userModel?.isPartner ?? false;
  bool get isManager => _userModel?.isManager ?? false;
  bool get isAssociate => _userModel?.isAssociate ?? true;
  bool get canSeeAllTasks => _userModel?.canSeeAllTasks ?? false;
  bool get canEditDetails => _userModel?.canEditDetails ?? false;

  AuthProvider() {
    _auth.authStateChanges().listen(_onAuthStateChanged);
  }

  Future<void> _onAuthStateChanged(User? user) async {
    _firebaseUser = user;
    
    if (user == null) {
      _userModel = null;
      notifyListeners();
      return;
    }

    // Initialize user profile
    await _api.initSelf();
    
    // Load user profile
    await _loadUserProfile(user.uid);
    
    notifyListeners();
  }

  Future<void> _loadUserProfile(String uid) async {
    try {
      final doc = await _firestore.collection('users').doc(uid).get();
      if (doc.exists) {
        _userModel = UserModel.fromJson({
          ...doc.data()!,
          'uid': uid,
          'email': _firebaseUser?.email ?? '',
        });
      } else {
        _userModel = UserModel(
          uid: uid,
          email: _firebaseUser?.email ?? '',
          displayName: _firebaseUser?.email?.split('@')[0] ?? '',
          role: 'ASSOCIATE',
        );
      }
    } catch (e) {
      debugPrint('Error loading user profile: $e');
      _userModel = UserModel(
        uid: uid,
        email: _firebaseUser?.email ?? '',
        displayName: _firebaseUser?.email?.split('@')[0] ?? '',
        role: 'ASSOCIATE',
      );
    }
  }

  Future<bool> signIn(String email, String password) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      await _auth.signInWithEmailAndPassword(
        email: email.trim(),
        password: password,
      );
      _isLoading = false;
      notifyListeners();
      return true;
    } on FirebaseAuthException catch (e) {
      _error = e.message ?? 'Sign in failed';
      _isLoading = false;
      notifyListeners();
      return false;
    } catch (e) {
      _error = e.toString();
      _isLoading = false;
      notifyListeners();
      return false;
    }
  }

  Future<bool> signUp(String email, String password) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      final credential = await _auth.createUserWithEmailAndPassword(
        email: email.trim(),
        password: password,
      );
      
      // Initialize profile
      await _api.initSelf(displayName: email.split('@')[0]);
      
      _isLoading = false;
      notifyListeners();
      return true;
    } on FirebaseAuthException catch (e) {
      _error = e.message ?? 'Sign up failed';
      _isLoading = false;
      notifyListeners();
      return false;
    } catch (e) {
      _error = e.toString();
      _isLoading = false;
      notifyListeners();
      return false;
    }
  }

  Future<bool> resetPassword(String email) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      await _auth.sendPasswordResetEmail(email: email.trim());
      _isLoading = false;
      notifyListeners();
      return true;
    } on FirebaseAuthException catch (e) {
      _error = e.message ?? 'Password reset failed';
      _isLoading = false;
      notifyListeners();
      return false;
    } catch (e) {
      _error = e.toString();
      _isLoading = false;
      notifyListeners();
      return false;
    }
  }

  Future<void> signOut() async {
    await _auth.signOut();
    _firebaseUser = null;
    _userModel = null;
    notifyListeners();
  }

  void clearError() {
    _error = null;
    notifyListeners();
  }
}
DART_EOF

          cat > lib/providers/app_provider.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../models/task_model.dart';
import '../models/client_model.dart';

class AppProvider extends ChangeNotifier {
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  final FirebaseAuth _auth = FirebaseAuth.instance;

  List<TaskModel> _tasks = [];
  List<ClientModel> _clients = [];
  Map<String, ClientModel> _clientsById = {};
  
  bool _isLoadingTasks = false;
  bool _isLoadingClients = false;
  int _selectedNavIndex = 0;
  ThemeMode _themeMode = ThemeMode.system;

  List<TaskModel> get tasks => _tasks;
  List<ClientModel> get clients => _clients;
  Map<String, ClientModel> get clientsById => _clientsById;
  bool get isLoadingTasks => _isLoadingTasks;
  bool get isLoadingClients => _isLoadingClients;
  int get selectedNavIndex => _selectedNavIndex;
  ThemeMode get themeMode => _themeMode;

  void setNavIndex(int index) {
    _selectedNavIndex = index;
    notifyListeners();
  }

  void toggleTheme() {
    if (_themeMode == ThemeMode.light) {
      _themeMode = ThemeMode.dark;
    } else if (_themeMode == ThemeMode.dark) {
      _themeMode = ThemeMode.light;
    } else {
      // System - default to light
      _themeMode = ThemeMode.light;
    }
    notifyListeners();
  }

  void setThemeMode(ThemeMode mode) {
    _themeMode = mode;
    notifyListeners();
  }

  Stream<List<TaskModel>> tasksStream({bool isPartnerOrManager = false}) {
    final user = _auth.currentUser;
    if (user == null) return Stream.value([]);

    Query query;
    if (isPartnerOrManager) {
      query = _firestore.collection('tasks').limit(2500);
    } else {
      query = _firestore
          .collection('tasks')
          .where('assignedToUid', isEqualTo: user.uid)
          .limit(2500);
    }

    return query.snapshots().map((snapshot) {
      _tasks = snapshot.docs
          .map((doc) => TaskModel.fromJson(doc.data() as Map<String, dynamic>, doc.id))
          .toList();
      notifyListeners();
      return _tasks;
    });
  }

  Stream<List<ClientModel>> clientsStream() {
    return _firestore
        .collection('clients')
        .orderBy('name', descending: false)
        .limit(1200)
        .snapshots()
        .map((snapshot) {
      _clients = snapshot.docs
          .map((doc) => ClientModel.fromJson(doc.data(), doc.id))
          .toList();
      _clientsById = {for (var c in _clients) c.id: c};
      notifyListeners();
      return _clients;
    });
  }

  String? getClientName(String? clientId) {
    if (clientId == null) return null;
    return _clientsById[clientId]?.name;
  }

  void refreshData() {
    notifyListeners();
  }
}
DART_EOF
          
          echo "âœ… Providers created"

      # ====================================
      # STEP 12: Create Utility Functions
      # ====================================
      - name: ðŸ› ï¸ Create Utilities
        run: |
          cd flutter_app
          
          cat > lib/utils/date_utils.dart << 'DART_EOF'
import 'package:intl/intl.dart';

class AppDateUtils {
  static const String timezone = 'Asia/Kolkata';
  
  static String todayYmd() {
    return DateFormat('yyyy-MM-dd').format(DateTime.now());
  }

  static String ymdToDmy(String? ymd) {
    if (ymd == null || ymd.isEmpty) return '';
    try {
      final date = DateTime.parse(ymd);
      return DateFormat('dd-MM-yyyy').format(date);
    } catch (_) {
      return '';
    }
  }

  static String dmyToYmd(String dmy) {
    final pattern = RegExp(r'^(\d{2})-(\d{2})-(\d{4})$');
    final match = pattern.firstMatch(dmy.trim());
    if (match == null) {
      throw FormatException('Invalid date "$dmy". Use DD-MM-YYYY');
    }
    return '${match.group(3)}-${match.group(2)}-${match.group(1)}';
  }

  static int diffDays(String fromYmd, String toYmd) {
    try {
      final from = DateTime.parse(fromYmd);
      final to = DateTime.parse(toYmd);
      return to.difference(from).inDays;
    } catch (_) {
      return 0;
    }
  }

  static String formatDateTime(DateTime dt) {
    return DateFormat('dd-MM-yyyy HH:mm').format(dt);
  }

  static String formatDate(DateTime dt) {
    return DateFormat('dd-MM-yyyy').format(dt);
  }

  static DateTime parseYmd(String ymd) {
    return DateTime.parse(ymd);
  }
}
DART_EOF

          cat > lib/utils/helpers.dart << 'DART_EOF'
import 'dart:convert';
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:path_provider/path_provider.dart';
import 'package:open_filex/open_filex.dart';

class Helpers {
  static void showSnackBar(BuildContext context, String message, {bool isError = false}) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: isError ? Colors.red.shade700 : null,
        behavior: SnackBarBehavior.floating,
        duration: Duration(seconds: isError ? 5 : 3),
      ),
    );
  }

  static Future<void> downloadBase64File({
    required BuildContext context,
    required String base64Data,
    required String fileName,
    String? mimeType,
  }) async {
    try {
      final bytes = base64Decode(base64Data);
      final dir = await getApplicationDocumentsDirectory();
      final file = File('${dir.path}/$fileName');
      await file.writeAsBytes(bytes);
      
      await OpenFilex.open(file.path);
      
      if (context.mounted) {
        showSnackBar(context, 'File saved: $fileName');
      }
    } catch (e) {
      if (context.mounted) {
        showSnackBar(context, 'Download failed: $e', isError: true);
      }
    }
  }

  static List<String> parseEmailList(String? input) {
    if (input == null || input.isEmpty) return [];
    return input
        .split(RegExp(r'[;,:]'))
        .map((e) => e.trim())
        .where((e) => e.isNotEmpty)
        .toList();
  }

  static String joinEmails(List<String>? emails) {
    if (emails == null || emails.isEmpty) return '';
    return emails.join('; ');
  }
}
DART_EOF
          
          echo "âœ… Utilities created"

      # ====================================
      # STEP 13: Create Widgets
      # ====================================
      - name: ðŸ§© Create Widgets
        run: |
          cd flutter_app
          
          cat > lib/widgets/app_card.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class AppCard extends StatelessWidget {
  final String title;
  final String? subtitle;
  final Widget? trailing;
  final Widget child;
  final Color? accentColor;
  final EdgeInsetsGeometry? padding;

  const AppCard({
    super.key,
    required this.title,
    this.subtitle,
    this.trailing,
    required this.child,
    this.accentColor,
    this.padding,
  });

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final isDark = theme.brightness == Brightness.dark;
    
    return Container(
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(24),
        border: Border.all(
          color: accentColor?.withOpacity(0.45) ?? 
                 (isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.06)),
        ),
        color: isDark 
            ? Colors.white.withOpacity(0.05)
            : Colors.white.withOpacity(0.7),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          // Header
          Container(
            padding: const EdgeInsets.fromLTRB(16, 16, 16, 10),
            decoration: BoxDecoration(
              border: Border(
                bottom: BorderSide(
                  color: (isDark ? Colors.white : Colors.black).withOpacity(0.06),
                ),
              ),
            ),
            child: Row(
              children: [
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        title,
                        style: GoogleFonts.inter(
                          fontSize: 18,
                          fontWeight: FontWeight.w900,
                          letterSpacing: 0.2,
                        ),
                      ),
                      if (subtitle != null) ...[
                        const SizedBox(height: 6),
                        Text(
                          subtitle!,
                          style: GoogleFonts.inter(
                            fontSize: 13,
                            fontWeight: FontWeight.w650,
                            color: theme.textTheme.bodyMedium?.color?.withOpacity(0.6),
                          ),
                        ),
                      ],
                    ],
                  ),
                ),
                if (trailing != null) trailing!,
              ],
            ),
          ),
          // Body
          Padding(
            padding: padding ?? const EdgeInsets.all(16),
            child: child,
          ),
        ],
      ),
    );
  }
}
DART_EOF

          cat > lib/widgets/status_pill.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import '../config/theme.dart';
import '../models/task_model.dart';
import '../utils/date_utils.dart';

enum PillType { normal, danger, warning, success, muted }

class StatusPill extends StatelessWidget {
  final String text;
  final PillType type;

  const StatusPill({
    super.key,
    required this.text,
    this.type = PillType.normal,
  });

  factory StatusPill.forTask(TaskModel task) {
    final today = AppDateUtils.todayYmd();
    
    if (task.status == 'COMPLETED') {
      return const StatusPill(text: 'DONE', type: PillType.success);
    }
    
    if (task.dueDateYmd == null || task.dueDateYmd!.isEmpty) {
      return const StatusPill(text: 'NO DUE', type: PillType.muted);
    }

    final dd = AppDateUtils.diffDays(today, task.dueDateYmd!);
    final sd = task.startDateYmd != null 
        ? AppDateUtils.diffDays(today, task.startDateYmd!) 
        : null;

    if (dd < 0) return const StatusPill(text: 'OVERDUE', type: PillType.danger);
    if (dd == 0) return const StatusPill(text: 'DUE TODAY', type: PillType.danger);
    if (dd <= 3) {
      if (sd != null && sd > 0) {
        return const StatusPill(text: 'HIGH ALERT', type: PillType.danger);
      }
      return const StatusPill(text: 'DUE SOON', type: PillType.warning);
    }
    if (sd != null && sd == 0) {
      return const StatusPill(text: 'START TODAY', type: PillType.warning);
    }
    if (dd <= 7) return const StatusPill(text: 'THIS WEEK', type: PillType.warning);
    
    return const StatusPill(text: 'OK', type: PillType.muted);
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;
    
    Color bgColor;
    Color borderColor;
    Color textColor;

    switch (type) {
      case PillType.danger:
        bgColor = AppTheme.danger.withOpacity(0.18);
        borderColor = AppTheme.danger.withOpacity(0.55);
        textColor = isDark ? Colors.white : Colors.black87;
        break;
      case PillType.warning:
        bgColor = AppTheme.warning.withOpacity(0.18);
        borderColor = AppTheme.warning.withOpacity(0.55);
        textColor = isDark ? Colors.white : Colors.black87;
        break;
      case PillType.success:
        bgColor = AppTheme.success.withOpacity(0.18);
        borderColor = AppTheme.success.withOpacity(0.55);
        textColor = isDark ? Colors.white : Colors.black87;
        break;
      case PillType.muted:
        bgColor = (isDark ? Colors.white : Colors.black).withOpacity(0.06);
        borderColor = (isDark ? Colors.white : Colors.black).withOpacity(0.12);
        textColor = isDark ? AppTheme.darkMuted : AppTheme.lightMuted;
        break;
      default:
        bgColor = (isDark ? Colors.white : Colors.black).withOpacity(0.06);
        borderColor = (isDark ? Colors.white : Colors.black).withOpacity(0.12);
        textColor = isDark ? Colors.white : Colors.black87;
    }

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
      decoration: BoxDecoration(
        color: bgColor,
        borderRadius: BorderRadius.circular(999),
        border: Border.all(color: borderColor),
      ),
      child: Text(
        text,
        style: GoogleFonts.inter(
          fontSize: 12,
          fontWeight: FontWeight.w900,
          color: textColor,
        ),
      ),
    );
  }
}
DART_EOF

          cat > lib/widgets/category_pill.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class CategoryPill extends StatelessWidget {
  final String category;

  const CategoryPill({super.key, required this.category});

  String get normalizedCategory {
    final u = category.toUpperCase().replaceAll(' ', '_');
    if (u == 'INCOME_TAX' || u == 'INCOME_TAX_RETURN' || u == 'INCOME') {
      return 'INCOME_TAX';
    }
    if (['GST', 'TDS', 'ROC', 'ACCOUNTING', 'AUDIT'].contains(u)) {
      return u;
    }
    return 'OTHER';
  }

  Color get backgroundColor {
    switch (normalizedCategory) {
      case 'GST':
        return const Color(0xFF22C55E).withOpacity(0.25);
      case 'TDS':
        return const Color(0xFF3B82F6).withOpacity(0.25);
      case 'INCOME_TAX':
        return const Color(0xFFA855F7).withOpacity(0.25);
      case 'ROC':
        return const Color(0xFFF59E0B).withOpacity(0.25);
      case 'ACCOUNTING':
        return const Color(0xFF14B8A6).withOpacity(0.25);
      case 'AUDIT':
        return const Color(0xFFF43F5E).withOpacity(0.20);
      default:
        return const Color(0xFF94A3B8).withOpacity(0.25);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
      decoration: BoxDecoration(
        color: backgroundColor,
        borderRadius: BorderRadius.circular(999),
      ),
      child: Text(
        normalizedCategory.replaceAll('_', ' '),
        style: GoogleFonts.inter(
          fontSize: 12,
          fontWeight: FontWeight.w900,
          color: const Color(0xFF0B1220),
        ),
      ),
    );
  }
}
DART_EOF

          cat > lib/widgets/loading_overlay.dart << 'DART_EOF'
import 'package:flutter/material.dart';

class LoadingOverlay extends StatelessWidget {
  final bool isLoading;
  final Widget child;

  const LoadingOverlay({
    super.key,
    required this.isLoading,
    required this.child,
  });

  @override
  Widget build(BuildContext context) {
    return Stack(
      children: [
        child,
        if (isLoading)
          Container(
            color: Colors.black.withOpacity(0.28),
            child: Center(
              child: Container(
                width: 54,
                height: 54,
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(999),
                  border: Border.all(
                    color: Colors.white.withOpacity(0.25),
                    width: 5,
                  ),
                ),
                child: const CircularProgressIndicator(
                  strokeWidth: 5,
                  valueColor: AlwaysStoppedAnimation<Color>(
                    Color(0xFF0078D4),
                  ),
                ),
              ),
            ),
          ),
      ],
    );
  }
}
DART_EOF
          
          echo "âœ… Widgets created"

      # ====================================
      # STEP 14: Create Screens - Part 1
      # ====================================
      - name: ðŸ“± Create Screens Part 1
        run: |
          cd flutter_app
          
          cat > lib/screens/auth_screen.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:provider/provider.dart';
import '../providers/auth_provider.dart';
import '../widgets/app_card.dart';
import '../config/theme.dart';

class AuthScreen extends StatefulWidget {
  const AuthScreen({super.key});

  @override
  State<AuthScreen> createState() => _AuthScreenState();
}

class _AuthScreenState extends State<AuthScreen> {
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _isSignUp = false;
  bool _isForgot = false;

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  Future<void> _handleSubmit() async {
    final auth = context.read<AuthProvider>();
    final email = _emailController.text.trim();
    final password = _passwordController.text;

    if (email.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Enter email')),
      );
      return;
    }

    if (_isForgot) {
      final success = await auth.resetPassword(email);
      if (mounted && success) {
        ScaffoldMessenger.of(context).showSnackBar(
          const SnackBar(content: Text('Reset email sent')),
        );
        setState(() => _isForgot = false);
      }
      return;
    }

    if (password.isEmpty || password.length < 6) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Password must be at least 6 characters')),
      );
      return;
    }

    bool success;
    if (_isSignUp) {
      success = await auth.signUp(email, password);
    } else {
      success = await auth.signIn(email, password);
    }

    if (mounted && !success && auth.error != null) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text(auth.error!), backgroundColor: Colors.red.shade700),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    final auth = context.watch<AuthProvider>();
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Scaffold(
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: isDark
                ? [const Color(0xFF0F0F10), const Color(0xFF0B0B0C)]
                : [const Color(0xFFF3F3F3), const Color(0xFFE8E8E8)],
          ),
        ),
        child: SafeArea(
          child: Center(
            child: SingleChildScrollView(
              padding: const EdgeInsets.all(24),
              child: ConstrainedBox(
                constraints: const BoxConstraints(maxWidth: 450),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    // Brand
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Container(
                          width: 56,
                          height: 56,
                          decoration: BoxDecoration(
                            borderRadius: BorderRadius.circular(18),
                            gradient: const LinearGradient(
                              colors: [AppTheme.primary, Color(0xFF5AA7FF), Color(0xFF64D2FF)],
                            ),
                            boxShadow: [
                              BoxShadow(
                                color: AppTheme.primary.withOpacity(0.3),
                                blurRadius: 24,
                                offset: const Offset(0, 10),
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(width: 16),
                        Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              'ComplianceOS',
                              style: GoogleFonts.inter(
                                fontSize: 24,
                                fontWeight: FontWeight.w900,
                              ),
                            ),
                            Text(
                              'Tasks Â· Calendar Â· Reminders',
                              style: GoogleFonts.inter(
                                fontSize: 13,
                                fontWeight: FontWeight.w700,
                                color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                    const SizedBox(height: 40),

                    // Auth Card
                    AppCard(
                      title: _isForgot
                          ? 'Reset Password'
                          : (_isSignUp ? 'Create Account' : 'Sign In'),
                      subtitle: 'Timezone: Asia/Kolkata (IST). Dates: DD-MM-YYYY.',
                      child: Column(
                        children: [
                          // Email
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Text(
                                'Email',
                                style: GoogleFonts.inter(
                                  fontSize: 12,
                                  fontWeight: FontWeight.w900,
                                  color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                                ),
                              ),
                              const SizedBox(height: 6),
                              TextField(
                                controller: _emailController,
                                keyboardType: TextInputType.emailAddress,
                                decoration: const InputDecoration(
                                  hintText: 'name@firm.com',
                                ),
                              ),
                              const SizedBox(height: 6),
                              Text(
                                'Use your firm email.',
                                style: GoogleFonts.inter(
                                  fontSize: 13,
                                  fontWeight: FontWeight.w650,
                                  color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 16),

                          // Password
                          if (!_isForgot)
                            Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'Password',
                                  style: GoogleFonts.inter(
                                    fontSize: 12,
                                    fontWeight: FontWeight.w900,
                                    color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                                  ),
                                ),
                                const SizedBox(height: 6),
                                TextField(
                                  controller: _passwordController,
                                  obscureText: true,
                                  decoration: const InputDecoration(
                                    hintText: 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢',
                                  ),
                                ),
                                const SizedBox(height: 6),
                                Text(
                                  'Minimum 6 characters (Firebase).',
                                  style: GoogleFonts.inter(
                                    fontSize: 13,
                                    fontWeight: FontWeight.w650,
                                    color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                                  ),
                                ),
                              ],
                            ),
                          const SizedBox(height: 24),

                          // Buttons
                          Wrap(
                            spacing: 10,
                            runSpacing: 10,
                            children: [
                              ElevatedButton(
                                onPressed: auth.isLoading ? null : _handleSubmit,
                                child: Text(
                                  _isForgot
                                      ? 'Send Reset Email'
                                      : (_isSignUp ? 'Create Account' : 'Sign In'),
                                ),
                              ),
                              if (!_isForgot)
                                OutlinedButton(
                                  onPressed: auth.isLoading
                                      ? null
                                      : () => setState(() => _isSignUp = !_isSignUp),
                                  child: Text(_isSignUp ? 'Sign In Instead' : 'Create Account'),
                                ),
                              TextButton(
                                onPressed: auth.isLoading
                                    ? null
                                    : () => setState(() => _isForgot = !_isForgot),
                                child: Text(_isForgot ? 'Back to Sign In' : 'Forgot Password'),
                              ),
                            ],
                          ),
                          const SizedBox(height: 16),
                          
                          Row(
                            children: [
                              Container(
                                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                decoration: BoxDecoration(
                                  color: isDark ? Colors.white.withOpacity(0.06) : Colors.black.withOpacity(0.04),
                                  borderRadius: BorderRadius.circular(8),
                                ),
                                child: Text(
                                  'Ctrl',
                                  style: GoogleFonts.robotoMono(
                                    fontSize: 12,
                                    fontWeight: FontWeight.w900,
                                  ),
                                ),
                              ),
                              const SizedBox(width: 4),
                              Text('+', style: GoogleFonts.inter(fontWeight: FontWeight.w700)),
                              const SizedBox(width: 4),
                              Container(
                                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                decoration: BoxDecoration(
                                  color: isDark ? Colors.white.withOpacity(0.06) : Colors.black.withOpacity(0.04),
                                  borderRadius: BorderRadius.circular(8),
                                ),
                                child: Text(
                                  'K',
                                  style: GoogleFonts.robotoMono(
                                    fontSize: 12,
                                    fontWeight: FontWeight.w900,
                                  ),
                                ),
                              ),
                              const SizedBox(width: 8),
                              Text(
                                'to search quickly (coming soon)',
                                style: GoogleFonts.inter(
                                  fontSize: 13,
                                  fontWeight: FontWeight.w650,
                                  color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
              ),
            ),
          ),
        ),
      ),
    );
  }
}
DART_EOF
          
          echo "âœ… Auth screen created"

      # ====================================
      # STEP 15: Create Main Shell Screen
      # ====================================
      - name: ðŸ“± Create Main Shell Screen
        run: |
          cd flutter_app
          
          cat > lib/screens/main_shell.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:provider/provider.dart';
import '../providers/auth_provider.dart';
import '../providers/app_provider.dart';
import '../config/theme.dart';
import 'home_screen.dart';
import 'work_queue_screen.dart';
import 'calendar_screen.dart';
import 'clients_screen.dart';
import 'ops_screen.dart';

class MainShell extends StatefulWidget {
  const MainShell({super.key});

  @override
  State<MainShell> createState() => _MainShellState();
}

class _MainShellState extends State<MainShell> {
  int _selectedIndex = 0;

  final List<_NavItem> _navItems = [
    _NavItem(icon: Icons.dashboard_rounded, label: 'Overview', key: 'home'),
    _NavItem(icon: Icons.list_alt_rounded, label: 'Work Queue', key: 'work'),
    _NavItem(icon: Icons.calendar_month_rounded, label: 'Timeline', key: 'calendar'),
    _NavItem(icon: Icons.people_rounded, label: 'Clients', key: 'clients', partnerOnly: true),
    _NavItem(icon: Icons.settings_rounded, label: 'Ops', key: 'ops', managerRequired: true),
  ];

  @override
  Widget build(BuildContext context) {
    final auth = context.watch<AuthProvider>();
    final app = context.watch<AppProvider>();
    final isDark = Theme.of(context).brightness == Brightness.dark;
    final isWide = MediaQuery.of(context).size.width > 900;

    // Filter nav items based on role
    final visibleNavItems = _navItems.where((item) {
      if (item.partnerOnly && !auth.isPartner) return false;
      if (item.managerRequired && !auth.isPartner && !auth.isManager) return false;
      return true;
    }).toList();

    // Clamp selected index
    if (_selectedIndex >= visibleNavItems.length) {
      _selectedIndex = 0;
    }

    Widget body = _buildBody(visibleNavItems[_selectedIndex].key);

    return Scaffold(
      appBar: _buildAppBar(context, auth, isDark),
      body: isWide
          ? Row(
              children: [
                NavigationRail(
                  selectedIndex: _selectedIndex,
                  onDestinationSelected: (index) {
                    setState(() => _selectedIndex = index);
                  },
                  labelType: NavigationRailLabelType.all,
                  destinations: visibleNavItems
                      .map((item) => NavigationRailDestination(
                            icon: Icon(item.icon),
                            label: Text(item.label),
                          ))
                      .toList(),
                ),
                const VerticalDivider(thickness: 1, width: 1),
                Expanded(child: body),
              ],
            )
          : body,
      bottomNavigationBar: isWide
          ? null
          : NavigationBar(
              selectedIndex: _selectedIndex,
              onDestinationSelected: (index) {
                setState(() => _selectedIndex = index);
              },
              destinations: visibleNavItems
                  .map((item) => NavigationDestination(
                        icon: Icon(item.icon),
                        label: item.label,
                      ))
                  .toList(),
            ),
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          // TODO: Quick task creation
          ScaffoldMessenger.of(context).showSnackBar(
            const SnackBar(content: Text('Quick task - coming soon!')),
          );
        },
        child: const Icon(Icons.add),
      ),
    );
  }

  PreferredSizeWidget _buildAppBar(BuildContext context, AuthProvider auth, bool isDark) {
    return AppBar(
      title: Row(
        children: [
          Container(
            width: 36,
            height: 36,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              gradient: const LinearGradient(
                colors: [AppTheme.primary, Color(0xFF5AA7FF)],
              ),
            ),
          ),
          const SizedBox(width: 12),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'ComplianceOS',
                style: GoogleFonts.inter(
                  fontSize: 16,
                  fontWeight: FontWeight.w900,
                ),
              ),
              Text(
                'Tasks Â· Calendar Â· Reminders',
                style: GoogleFonts.inter(
                  fontSize: 11,
                  fontWeight: FontWeight.w700,
                  color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                ),
              ),
            ],
          ),
        ],
      ),
      actions: [
        // Theme toggle
        IconButton(
          icon: Icon(isDark ? Icons.light_mode : Icons.dark_mode),
          onPressed: () {
            context.read<AppProvider>().toggleTheme();
          },
          tooltip: 'Toggle theme',
        ),
        // Role chip
        Container(
          margin: const EdgeInsets.symmetric(horizontal: 8),
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
          decoration: BoxDecoration(
            color: isDark ? Colors.white.withOpacity(0.06) : Colors.black.withOpacity(0.04),
            borderRadius: BorderRadius.circular(999),
            border: Border.all(
              color: isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.06),
            ),
          ),
          child: Text(
            '${auth.user?.role ?? 'USER'} Â· ${auth.user?.email ?? ''}',
            style: GoogleFonts.inter(
              fontSize: 12,
              fontWeight: FontWeight.w900,
            ),
          ),
        ),
        // Account
        IconButton(
          icon: const Icon(Icons.account_circle),
          onPressed: () {
            _showAccountDialog(context, auth);
          },
          tooltip: 'Account',
        ),
        const SizedBox(width: 8),
      ],
    );
  }

  Widget _buildBody(String key) {
    switch (key) {
      case 'home':
        return const HomeScreen();
      case 'work':
        return const WorkQueueScreen();
      case 'calendar':
        return const CalendarScreen();
      case 'clients':
        return const ClientsScreen();
      case 'ops':
        return const OpsScreen();
      default:
        return const HomeScreen();
    }
  }

  void _showAccountDialog(BuildContext context, AuthProvider auth) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Account'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('Email: ${auth.user?.email ?? 'N/A'}'),
            const SizedBox(height: 8),
            Text('Role: ${auth.user?.role ?? 'N/A'}'),
            const SizedBox(height: 8),
            Text('Display Name: ${auth.user?.displayName ?? 'N/A'}'),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('Close'),
          ),
          ElevatedButton(
            onPressed: () {
              Navigator.pop(context);
              auth.signOut();
            },
            style: ElevatedButton.styleFrom(
              backgroundColor: AppTheme.danger,
            ),
            child: const Text('Sign Out'),
          ),
        ],
      ),
    );
  }
}

class _NavItem {
  final IconData icon;
  final String label;
  final String key;
  final bool partnerOnly;
  final bool managerRequired;

  _NavItem({
    required this.icon,
    required this.label,
    required this.key,
    this.partnerOnly = false,
    this.managerRequired = false,
  });
}
DART_EOF
          
          echo "âœ… Main shell created"

      # ====================================
      # STEP 16: Create Home Screen
      # ====================================
      - name: ðŸ“± Create Home Screen
        run: |
          cd flutter_app
          
          cat > lib/screens/home_screen.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:provider/provider.dart';
import '../providers/auth_provider.dart';
import '../providers/app_provider.dart';
import '../models/task_model.dart';
import '../widgets/app_card.dart';
import '../widgets/status_pill.dart';
import '../config/theme.dart';
import '../utils/date_utils.dart';

class HomeScreen extends StatelessWidget {
  const HomeScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final auth = context.watch<AuthProvider>();
    final app = context.watch<AppProvider>();
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return StreamBuilder<List<TaskModel>>(
      stream: app.tasksStream(isPartnerOrManager: auth.canSeeAllTasks),
      builder: (context, snapshot) {
        final tasks = snapshot.data ?? [];
        final stats = _computeStats(tasks);

        return SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    'Dashboard',
                    style: GoogleFonts.inter(
                      fontSize: 24,
                      fontWeight: FontWeight.w900,
                    ),
                  ),
                  Row(
                    children: [
                      ElevatedButton.icon(
                        onPressed: () {
                          // TODO: Navigate to create task
                        },
                        icon: const Icon(Icons.add, size: 18),
                        label: const Text('New Task'),
                      ),
                    ],
                  ),
                ],
              ),
              const SizedBox(height: 8),
              Text(
                'A fast snapshot of today + due soon.',
                style: GoogleFonts.inter(
                  fontSize: 14,
                  fontWeight: FontWeight.w650,
                  color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                ),
              ),
              const SizedBox(height: 24),

              // KPI Grid
              GridView.count(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                crossAxisCount: MediaQuery.of(context).size.width > 800 ? 6 : 3,
                crossAxisSpacing: 12,
                mainAxisSpacing: 12,
                childAspectRatio: 1.5,
                children: [
                  _KpiCard(label: 'Starting Today', value: stats.startToday),
                  _KpiCard(label: 'Due Today', value: stats.dueToday),
                  _KpiCard(label: 'Due in 7 Days', value: stats.due7),
                  _KpiCard(label: 'Overdue', value: stats.overdue, isAlert: true),
                  _KpiCard(label: 'Approval Pending', value: stats.approval),
                  _KpiCard(label: 'Snoozed', value: stats.snoozed),
                ],
              ),
              const SizedBox(height: 24),

              // Focus Tasks
              AppCard(
                title: 'Focus Tasks',
                subtitle: 'Overdue, due today, and due soon tasks.',
                accentColor: AppTheme.viewAccents['home'],
                child: stats.focusTasks.isEmpty
                    ? _buildEmptyState(isDark)
                    : Column(
                        children: stats.focusTasks
                            .take(15)
                            .map((task) => _TaskRow(
                                  task: task,
                                  clientName: app.getClientName(task.clientId),
                                ))
                            .toList(),
                      ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildEmptyState(bool isDark) {
    return Container(
      padding: const EdgeInsets.all(18),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: (isDark ? Colors.white : Colors.black).withOpacity(0.08),
          style: BorderStyle.solid,
        ),
      ),
      child: Row(
        children: [
          Container(
            width: 48,
            height: 48,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(16),
              gradient: RadialGradient(
                colors: [
                  AppTheme.primary.withOpacity(0.35),
                  Colors.transparent,
                ],
              ),
            ),
          ),
          const SizedBox(width: 14),
          Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                'No urgent tasks',
                style: GoogleFonts.inter(
                  fontWeight: FontWeight.w900,
                ),
              ),
              const SizedBox(height: 6),
              Text(
                'You\'re clear for now. Use Work Queue for the full list.',
                style: GoogleFonts.inter(
                  fontSize: 13,
                  fontWeight: FontWeight.w700,
                  color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  _DashboardStats _computeStats(List<TaskModel> tasks) {
    final today = AppDateUtils.todayYmd();
    int startToday = 0, dueToday = 0, due7 = 0, overdue = 0, approval = 0, snoozed = 0;
    List<TaskModel> focusTasks = [];

    for (final task in tasks) {
      if (task.isSnoozedNow(today)) snoozed++;
      if (task.status == 'APPROVAL_PENDING') approval++;
      if (task.status != 'COMPLETED' && task.startDateYmd == today) startToday++;

      if (task.dueDateYmd == null || task.dueDateYmd!.isEmpty) continue;

      final dd = AppDateUtils.diffDays(today, task.dueDateYmd!);

      if (task.status != 'COMPLETED') {
        if (dd < 0) overdue++;
        if (dd == 0) dueToday++;
        if (dd >= 0 && dd <= 7) due7++;

        if (dd < 0 || dd == 0 || (dd >= 0 && dd <= 3)) {
          focusTasks.add(task);
        }
      }
    }

    focusTasks.sort((a, b) =>
        (a.dueDateYmd ?? '').compareTo(b.dueDateYmd ?? ''));

    return _DashboardStats(
      startToday: startToday,
      dueToday: dueToday,
      due7: due7,
      overdue: overdue,
      approval: approval,
      snoozed: snoozed,
      focusTasks: focusTasks,
    );
  }
}

class _DashboardStats {
  final int startToday, dueToday, due7, overdue, approval, snoozed;
  final List<TaskModel> focusTasks;

  _DashboardStats({
    required this.startToday,
    required this.dueToday,
    required this.due7,
    required this.overdue,
    required this.approval,
    required this.snoozed,
    required this.focusTasks,
  });
}

class _KpiCard extends StatelessWidget {
  final String label;
  final int value;
  final bool isAlert;

  const _KpiCard({
    required this.label,
    required this.value,
    this.isAlert = false,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: isDark
            ? Colors.white.withOpacity(0.05)
            : Colors.white.withOpacity(0.7),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(
          color: isAlert && value > 0
              ? AppTheme.danger.withOpacity(0.5)
              : (isDark ? Colors.white : Colors.black).withOpacity(0.06),
        ),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Text(
            label,
            style: GoogleFonts.inter(
              fontSize: 12,
              fontWeight: FontWeight.w900,
              color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
            ),
          ),
          const SizedBox(height: 4),
          ShaderMask(
            shaderCallback: (bounds) => const LinearGradient(
              colors: [AppTheme.primary, Color(0xFF5AA7FF), Color(0xFF64D2FF)],
            ).createShader(bounds),
            child: Text(
              value.toString(),
              style: GoogleFonts.inter(
                fontSize: 28,
                fontWeight: FontWeight.w900,
                color: Colors.white,
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class _TaskRow extends StatelessWidget {
  final TaskModel task;
  final String? clientName;

  const _TaskRow({required this.task, this.clientName});

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return InkWell(
      onTap: () {
        // TODO: Open task inspector
      },
      borderRadius: BorderRadius.circular(12),
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 8),
        decoration: BoxDecoration(
          border: Border(
            bottom: BorderSide(
              color: (isDark ? Colors.white : Colors.black).withOpacity(0.06),
            ),
          ),
        ),
        child: Row(
          children: [
            StatusPill.forTask(task),
            const SizedBox(width: 12),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    task.title,
                    style: GoogleFonts.inter(
                      fontWeight: FontWeight.w900,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: 4),
                  Text(
                    '${clientName ?? 'â€”'} â€¢ ${task.type ?? ''} â€¢ ${task.assignedToEmail ?? ''}',
                    style: GoogleFonts.inter(
                      fontSize: 12,
                      fontWeight: FontWeight.w650,
                      color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                ],
              ),
            ),
            const SizedBox(width: 12),
            Text(
              task.dueDateYmd != null
                  ? AppDateUtils.ymdToDmy(task.dueDateYmd!)
                  : '',
              style: GoogleFonts.inter(
                fontSize: 12,
                fontWeight: FontWeight.w700,
                color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
DART_EOF
          
          echo "âœ… Home screen created"

      # ====================================
      # STEP 17: Create Remaining Screens (Stubs)
      # ====================================
      - name: ðŸ“± Create Remaining Screens
        run: |
          cd flutter_app
          
          # Work Queue Screen
          cat > lib/screens/work_queue_screen.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:provider/provider.dart';
import '../providers/auth_provider.dart';
import '../providers/app_provider.dart';
import '../models/task_model.dart';
import '../widgets/app_card.dart';
import '../widgets/status_pill.dart';
import '../widgets/category_pill.dart';
import '../config/theme.dart';
import '../utils/date_utils.dart';

class WorkQueueScreen extends StatefulWidget {
  const WorkQueueScreen({super.key});

  @override
  State<WorkQueueScreen> createState() => _WorkQueueScreenState();
}

class _WorkQueueScreenState extends State<WorkQueueScreen> {
  String _searchQuery = '';
  String _statusFilter = '';
  String _categoryFilter = '';
  String _modeFilter = 'ACTIVE';
  final Set<String> _selectedTaskIds = {};

  @override
  Widget build(BuildContext context) {
    final auth = context.watch<AuthProvider>();
    final app = context.watch<AppProvider>();
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return StreamBuilder<List<TaskModel>>(
      stream: app.tasksStream(isPartnerOrManager: auth.canSeeAllTasks),
      builder: (context, snapshot) {
        final tasks = _filterTasks(snapshot.data ?? [], app);

        return SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Header
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    'Work Queue',
                    style: GoogleFonts.inter(
                      fontSize: 24,
                      fontWeight: FontWeight.w900,
                    ),
                  ),
                  Row(
                    children: [
                      Chip(label: Text('${tasks.length} shown')),
                      const SizedBox(width: 8),
                      ElevatedButton.icon(
                        onPressed: () {},
                        icon: const Icon(Icons.add, size: 18),
                        label: const Text('New Task'),
                      ),
                    ],
                  ),
                ],
              ),
              const SizedBox(height: 16),

              // Filters Card
              AppCard(
                title: 'Filters',
                subtitle: 'Filter tasks by status, category, and more.',
                accentColor: AppTheme.viewAccents['work'],
                child: Column(
                  children: [
                    // Search
                    TextField(
                      decoration: const InputDecoration(
                        hintText: 'Search task, client, assignee...',
                        prefixIcon: Icon(Icons.search),
                      ),
                      onChanged: (v) => setState(() => _searchQuery = v),
                    ),
                    const SizedBox(height: 12),
                    // Filter row
                    Wrap(
                      spacing: 12,
                      runSpacing: 12,
                      children: [
                        _buildDropdown(
                          'Mode',
                          _modeFilter,
                          ['ACTIVE', 'ALL', 'SNOOZED', 'APPROVAL', 'COMPLETED'],
                          (v) => setState(() => _modeFilter = v ?? 'ACTIVE'),
                        ),
                        _buildDropdown(
                          'Status',
                          _statusFilter,
                          ['', 'PENDING', 'IN_PROGRESS', 'CLIENT_PENDING', 'APPROVAL_PENDING', 'COMPLETED'],
                          (v) => setState(() => _statusFilter = v ?? ''),
                        ),
                        _buildDropdown(
                          'Category',
                          _categoryFilter,
                          ['', 'GST', 'TDS', 'INCOME_TAX', 'ROC', 'ACCOUNTING', 'AUDIT', 'OTHER'],
                          (v) => setState(() => _categoryFilter = v ?? ''),
                        ),
                        OutlinedButton(
                          onPressed: () {
                            setState(() {
                              _searchQuery = '';
                              _statusFilter = '';
                              _categoryFilter = '';
                              _modeFilter = 'ACTIVE';
                            });
                          },
                          child: const Text('Reset'),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 16),

              // Tasks Card
              AppCard(
                title: 'Tasks',
                subtitle: 'Click a row to open. Use checkboxes for bulk actions.',
                child: tasks.isEmpty
                    ? _buildEmptyState(isDark)
                    : Column(
                        children: [
                          // Select actions
                          if (_selectedTaskIds.isNotEmpty)
                            Container(
                              padding: const EdgeInsets.all(12),
                              margin: const EdgeInsets.only(bottom: 12),
                              decoration: BoxDecoration(
                                color: AppTheme.primary.withOpacity(0.1),
                                borderRadius: BorderRadius.circular(12),
                                border: Border.all(
                                  color: AppTheme.primary.withOpacity(0.3),
                                ),
                              ),
                              child: Row(
                                children: [
                                  Text(
                                    '${_selectedTaskIds.length} selected',
                                    style: GoogleFonts.inter(
                                      fontWeight: FontWeight.w900,
                                    ),
                                  ),
                                  const Spacer(),
                                  OutlinedButton(
                                    onPressed: () => setState(() => _selectedTaskIds.clear()),
                                    child: const Text('Clear'),
                                  ),
                                ],
                              ),
                            ),
                          // Task list
                          ...tasks.take(100).map((task) => _TaskListItem(
                                task: task,
                                clientName: app.getClientName(task.clientId),
                                isSelected: _selectedTaskIds.contains(task.id),
                                onSelect: (selected) {
                                  setState(() {
                                    if (selected) {
                                      _selectedTaskIds.add(task.id);
                                    } else {
                                      _selectedTaskIds.remove(task.id);
                                    }
                                  });
                                },
                              )),
                        ],
                      ),
              ),
            ],
          ),
        );
      },
    );
  }

  Widget _buildDropdown(String label, String value, List<String> items, ValueChanged<String?> onChanged) {
    return SizedBox(
      width: 160,
      child: DropdownButtonFormField<String>(
        value: value.isEmpty ? null : value,
        decoration: InputDecoration(
          labelText: label,
          contentPadding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        ),
        items: items.map((e) => DropdownMenuItem(
          value: e,
          child: Text(e.isEmpty ? 'All' : e),
        )).toList(),
        onChanged: onChanged,
      ),
    );
  }

  Widget _buildEmptyState(bool isDark) {
    return Container(
      padding: const EdgeInsets.all(24),
      child: Column(
        children: [
          Icon(
            Icons.inbox_outlined,
            size: 64,
            color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
          ),
          const SizedBox(height: 16),
          Text(
            'No tasks found',
            style: GoogleFonts.inter(
              fontWeight: FontWeight.w900,
              fontSize: 16,
            ),
          ),
          const SizedBox(height: 8),
          Text(
            'Try changing filters or create a new task.',
            style: GoogleFonts.inter(
              color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
            ),
          ),
        ],
      ),
    );
  }

  List<TaskModel> _filterTasks(List<TaskModel> tasks, AppProvider app) {
    final today = AppDateUtils.todayYmd();
    final query = _searchQuery.toLowerCase();

    return tasks.where((task) {
      // Mode filter
      final isSnoozed = task.isSnoozedNow(today);
      if (_modeFilter == 'ACTIVE') {
        if (task.status == 'COMPLETED') return false;
        if (isSnoozed) return false;
      }
      if (_modeFilter == 'SNOOZED' && !isSnoozed) return false;
      if (_modeFilter == 'APPROVAL' && task.status != 'APPROVAL_PENDING') return false;
      if (_modeFilter == 'COMPLETED' && task.status != 'COMPLETED') return false;

      // Status filter
      if (_statusFilter.isNotEmpty && task.status != _statusFilter) return false;

      // Category filter
      if (_categoryFilter.isNotEmpty && task.normalizedCategory != _categoryFilter) return false;

      // Search filter
      if (query.isNotEmpty) {
        final clientName = app.getClientName(task.clientId) ?? '';
        final haystack = '${task.title} ${task.type ?? ''} $clientName ${task.assignedToEmail ?? ''}'.toLowerCase();
        if (!haystack.contains(query)) return false;
      }

      return true;
    }).toList()
      ..sort((a, b) => (a.dueDateYmd ?? '').compareTo(b.dueDateYmd ?? ''));
  }
}

class _TaskListItem extends StatelessWidget {
  final TaskModel task;
  final String? clientName;
  final bool isSelected;
  final ValueChanged<bool> onSelect;

  const _TaskListItem({
    required this.task,
    this.clientName,
    required this.isSelected,
    required this.onSelect,
  });

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return InkWell(
      onTap: () {
        // TODO: Open task inspector
      },
      child: Container(
        padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 4),
        decoration: BoxDecoration(
          border: Border(
            bottom: BorderSide(
              color: (isDark ? Colors.white : Colors.black).withOpacity(0.06),
            ),
          ),
        ),
        child: Row(
          children: [
            Checkbox(
              value: isSelected,
              onChanged: (v) => onSelect(v ?? false),
            ),
            const SizedBox(width: 8),
            StatusPill.forTask(task),
            const SizedBox(width: 12),
            Expanded(
              flex: 2,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    task.title,
                    style: GoogleFonts.inter(fontWeight: FontWeight.w900),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  const SizedBox(height: 4),
                  Text(
                    clientName ?? 'â€”',
                    style: GoogleFonts.inter(
                      fontSize: 12,
                      color: isDark ? AppTheme.darkMuted : AppTheme.lightMuted,
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(width: 8),
            CategoryPill(category: task.category ?? 'OTHER'),
            const SizedBox(width: 8),
            SizedBox(
              width: 80,
              child: Text(
                task.dueDateYmd != null ? AppDateUtils.ymdToDmy(task.dueDateYmd!) : '',
                style: GoogleFonts.inter(fontSize: 12),
              ),
            ),
            SizedBox(
              width: 100,
              child: Text(
                task.status ?? '',
                style: GoogleFonts.inter(fontSize: 12),
              ),
            ),
            SizedBox(
              width: 150,
              child: Text(
                task.assignedToEmail ?? '',
                style: GoogleFonts.inter(fontSize: 12),
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
              ),
            ),
          ],
        ),
      ),
    );
  }
}
DART_EOF

          # Calendar Screen (Stub)
          cat > lib/screens/calendar_screen.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import '../widgets/app_card.dart';
import '../config/theme.dart';

class CalendarScreen extends StatelessWidget {
  const CalendarScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Timeline',
            style: GoogleFonts.inter(
              fontSize: 24,
              fontWeight: FontWeight.w900,
            ),
          ),
          const SizedBox(height: 24),
          AppCard(
            title: 'Calendar View',
            subtitle: 'Month, Week, Day, and Agenda views.',
            accentColor: AppTheme.viewAccents['calendar'],
            child: const SizedBox(
              height: 400,
              child: Center(
                child: Text('Calendar coming soon...'),
              ),
            ),
          ),
        ],
      ),
    );
  }
}
DART_EOF

          # Clients Screen (Stub)
          cat > lib/screens/clients_screen.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:provider/provider.dart';
import '../providers/auth_provider.dart';
import '../providers/app_provider.dart';
import '../widgets/app_card.dart';
import '../config/theme.dart';

class ClientsScreen extends StatelessWidget {
  const ClientsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final auth = context.watch<AuthProvider>();
    final app = context.watch<AppProvider>();

    if (!auth.isPartner) {
      return Center(
        child: AppCard(
          title: 'Access Restricted',
          subtitle: 'Clients area is available to Partners only.',
          child: Text(
            'Your role: ${auth.user?.role ?? 'Unknown'}',
            style: GoogleFonts.inter(),
          ),
        ),
      );
    }

    return StreamBuilder(
      stream: app.clientsStream(),
      builder: (context, snapshot) {
        final clients = snapshot.data ?? [];

        return SingleChildScrollView(
          padding: const EdgeInsets.all(16),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Row(
                mainAxisAlignment: MainAxisAlignment.spaceBetween,
                children: [
                  Text(
                    'Clients',
                    style: GoogleFonts.inter(
                      fontSize: 24,
                      fontWeight: FontWeight.w900,
                    ),
                  ),
                  Chip(label: Text('${clients.length} clients')),
                ],
              ),
              const SizedBox(height: 24),
              AppCard(
                title: 'Client Management',
                subtitle: 'Create, edit, and export client data.',
                accentColor: AppTheme.viewAccents['clients'],
                child: const SizedBox(
                  height: 200,
                  child: Center(
                    child: Text('Client management coming soon...'),
                  ),
                ),
              ),
            ],
          ),
        );
      },
    );
  }
}
DART_EOF

          # Ops Screen (Stub)
          cat > lib/screens/ops_screen.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:provider/provider.dart';
import '../providers/auth_provider.dart';
import '../widgets/app_card.dart';
import '../config/theme.dart';

class OpsScreen extends StatelessWidget {
  const OpsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final auth = context.watch<AuthProvider>();

    if (!auth.isPartner && !auth.isManager) {
      return Center(
        child: AppCard(
          title: 'Access Restricted',
          subtitle: 'Ops is available to Partners and Managers only.',
          child: Text(
            'Your role: ${auth.user?.role ?? 'Unknown'}',
            style: GoogleFonts.inter(),
          ),
        ),
      );
    }

    return SingleChildScrollView(
      padding: const EdgeInsets.all(16),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Ops & Reports',
            style: GoogleFonts.inter(
              fontSize: 24,
              fontWeight: FontWeight.w900,
            ),
          ),
          const SizedBox(height: 24),
          AppCard(
            title: 'Operations',
            subtitle: 'Imports, exports, reports, and admin tools.',
            accentColor: AppTheme.viewAccents['ops'],
            child: const SizedBox(
              height: 200,
              child: Center(
                child: Text('Ops coming soon...'),
              ),
            ),
          ),
        ],
      ),
    );
  }
}
DART_EOF
          
          echo "âœ… Remaining screens created"

      # ====================================
      # STEP 18: Create Main Entry Point
      # ====================================
      - name: ðŸš€ Create Main Entry Point
        run: |
          cd flutter_app
          
          cat > lib/main.dart << 'DART_EOF'
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:provider/provider.dart';
import 'config/theme.dart';
import 'config/constants.dart';
import 'providers/auth_provider.dart';
import 'providers/app_provider.dart';
import 'screens/auth_screen.dart';
import 'screens/main_shell.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize Firebase
  await Firebase.initializeApp(
    options: const FirebaseOptions(
      apiKey: AppConstants.firebaseApiKey,
      authDomain: AppConstants.firebaseAuthDomain,
      projectId: AppConstants.firebaseProjectId,
      storageBucket: AppConstants.firebaseStorageBucket,
      messagingSenderId: AppConstants.firebaseMessagingSenderId,
      appId: AppConstants.firebaseAppId,
    ),
  );
  
  // Set system UI overlay style
  SystemChrome.setSystemUIOverlayStyle(
    const SystemUiOverlayStyle(
      statusBarColor: Colors.transparent,
    ),
  );
  
  runApp(const ComplianceOSApp());
}

class ComplianceOSApp extends StatelessWidget {
  const ComplianceOSApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => AuthProvider()),
        ChangeNotifierProvider(create: (_) => AppProvider()),
      ],
      child: Consumer<AppProvider>(
        builder: (context, appProvider, _) {
          return MaterialApp(
            title: 'ComplianceOS',
            debugShowCheckedModeBanner: false,
            theme: AppTheme.lightTheme,
            darkTheme: AppTheme.darkTheme,
            themeMode: appProvider.themeMode,
            home: Consumer<AuthProvider>(
              builder: (context, authProvider, _) {
                if (authProvider.isAuthenticated) {
                  return const MainShell();
                }
                return const AuthScreen();
              },
            ),
          );
        },
      ),
    );
  }
}
DART_EOF
          
          echo "âœ… Main entry point created"

      # ====================================
      # STEP 19: Configure Android
      # ====================================
      - name: âš™ï¸ Configure Android Build
        run: |
          cd flutter_app
          
          # Update android/app/build.gradle
          cat > android/app/build.gradle << 'GRADLE_EOF'
plugins {
    id "com.android.application"
    id "kotlin-android"
    id "dev.flutter.flutter-gradle-plugin"
}

def localProperties = new Properties()
def localPropertiesFile = rootProject.file('local.properties')
if (localPropertiesFile.exists()) {
    localPropertiesFile.withReader('UTF-8') { reader ->
        localProperties.load(reader)
    }
}

def flutterVersionCode = localProperties.getProperty('flutter.versionCode')
if (flutterVersionCode == null) {
    flutterVersionCode = '1'
}

def flutterVersionName = localProperties.getProperty('flutter.versionName')
if (flutterVersionName == null) {
    flutterVersionName = '1.0'
}

android {
    namespace "com.complianceos.compliance_os"
    compileSdk 34
    ndkVersion flutter.ndkVersion

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = '1.8'
    }

    sourceSets {
        main.java.srcDirs += 'src/main/kotlin'
    }

    defaultConfig {
        applicationId "com.complianceos.compliance_os"
        minSdkVersion 23
        targetSdkVersion 34
        versionCode flutterVersionCode.toInteger()
        versionName flutterVersionName
        multiDexEnabled true
    }

    buildTypes {
        release {
            signingConfig signingConfigs.debug
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
}

flutter {
    source '../..'
}

dependencies {
    implementation 'androidx.multidex:multidex:2.0.1'
}
GRADLE_EOF

          # Update AndroidManifest.xml
          cat > android/app/src/main/AndroidManifest.xml << 'MANIFEST_EOF'
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    
    <uses-permission android:name="android.permission.INTERNET"/>
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    
    <application
        android:label="ComplianceOS"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher"
        android:usesCleartextTraffic="true">
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTop"
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            
            <meta-data
              android:name="io.flutter.embedding.android.NormalTheme"
              android:resource="@style/NormalTheme"
              />
            
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
        
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>
</manifest>
MANIFEST_EOF

          # Create proguard rules
          cat > android/app/proguard-rules.pro << 'PROGUARD_EOF'
-keep class io.flutter.** { *; }
-keep class com.google.firebase.** { *; }
-dontwarn com.google.firebase.**
PROGUARD_EOF
          
          echo "âœ… Android configured"

      # ====================================
      # STEP 20: Install Dependencies & Build
      # ====================================
      - name: ðŸ“¦ Install Dependencies
        run: |
          cd flutter_app
          flutter pub get
          echo "âœ… Dependencies installed"

      - name: ðŸ”¨ Build APK
        run: |
          cd flutter_app
          flutter build apk --release
          
          cp build/app/outputs/flutter-apk/app-release.apk ../ComplianceOS-release.apk
          
          echo "âœ… APK built"
          ls -lh ../ComplianceOS-release.apk

      # ====================================
      # STEP 21: Commit Changes (No PAT needed!)
      # ====================================
      - name: ðŸ“¤ Commit Flutter Project
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add files
          git add flutter_app/ || true
          git add ComplianceOS-release.apk || true
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸš€ Build: Native Flutter app + APK $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi
          
          echo "âœ… Changes committed"

      # ====================================
      # STEP 22: Upload Artifact
      # ====================================
      - name: ðŸ“¦ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ComplianceOS-APK
          path: ComplianceOS-release.apk
          retention-days: 30

      # ====================================
      # STEP 23: Build Summary
      # ====================================
      - name: ðŸ“Š Build Summary
        run: |
          echo "## ðŸŽ‰ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Flutter Version:** $(flutter --version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **APK Size:** $(du -h ComplianceOS-release.apk | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Features" >> $GITHUB_STEP_SUMMARY
          echo "- Native Flutter UI (no WebView)" >> $GITHUB_STEP_SUMMARY
          echo "- Firebase Authentication" >> $GITHUB_STEP_SUMMARY
          echo "- Firestore real-time sync" >> $GITHUB_STEP_SUMMARY
          echo "- Backend API integration" >> $GITHUB_STEP_SUMMARY
          echo "- Material Design 3" >> $GITHUB_STEP_SUMMARY
          echo "- Light/Dark theme" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ **Download:** Check Artifacts section" >> $GITHUB_STEP_SUMMARY
