name: Build Native Flutter APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  FLUTTER_VERSION: '3.19.0'
  JAVA_VERSION: '17'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: üê¶ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: üîç Verify Setup
        run: |
          python --version
          flutter --version
          flutter doctor -v

      - name: üèóÔ∏è Create Flutter Project
        run: |
          rm -rf flutter_app
          flutter create --org com.complianceos --project-name compliance_os flutter_app

      - name: üìÅ Create Directory Structure
        run: |
          mkdir -p flutter_app/lib/config
          mkdir -p flutter_app/lib/models
          mkdir -p flutter_app/lib/services
          mkdir -p flutter_app/lib/providers
          mkdir -p flutter_app/lib/screens
          mkdir -p flutter_app/lib/widgets
          mkdir -p flutter_app/assets/images
          touch flutter_app/assets/images/.gitkeep

      - name: üì¶ Create All Flutter Files
        run: |
          python << 'PYTHON_SCRIPT'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          # ============================================
          # pubspec.yaml
          # ============================================
          write_file('flutter_app/pubspec.yaml', '''
          name: compliance_os
          description: ComplianceOS - Premium Task Management
          publish_to: 'none'
          version: 1.0.0+1

          environment:
            sdk: '>=3.0.0 <4.0.0'

          dependencies:
            flutter:
              sdk: flutter
            firebase_core: ^2.27.0
            firebase_auth: ^4.17.8
            cloud_firestore: ^4.15.8
            http: ^1.2.0
            provider: ^6.1.2
            shared_preferences: ^2.2.2
            flutter_secure_storage: ^9.0.0
            cupertino_icons: ^1.0.6
            google_fonts: ^6.1.0
            shimmer: ^3.0.0
            intl: ^0.19.0
            flutter_animate: ^4.5.0
            cached_network_image: ^3.3.1
            path_provider: ^2.1.2
            url_launcher: ^6.2.5

          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^3.0.0

          flutter:
            uses-material-design: true
            assets:
              - assets/images/
          ''')

          # ============================================
          # lib/config/constants.dart
          # ============================================
          write_file('flutter_app/lib/config/constants.dart', '''
          class AppConstants {
            static const String backendBaseUrl = "https://lease-moore-others-montreal.trycloudflare.com/.netlify/functions";
            static const String timezone = "Asia/Kolkata";
            
            static const String firebaseApiKey = "AIzaSyCnWS-V96J6YDBVYKOeL5p8aa45GPTdSEg";
            static const String firebaseAuthDomain = "compliance-management-484405.firebaseapp.com";
            static const String firebaseProjectId = "compliance-management-484405";
            static const String firebaseStorageBucket = "compliance-management-484405.firebasestorage.app";
            static const String firebaseMessagingSenderId = "4348274796";
            static const String firebaseAppId = "1:4348274796:web:a9e1720c2ae223035bd049";
            
            static const String rolePartner = 'PARTNER';
            static const String roleManager = 'MANAGER';
            static const String roleAssociate = 'ASSOCIATE';
            
            static const List<String> taskStatuses = [
              'PENDING', 'IN_PROGRESS', 'CLIENT_PENDING', 'APPROVAL_PENDING', 'COMPLETED'
            ];
            
            static const List<String> categories = [
              'GST', 'TDS', 'INCOME_TAX', 'ROC', 'ACCOUNTING', 'AUDIT', 'OTHER'
            ];
            
            static const List<String> priorities = ['HIGH', 'MEDIUM', 'LOW'];
          }
          ''')

          # ============================================
          # lib/config/theme.dart
          # ============================================
          write_file('flutter_app/lib/config/theme.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';

          class AppTheme {
            // Premium Color Palette
            static const Color primary = Color(0xFF0A84FF);
            static const Color primaryDark = Color(0xFF0066CC);
            static const Color accent = Color(0xFF5AC8FA);
            static const Color success = Color(0xFF34C759);
            static const Color warning = Color(0xFFFFCC00);
            static const Color danger = Color(0xFFFF3B30);
            static const Color purple = Color(0xFFAF52DE);
            static const Color pink = Color(0xFFFF2D55);
            static const Color teal = Color(0xFF5AC8FA);
            static const Color orange = Color(0xFFFF9500);
            
            static const LinearGradient primaryGradient = LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [Color(0xFF0A84FF), Color(0xFF5AC8FA), Color(0xFF64D2FF)],
            );

            static ThemeData lightTheme = ThemeData(
              useMaterial3: true,
              brightness: Brightness.light,
              primaryColor: primary,
              scaffoldBackgroundColor: const Color(0xFFF2F2F7),
              colorScheme: ColorScheme.fromSeed(
                seedColor: primary,
                brightness: Brightness.light,
                surface: Colors.white,
              ),
              textTheme: GoogleFonts.interTextTheme().copyWith(
                displayLarge: GoogleFonts.inter(fontWeight: FontWeight.w900, letterSpacing: -1.5),
                headlineLarge: GoogleFonts.inter(fontWeight: FontWeight.w800),
                titleLarge: GoogleFonts.inter(fontWeight: FontWeight.w700),
                bodyLarge: GoogleFonts.inter(fontWeight: FontWeight.w500),
                labelLarge: GoogleFonts.inter(fontWeight: FontWeight.w700),
              ),
              appBarTheme: AppBarTheme(
                elevation: 0,
                scrolledUnderElevation: 0,
                backgroundColor: Colors.white.withOpacity(0.8),
                surfaceTintColor: Colors.transparent,
                titleTextStyle: GoogleFonts.inter(
                  fontSize: 17,
                  fontWeight: FontWeight.w700,
                  color: Colors.black,
                ),
              ),
              cardTheme: CardTheme(
                elevation: 0,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                color: Colors.white,
              ),
              elevatedButtonTheme: ElevatedButtonThemeData(
                style: ElevatedButton.styleFrom(
                  elevation: 0,
                  backgroundColor: primary,
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  textStyle: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 15),
                ),
              ),
              outlinedButtonTheme: OutlinedButtonThemeData(
                style: OutlinedButton.styleFrom(
                  foregroundColor: primary,
                  side: BorderSide(color: primary.withOpacity(0.3)),
                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  textStyle: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 15),
                ),
              ),
              inputDecorationTheme: InputDecorationTheme(
                filled: true,
                fillColor: const Color(0xFFF2F2F7),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(14),
                  borderSide: BorderSide.none,
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(14),
                  borderSide: BorderSide.none,
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(14),
                  borderSide: const BorderSide(color: primary, width: 2),
                ),
                contentPadding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
                hintStyle: GoogleFonts.inter(color: const Color(0xFF8E8E93), fontWeight: FontWeight.w500),
              ),
              chipTheme: ChipThemeData(
                backgroundColor: const Color(0xFFF2F2F7),
                labelStyle: GoogleFonts.inter(fontWeight: FontWeight.w600, fontSize: 13),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                side: BorderSide.none,
                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              ),
              bottomNavigationBarTheme: BottomNavigationBarThemeData(
                backgroundColor: Colors.white.withOpacity(0.9),
                selectedItemColor: primary,
                unselectedItemColor: const Color(0xFF8E8E93),
                type: BottomNavigationBarType.fixed,
                elevation: 0,
                selectedLabelStyle: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 11),
                unselectedLabelStyle: GoogleFonts.inter(fontWeight: FontWeight.w600, fontSize: 11),
              ),
              floatingActionButtonTheme: FloatingActionButtonThemeData(
                backgroundColor: primary,
                foregroundColor: Colors.white,
                elevation: 4,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(18)),
              ),
              snackBarTheme: SnackBarThemeData(
                backgroundColor: const Color(0xFF1C1C1E),
                contentTextStyle: GoogleFonts.inter(color: Colors.white, fontWeight: FontWeight.w600),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                behavior: SnackBarBehavior.floating,
              ),
              dividerTheme: const DividerThemeData(color: Color(0xFFE5E5EA), thickness: 0.5),
            );

            static ThemeData darkTheme = ThemeData(
              useMaterial3: true,
              brightness: Brightness.dark,
              primaryColor: primary,
              scaffoldBackgroundColor: const Color(0xFF000000),
              colorScheme: ColorScheme.fromSeed(
                seedColor: primary,
                brightness: Brightness.dark,
                surface: const Color(0xFF1C1C1E),
              ),
              textTheme: GoogleFonts.interTextTheme(ThemeData.dark().textTheme).copyWith(
                displayLarge: GoogleFonts.inter(fontWeight: FontWeight.w900, letterSpacing: -1.5, color: Colors.white),
                headlineLarge: GoogleFonts.inter(fontWeight: FontWeight.w800, color: Colors.white),
                titleLarge: GoogleFonts.inter(fontWeight: FontWeight.w700, color: Colors.white),
                bodyLarge: GoogleFonts.inter(fontWeight: FontWeight.w500, color: Colors.white),
                labelLarge: GoogleFonts.inter(fontWeight: FontWeight.w700, color: Colors.white),
              ),
              appBarTheme: AppBarTheme(
                elevation: 0,
                scrolledUnderElevation: 0,
                backgroundColor: const Color(0xFF1C1C1E).withOpacity(0.8),
                surfaceTintColor: Colors.transparent,
                titleTextStyle: GoogleFonts.inter(
                  fontSize: 17,
                  fontWeight: FontWeight.w700,
                  color: Colors.white,
                ),
              ),
              cardTheme: CardTheme(
                elevation: 0,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                color: const Color(0xFF1C1C1E),
              ),
              elevatedButtonTheme: ElevatedButtonThemeData(
                style: ElevatedButton.styleFrom(
                  elevation: 0,
                  backgroundColor: primary,
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  textStyle: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 15),
                ),
              ),
              outlinedButtonTheme: OutlinedButtonThemeData(
                style: OutlinedButton.styleFrom(
                  foregroundColor: primary,
                  side: BorderSide(color: primary.withOpacity(0.3)),
                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  textStyle: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 15),
                ),
              ),
              inputDecorationTheme: InputDecorationTheme(
                filled: true,
                fillColor: const Color(0xFF2C2C2E),
                border: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(14),
                  borderSide: BorderSide.none,
                ),
                enabledBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(14),
                  borderSide: BorderSide.none,
                ),
                focusedBorder: OutlineInputBorder(
                  borderRadius: BorderRadius.circular(14),
                  borderSide: const BorderSide(color: primary, width: 2),
                ),
                contentPadding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
                hintStyle: GoogleFonts.inter(color: const Color(0xFF8E8E93), fontWeight: FontWeight.w500),
              ),
              chipTheme: ChipThemeData(
                backgroundColor: const Color(0xFF2C2C2E),
                labelStyle: GoogleFonts.inter(fontWeight: FontWeight.w600, fontSize: 13, color: Colors.white),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                side: BorderSide.none,
                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              ),
              bottomNavigationBarTheme: BottomNavigationBarThemeData(
                backgroundColor: const Color(0xFF1C1C1E).withOpacity(0.9),
                selectedItemColor: primary,
                unselectedItemColor: const Color(0xFF8E8E93),
                type: BottomNavigationBarType.fixed,
                elevation: 0,
                selectedLabelStyle: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 11),
                unselectedLabelStyle: GoogleFonts.inter(fontWeight: FontWeight.w600, fontSize: 11),
              ),
              floatingActionButtonTheme: FloatingActionButtonThemeData(
                backgroundColor: primary,
                foregroundColor: Colors.white,
                elevation: 4,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(18)),
              ),
              snackBarTheme: SnackBarThemeData(
                backgroundColor: const Color(0xFF2C2C2E),
                contentTextStyle: GoogleFonts.inter(color: Colors.white, fontWeight: FontWeight.w600),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                behavior: SnackBarBehavior.floating,
              ),
              dividerTheme: const DividerThemeData(color: Color(0xFF38383A), thickness: 0.5),
            );

            static Map<String, Color> categoryColors = {
              'GST': const Color(0xFF34C759),
              'TDS': const Color(0xFF007AFF),
              'INCOME_TAX': const Color(0xFFAF52DE),
              'ROC': const Color(0xFFFF9500),
              'ACCOUNTING': const Color(0xFF5AC8FA),
              'AUDIT': const Color(0xFFFF3B30),
              'OTHER': const Color(0xFF8E8E93),
            };

            static Map<String, Color> priorityColors = {
              'HIGH': const Color(0xFFFF3B30),
              'MEDIUM': const Color(0xFFFF9500),
              'LOW': const Color(0xFF34C759),
            };
          }
          ''')

          # ============================================
          # lib/models/user_model.dart
          # ============================================
          write_file('flutter_app/lib/models/user_model.dart', '''
          class UserModel {
            final String uid;
            final String email;
            final String displayName;
            final String role;
            final bool active;
            final String? managerEmail;

            UserModel({
              required this.uid,
              required this.email,
              required this.displayName,
              required this.role,
              this.active = true,
              this.managerEmail,
            });

            bool get isPartner => role.toUpperCase() == 'PARTNER';
            bool get isManager => role.toUpperCase() == 'MANAGER';
            bool get isAssociate => role.toUpperCase() == 'ASSOCIATE';
            bool get canSeeAllTasks => isPartner || isManager;
            bool get canEditDetails => isPartner || isManager;

            factory UserModel.fromJson(Map<String, dynamic> json) {
              String normalizedRole = (json['role'] ?? 'ASSOCIATE').toString().toUpperCase().trim();
              if (normalizedRole.isEmpty || normalizedRole == 'WORKER') {
                normalizedRole = 'ASSOCIATE';
              }
              return UserModel(
                uid: json['uid'] ?? '',
                email: json['email'] ?? '',
                displayName: json['displayName'] ?? '',
                role: normalizedRole,
                active: json['active'] ?? true,
                managerEmail: json['managerEmail'],
              );
            }
          }
          ''')

          # ============================================
          # lib/models/task_model.dart
          # ============================================
          write_file('flutter_app/lib/models/task_model.dart', '''
          class TaskModel {
            final String id;
            final String? clientId;
            final String? clientName;
            final String title;
            final String? type;
            final String? category;
            final String? priority;
            final String? status;
            final String? statusNote;
            final String? startDateYmd;
            final String? dueDateYmd;
            final String? snoozedUntilYmd;
            final String? assignedToEmail;
            final String? assignedToUid;
            final String? seriesId;
            final bool clientStartMailSent;
            final String? calendarHtmlLink;

            TaskModel({
              required this.id,
              this.clientId,
              this.clientName,
              required this.title,
              this.type,
              this.category,
              this.priority,
              this.status,
              this.statusNote,
              this.startDateYmd,
              this.dueDateYmd,
              this.snoozedUntilYmd,
              this.assignedToEmail,
              this.assignedToUid,
              this.seriesId,
              this.clientStartMailSent = false,
              this.calendarHtmlLink,
            });

            bool get isCompleted => status == 'COMPLETED';

            String get normalizedCategory {
              final u = (category ?? '').toUpperCase().replaceAll(' ', '_');
              if (u == 'INCOME_TAX' || u == 'INCOME_TAX_RETURN') return 'INCOME_TAX';
              if (['GST', 'TDS', 'ROC', 'ACCOUNTING', 'AUDIT'].contains(u)) return u;
              return 'OTHER';
            }

            factory TaskModel.fromJson(Map<String, dynamic> json, String id) {
              return TaskModel(
                id: id,
                clientId: json['clientId'],
                clientName: json['clientName'],
                title: json['title'] ?? '',
                type: json['type'],
                category: json['category'],
                priority: json['priority'] ?? 'MEDIUM',
                status: json['status'] ?? 'PENDING',
                statusNote: json['statusNote'],
                startDateYmd: json['startDateYmd'],
                dueDateYmd: json['dueDateYmd'],
                snoozedUntilYmd: json['snoozedUntilYmd'],
                assignedToEmail: json['assignedToEmail'],
                assignedToUid: json['assignedToUid'],
                seriesId: json['seriesId'],
                clientStartMailSent: json['clientStartMailSent'] ?? false,
                calendarHtmlLink: json['calendarHtmlLink'],
              );
            }
          }
          ''')

          # ============================================
          # lib/models/client_model.dart
          # ============================================
          write_file('flutter_app/lib/models/client_model.dart', '''
          class ClientModel {
            final String id;
            final String name;
            final String? pan;
            final String? gstin;
            final String? primaryEmail;

            ClientModel({
              required this.id,
              required this.name,
              this.pan,
              this.gstin,
              this.primaryEmail,
            });

            factory ClientModel.fromJson(Map<String, dynamic> json, String id) {
              return ClientModel(
                id: id,
                name: json['name'] ?? '',
                pan: json['pan'],
                gstin: json['gstin'],
                primaryEmail: json['primaryEmail'],
              );
            }
          }
          ''')

          # ============================================
          # lib/utils/date_utils.dart
          # ============================================
          write_file('flutter_app/lib/utils/date_utils.dart', '''
          import 'package:intl/intl.dart';

          class AppDateUtils {
            static String todayYmd() {
              return DateFormat('yyyy-MM-dd').format(DateTime.now());
            }

            static String ymdToDmy(String? ymd) {
              if (ymd == null || ymd.isEmpty) return '';
              try {
                final date = DateTime.parse(ymd);
                return DateFormat('dd-MM-yyyy').format(date);
              } catch (_) {
                return '';
              }
            }

            static String dmyToYmd(String dmy) {
              final pattern = RegExp(r'^(\\d{2})-(\\d{2})-(\\d{4})$');
              final match = pattern.firstMatch(dmy.trim());
              if (match == null) throw FormatException('Invalid date');
              return '\${match.group(3)}-\${match.group(2)}-\${match.group(1)}';
            }

            static int diffDays(String fromYmd, String toYmd) {
              try {
                final from = DateTime.parse(fromYmd);
                final to = DateTime.parse(toYmd);
                return to.difference(from).inDays;
              } catch (_) {
                return 0;
              }
            }

            static String formatDateTime(DateTime dt) {
              return DateFormat('dd MMM yyyy, HH:mm').format(dt);
            }
          }
          ''')

          # ============================================
          # lib/services/api_service.dart
          # ============================================
          write_file('flutter_app/lib/services/api_service.dart', '''
          import 'dart:convert';
          import 'package:http/http.dart' as http;
          import 'package:firebase_auth/firebase_auth.dart';
          import '../config/constants.dart';

          class ApiResponse {
            final bool ok;
            final dynamic data;
            final String? error;
            final int statusCode;

            ApiResponse({required this.ok, this.data, this.error, required this.statusCode});
          }

          class ApiService {
            static final ApiService _instance = ApiService._internal();
            factory ApiService() => _instance;
            ApiService._internal();

            final String _baseUrl = AppConstants.backendBaseUrl;

            Future<String?> _getToken() async {
              final user = FirebaseAuth.instance.currentUser;
              if (user == null) return null;
              return await user.getIdToken();
            }

            Future<ApiResponse> post(String endpoint, Map<String, dynamic> body) async {
              try {
                final token = await _getToken();
                if (token == null) {
                  return ApiResponse(ok: false, error: 'Not signed in', statusCode: 401);
                }

                final response = await http.post(
                  Uri.parse('\$_baseUrl\$endpoint'),
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer \$token',
                  },
                  body: jsonEncode(body),
                );

                dynamic data;
                try {
                  data = jsonDecode(response.body);
                } catch (_) {
                  data = {'raw': response.body};
                }

                final bool isOk = data is Map && data['ok'] == true || response.statusCode == 200;
                return ApiResponse(
                  ok: isOk,
                  data: data,
                  error: data is Map ? data['error'] : null,
                  statusCode: response.statusCode,
                );
              } catch (e) {
                return ApiResponse(ok: false, error: e.toString(), statusCode: 0);
              }
            }

            Future<ApiResponse> initSelf({String? displayName}) async {
              return post('/users_initself', {'displayName': displayName ?? ''});
            }

            Future<ApiResponse> updateTaskStatus({
              required String taskId,
              required String newStatus,
              String? statusNote,
            }) async {
              return post('/tasks_updatestatus', {
                'taskId': taskId,
                'newStatus': newStatus,
                'statusNote': statusNote,
              });
            }

            Future<ApiResponse> createTask(Map<String, dynamic> taskData) async {
              return post('/tasks_createone', taskData);
            }

            Future<ApiResponse> bulkUpdate({
              required List<String> taskIds,
              required String op,
              Map<String, dynamic>? payload,
            }) async {
              return post('/tasks_bulkUpdate', {
                'taskIds': taskIds,
                'op': op,
                ...?payload,
              });
            }
          }
          ''')

          # ============================================
          # lib/providers/auth_provider.dart
          # ============================================
          write_file('flutter_app/lib/providers/auth_provider.dart', '''
          import 'package:flutter/material.dart';
          import 'package:firebase_auth/firebase_auth.dart';
          import 'package:cloud_firestore/cloud_firestore.dart';
          import '../models/user_model.dart';
          import '../services/api_service.dart';

          class AuthProvider extends ChangeNotifier {
            final FirebaseAuth _auth = FirebaseAuth.instance;
            final FirebaseFirestore _firestore = FirebaseFirestore.instance;
            final ApiService _api = ApiService();

            User? _firebaseUser;
            UserModel? _userModel;
            bool _isLoading = false;
            String? _error;

            User? get firebaseUser => _firebaseUser;
            UserModel? get user => _userModel;
            bool get isLoading => _isLoading;
            String? get error => _error;
            bool get isAuthenticated => _firebaseUser != null;

            bool get isPartner => _userModel?.isPartner ?? false;
            bool get isManager => _userModel?.isManager ?? false;
            bool get isAssociate => _userModel?.isAssociate ?? true;
            bool get canSeeAllTasks => _userModel?.canSeeAllTasks ?? false;

            AuthProvider() {
              _auth.authStateChanges().listen(_onAuthStateChanged);
            }

            Future<void> _onAuthStateChanged(User? user) async {
              _firebaseUser = user;
              if (user == null) {
                _userModel = null;
                notifyListeners();
                return;
              }
              await _api.initSelf();
              await _loadUserProfile(user.uid);
              notifyListeners();
            }

            Future<void> _loadUserProfile(String uid) async {
              try {
                final doc = await _firestore.collection('users').doc(uid).get();
                if (doc.exists) {
                  _userModel = UserModel.fromJson({
                    ...doc.data()!,
                    'uid': uid,
                    'email': _firebaseUser?.email ?? '',
                  });
                } else {
                  _userModel = UserModel(
                    uid: uid,
                    email: _firebaseUser?.email ?? '',
                    displayName: _firebaseUser?.email?.split('@')[0] ?? '',
                    role: 'ASSOCIATE',
                  );
                }
              } catch (e) {
                _userModel = UserModel(
                  uid: uid,
                  email: _firebaseUser?.email ?? '',
                  displayName: _firebaseUser?.email?.split('@')[0] ?? '',
                  role: 'ASSOCIATE',
                );
              }
            }

            Future<bool> signIn(String email, String password) async {
              _isLoading = true;
              _error = null;
              notifyListeners();
              try {
                await _auth.signInWithEmailAndPassword(email: email.trim(), password: password);
                _isLoading = false;
                notifyListeners();
                return true;
              } on FirebaseAuthException catch (e) {
                _error = e.message ?? 'Sign in failed';
                _isLoading = false;
                notifyListeners();
                return false;
              } catch (e) {
                _error = e.toString();
                _isLoading = false;
                notifyListeners();
                return false;
              }
            }

            Future<bool> signUp(String email, String password) async {
              _isLoading = true;
              _error = null;
              notifyListeners();
              try {
                await _auth.createUserWithEmailAndPassword(email: email.trim(), password: password);
                await _api.initSelf(displayName: email.split('@')[0]);
                _isLoading = false;
                notifyListeners();
                return true;
              } on FirebaseAuthException catch (e) {
                _error = e.message ?? 'Sign up failed';
                _isLoading = false;
                notifyListeners();
                return false;
              } catch (e) {
                _error = e.toString();
                _isLoading = false;
                notifyListeners();
                return false;
              }
            }

            Future<bool> resetPassword(String email) async {
              _isLoading = true;
              _error = null;
              notifyListeners();
              try {
                await _auth.sendPasswordResetEmail(email: email.trim());
                _isLoading = false;
                notifyListeners();
                return true;
              } catch (e) {
                _error = e.toString();
                _isLoading = false;
                notifyListeners();
                return false;
              }
            }

            Future<void> signOut() async {
              await _auth.signOut();
              _firebaseUser = null;
              _userModel = null;
              notifyListeners();
            }
          }
          ''')

          # ============================================
          # lib/providers/app_provider.dart
          # ============================================
          write_file('flutter_app/lib/providers/app_provider.dart', '''
          import 'package:flutter/material.dart';
          import 'package:cloud_firestore/cloud_firestore.dart';
          import 'package:firebase_auth/firebase_auth.dart';
          import '../models/task_model.dart';
          import '../models/client_model.dart';

          class AppProvider extends ChangeNotifier {
            final FirebaseFirestore _firestore = FirebaseFirestore.instance;
            final FirebaseAuth _auth = FirebaseAuth.instance;

            List<TaskModel> _tasks = [];
            List<ClientModel> _clients = [];
            Map<String, ClientModel> _clientsById = {};
            ThemeMode _themeMode = ThemeMode.system;
            int _selectedNavIndex = 0;

            List<TaskModel> get tasks => _tasks;
            List<ClientModel> get clients => _clients;
            Map<String, ClientModel> get clientsById => _clientsById;
            ThemeMode get themeMode => _themeMode;
            int get selectedNavIndex => _selectedNavIndex;

            void setNavIndex(int index) {
              _selectedNavIndex = index;
              notifyListeners();
            }

            void toggleTheme() {
              _themeMode = _themeMode == ThemeMode.light ? ThemeMode.dark : ThemeMode.light;
              notifyListeners();
            }

            Stream<List<TaskModel>> tasksStream({bool isPartnerOrManager = false}) {
              final user = _auth.currentUser;
              if (user == null) return Stream.value([]);

              Query query;
              if (isPartnerOrManager) {
                query = _firestore.collection('tasks').limit(2500);
              } else {
                query = _firestore.collection('tasks').where('assignedToUid', isEqualTo: user.uid).limit(2500);
              }

              return query.snapshots().map((snapshot) {
                _tasks = snapshot.docs.map((doc) => TaskModel.fromJson(doc.data() as Map<String, dynamic>, doc.id)).toList();
                notifyListeners();
                return _tasks;
              });
            }

            Stream<List<ClientModel>> clientsStream() {
              return _firestore.collection('clients').orderBy('name').limit(1200).snapshots().map((snapshot) {
                _clients = snapshot.docs.map((doc) => ClientModel.fromJson(doc.data(), doc.id)).toList();
                _clientsById = {for (var c in _clients) c.id: c};
                notifyListeners();
                return _clients;
              });
            }

            String? getClientName(String? clientId) {
              if (clientId == null) return null;
              return _clientsById[clientId]?.name;
            }
          }
          ''')

          # ============================================
          # lib/widgets/glass_card.dart
          # ============================================
          write_file('flutter_app/lib/widgets/glass_card.dart', '''
          import 'dart:ui';
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../config/theme.dart';

          class GlassCard extends StatelessWidget {
            final String? title;
            final String? subtitle;
            final Widget? trailing;
            final Widget child;
            final Color? accentColor;
            final EdgeInsetsGeometry? padding;
            final VoidCallback? onTap;

            const GlassCard({
              super.key,
              this.title,
              this.subtitle,
              this.trailing,
              required this.child,
              this.accentColor,
              this.padding,
              this.onTap,
            });

            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
              
              return GestureDetector(
                onTap: onTap,
                child: Container(
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(24),
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: isDark
                          ? [const Color(0xFF1C1C1E), const Color(0xFF2C2C2E).withOpacity(0.8)]
                          : [Colors.white.withOpacity(0.9), Colors.white.withOpacity(0.7)],
                    ),
                    border: Border.all(
                      color: accentColor?.withOpacity(0.3) ?? 
                             (isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.05)),
                      width: 1.5,
                    ),
                    boxShadow: [
                      BoxShadow(
                        color: (accentColor ?? AppTheme.primary).withOpacity(0.08),
                        blurRadius: 24,
                        offset: const Offset(0, 8),
                      ),
                      BoxShadow(
                        color: Colors.black.withOpacity(isDark ? 0.3 : 0.05),
                        blurRadius: 12,
                        offset: const Offset(0, 4),
                      ),
                    ],
                  ),
                  child: ClipRRect(
                    borderRadius: BorderRadius.circular(24),
                    child: BackdropFilter(
                      filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          if (title != null) ...[
                            Container(
                              padding: const EdgeInsets.fromLTRB(20, 18, 20, 14),
                              decoration: BoxDecoration(
                                border: Border(
                                  bottom: BorderSide(
                                    color: (isDark ? Colors.white : Colors.black).withOpacity(0.06),
                                  ),
                                ),
                              ),
                              child: Row(
                                children: [
                                  if (accentColor != null)
                                    Container(
                                      width: 4,
                                      height: 32,
                                      margin: const EdgeInsets.only(right: 14),
                                      decoration: BoxDecoration(
                                        color: accentColor,
                                        borderRadius: BorderRadius.circular(4),
                                      ),
                                    ),
                                  Expanded(
                                    child: Column(
                                      crossAxisAlignment: CrossAxisAlignment.start,
                                      children: [
                                        Text(
                                          title!,
                                          style: GoogleFonts.inter(
                                            fontSize: 18,
                                            fontWeight: FontWeight.w800,
                                            letterSpacing: -0.3,
                                          ),
                                        ),
                                        if (subtitle != null) ...[
                                          const SizedBox(height: 4),
                                          Text(
                                            subtitle!,
                                            style: GoogleFonts.inter(
                                              fontSize: 13,
                                              fontWeight: FontWeight.w500,
                                              color: isDark ? const Color(0xFF8E8E93) : const Color(0xFF6D6D72),
                                            ),
                                          ),
                                        ],
                                      ],
                                    ),
                                  ),
                                  if (trailing != null) trailing!,
                                ],
                              ),
                            ),
                          ],
                          Padding(
                            padding: padding ?? const EdgeInsets.all(20),
                            child: child,
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
              );
            }
          }
          ''')

          # ============================================
          # lib/widgets/status_pill.dart
          # ============================================
          write_file('flutter_app/lib/widgets/status_pill.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../config/theme.dart';
          import '../models/task_model.dart';
          import '../utils/date_utils.dart';

          enum PillType { normal, danger, warning, success, muted }

          class StatusPill extends StatelessWidget {
            final String text;
            final PillType type;
            final IconData? icon;

            const StatusPill({
              super.key,
              required this.text,
              this.type = PillType.normal,
              this.icon,
            });

            factory StatusPill.forTask(TaskModel task) {
              final today = AppDateUtils.todayYmd();
              if (task.status == 'COMPLETED') {
                return const StatusPill(text: 'DONE', type: PillType.success, icon: Icons.check_circle);
              }
              if (task.dueDateYmd == null || task.dueDateYmd!.isEmpty) {
                return const StatusPill(text: 'NO DUE', type: PillType.muted);
              }
              final dd = AppDateUtils.diffDays(today, task.dueDateYmd!);
              if (dd < 0) return const StatusPill(text: 'OVERDUE', type: PillType.danger, icon: Icons.warning_rounded);
              if (dd == 0) return const StatusPill(text: 'TODAY', type: PillType.danger, icon: Icons.schedule);
              if (dd <= 3) return const StatusPill(text: 'SOON', type: PillType.warning, icon: Icons.access_time);
              if (dd <= 7) return const StatusPill(text: 'THIS WEEK', type: PillType.warning);
              return const StatusPill(text: 'OK', type: PillType.muted);
            }

            @override
            Widget build(BuildContext context) {
              Color bgColor, textColor;
              switch (type) {
                case PillType.danger:
                  bgColor = AppTheme.danger.withOpacity(0.15);
                  textColor = AppTheme.danger;
                  break;
                case PillType.warning:
                  bgColor = AppTheme.warning.withOpacity(0.15);
                  textColor = AppTheme.orange;
                  break;
                case PillType.success:
                  bgColor = AppTheme.success.withOpacity(0.15);
                  textColor = AppTheme.success;
                  break;
                case PillType.muted:
                  bgColor = const Color(0xFF8E8E93).withOpacity(0.15);
                  textColor = const Color(0xFF8E8E93);
                  break;
                default:
                  bgColor = AppTheme.primary.withOpacity(0.15);
                  textColor = AppTheme.primary;
              }

              return Container(
                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                decoration: BoxDecoration(
                  color: bgColor,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    if (icon != null) ...[
                      Icon(icon, size: 12, color: textColor),
                      const SizedBox(width: 4),
                    ],
                    Text(
                      text,
                      style: GoogleFonts.inter(
                        fontSize: 11,
                        fontWeight: FontWeight.w700,
                        color: textColor,
                        letterSpacing: 0.3,
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          ''')

          # ============================================
          # lib/widgets/category_pill.dart
          # ============================================
          write_file('flutter_app/lib/widgets/category_pill.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../config/theme.dart';

          class CategoryPill extends StatelessWidget {
            final String category;

            const CategoryPill({super.key, required this.category});

            String get normalized {
              final u = category.toUpperCase().replaceAll(' ', '_');
              if (u == 'INCOME_TAX' || u == 'INCOME_TAX_RETURN') return 'INCOME_TAX';
              if (['GST', 'TDS', 'ROC', 'ACCOUNTING', 'AUDIT'].contains(u)) return u;
              return 'OTHER';
            }

            @override
            Widget build(BuildContext context) {
              final color = AppTheme.categoryColors[normalized] ?? AppTheme.categoryColors['OTHER']!;
              return Container(
                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 5),
                decoration: BoxDecoration(
                  color: color.withOpacity(0.15),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  normalized.replaceAll('_', ' '),
                  style: GoogleFonts.inter(
                    fontSize: 11,
                    fontWeight: FontWeight.w700,
                    color: color,
                    letterSpacing: 0.3,
                  ),
                ),
              );
            }
          }
          ''')

          # ============================================
          # lib/widgets/kpi_card.dart
          # ============================================
          write_file('flutter_app/lib/widgets/kpi_card.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../config/theme.dart';

          class KpiCard extends StatelessWidget {
            final String label;
            final int value;
            final IconData icon;
            final Color color;
            final bool isAlert;

            const KpiCard({
              super.key,
              required this.label,
              required this.value,
              required this.icon,
              required this.color,
              this.isAlert = false,
            });

            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;

              return Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topLeft,
                    end: Alignment.bottomRight,
                    colors: [
                      color.withOpacity(isDark ? 0.25 : 0.12),
                      color.withOpacity(isDark ? 0.15 : 0.05),
                    ],
                  ),
                  borderRadius: BorderRadius.circular(20),
                  border: Border.all(
                    color: color.withOpacity(isAlert && value > 0 ? 0.5 : 0.2),
                    width: isAlert && value > 0 ? 2 : 1,
                  ),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Container(
                      padding: const EdgeInsets.all(10),
                      decoration: BoxDecoration(
                        color: color.withOpacity(0.2),
                        borderRadius: BorderRadius.circular(12),
                      ),
                      child: Icon(icon, color: color, size: 20),
                    ),
                    const Spacer(),
                    Text(
                      value.toString(),
                      style: GoogleFonts.inter(
                        fontSize: 32,
                        fontWeight: FontWeight.w900,
                        color: color,
                        height: 1,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      label,
                      style: GoogleFonts.inter(
                        fontSize: 12,
                        fontWeight: FontWeight.w600,
                        color: isDark ? const Color(0xFF8E8E93) : const Color(0xFF6D6D72),
                      ),
                      maxLines: 1,
                      overflow: TextOverflow.ellipsis,
                    ),
                  ],
                ),
              );
            }
          }
          ''')

          print("\\n‚úÖ All widget files created!")
          PYTHON_SCRIPT

      - name: üì± Create Screen Files
        run: |
          python << 'PYTHON_SCRIPT'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          # ============================================
          # lib/screens/auth_screen.dart
          # ============================================
          write_file('flutter_app/lib/screens/auth_screen.dart', '''
          import 'dart:ui';
          import 'package:flutter/material.dart';
          import 'package:flutter_animate/flutter_animate.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../providers/auth_provider.dart';
          import '../config/theme.dart';

          class AuthScreen extends StatefulWidget {
            const AuthScreen({super.key});

            @override
            State<AuthScreen> createState() => _AuthScreenState();
          }

          class _AuthScreenState extends State<AuthScreen> {
            final _emailController = TextEditingController();
            final _passwordController = TextEditingController();
            bool _isSignUp = false;
            bool _isForgot = false;
            bool _obscurePassword = true;

            @override
            void dispose() {
              _emailController.dispose();
              _passwordController.dispose();
              super.dispose();
            }

            Future<void> _handleSubmit() async {
              final auth = context.read<AuthProvider>();
              final email = _emailController.text.trim();
              final password = _passwordController.text;

              if (email.isEmpty) {
                _showSnackBar('Please enter your email', isError: true);
                return;
              }

              if (_isForgot) {
                final success = await auth.resetPassword(email);
                if (mounted && success) {
                  _showSnackBar('Password reset email sent!');
                  setState(() => _isForgot = false);
                }
                return;
              }

              if (password.isEmpty || password.length < 6) {
                _showSnackBar('Password must be at least 6 characters', isError: true);
                return;
              }

              bool success;
              if (_isSignUp) {
                success = await auth.signUp(email, password);
                if (mounted && success) _showSnackBar('Account created successfully!');
              } else {
                success = await auth.signIn(email, password);
              }

              if (mounted && !success && auth.error != null) {
                _showSnackBar(auth.error!, isError: true);
              }
            }

            void _showSnackBar(String message, {bool isError = false}) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text(message),
                  backgroundColor: isError ? AppTheme.danger : AppTheme.success,
                ),
              );
            }

            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final isDark = Theme.of(context).brightness == Brightness.dark;
              final size = MediaQuery.of(context).size;

              return Scaffold(
                body: Stack(
                  children: [
                    Container(
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: isDark
                              ? [const Color(0xFF000000), const Color(0xFF1C1C1E)]
                              : [const Color(0xFFF2F2F7), const Color(0xFFE5E5EA)],
                        ),
                      ),
                    ),
                    Positioned(
                      top: -size.width * 0.3,
                      right: -size.width * 0.2,
                      child: Container(
                        width: size.width * 0.8,
                        height: size.width * 0.8,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          gradient: RadialGradient(
                            colors: [
                              AppTheme.primary.withOpacity(0.3),
                              AppTheme.primary.withOpacity(0),
                            ],
                          ),
                        ),
                      ),
                    ).animate().fadeIn(duration: 1000.ms).scale(begin: const Offset(0.8, 0.8)),
                    Positioned(
                      bottom: -size.width * 0.4,
                      left: -size.width * 0.3,
                      child: Container(
                        width: size.width * 0.9,
                        height: size.width * 0.9,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          gradient: RadialGradient(
                            colors: [
                              AppTheme.accent.withOpacity(0.25),
                              AppTheme.accent.withOpacity(0),
                            ],
                          ),
                        ),
                      ),
                    ).animate().fadeIn(duration: 1200.ms, delay: 200.ms),
                    
                    SafeArea(
                      child: Center(
                        child: SingleChildScrollView(
                          padding: const EdgeInsets.all(24),
                          child: ConstrainedBox(
                            constraints: const BoxConstraints(maxWidth: 420),
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                Container(
                                  width: 80,
                                  height: 80,
                                  decoration: BoxDecoration(
                                    borderRadius: BorderRadius.circular(24),
                                    gradient: AppTheme.primaryGradient,
                                    boxShadow: [
                                      BoxShadow(
                                        color: AppTheme.primary.withOpacity(0.4),
                                        blurRadius: 30,
                                        offset: const Offset(0, 10),
                                      ),
                                    ],
                                  ),
                                  child: const Icon(Icons.check_circle_outline_rounded, color: Colors.white, size: 40),
                                ).animate().fadeIn(duration: 600.ms).slideY(begin: -0.3),
                                const SizedBox(height: 24),
                                
                                Text(
                                  'ComplianceOS',
                                  style: GoogleFonts.inter(fontSize: 32, fontWeight: FontWeight.w900, letterSpacing: -1),
                                ).animate().fadeIn(duration: 600.ms, delay: 100.ms),
                                const SizedBox(height: 8),
                                Text(
                                  'Tasks ¬∑ Calendar ¬∑ Compliance',
                                  style: GoogleFonts.inter(fontSize: 15, fontWeight: FontWeight.w600, color: const Color(0xFF8E8E93)),
                                ).animate().fadeIn(duration: 600.ms, delay: 200.ms),
                                const SizedBox(height: 48),

                                ClipRRect(
                                  borderRadius: BorderRadius.circular(28),
                                  child: BackdropFilter(
                                    filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                                    child: Container(
                                      padding: const EdgeInsets.all(28),
                                      decoration: BoxDecoration(
                                        color: isDark ? Colors.white.withOpacity(0.08) : Colors.white.withOpacity(0.8),
                                        borderRadius: BorderRadius.circular(28),
                                        border: Border.all(color: isDark ? Colors.white.withOpacity(0.1) : Colors.white.withOpacity(0.5)),
                                        boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.1), blurRadius: 40, offset: const Offset(0, 20))],
                                      ),
                                      child: Column(
                                        crossAxisAlignment: CrossAxisAlignment.start,
                                        children: [
                                          Text(
                                            _isForgot ? 'Reset Password' : (_isSignUp ? 'Create Account' : 'Welcome Back'),
                                            style: GoogleFonts.inter(fontSize: 24, fontWeight: FontWeight.w800),
                                          ),
                                          const SizedBox(height: 8),
                                          Text(
                                            _isForgot ? 'Enter your email to receive a reset link' : (_isSignUp ? 'Start managing compliance today' : 'Sign in to continue'),
                                            style: GoogleFonts.inter(fontSize: 14, color: const Color(0xFF8E8E93)),
                                          ),
                                          const SizedBox(height: 28),

                                          Text('Email', style: GoogleFonts.inter(fontSize: 13, fontWeight: FontWeight.w700, color: isDark ? Colors.white70 : Colors.black54)),
                                          const SizedBox(height: 8),
                                          TextField(
                                            controller: _emailController,
                                            keyboardType: TextInputType.emailAddress,
                                            decoration: InputDecoration(
                                              hintText: 'your@email.com',
                                              prefixIcon: const Icon(Icons.email_outlined, size: 20),
                                              filled: true,
                                              fillColor: isDark ? Colors.white.withOpacity(0.05) : const Color(0xFFF2F2F7),
                                            ),
                                          ),
                                          const SizedBox(height: 20),

                                          if (!_isForgot) ...[
                                            Text('Password', style: GoogleFonts.inter(fontSize: 13, fontWeight: FontWeight.w700, color: isDark ? Colors.white70 : Colors.black54)),
                                            const SizedBox(height: 8),
                                            TextField(
                                              controller: _passwordController,
                                              obscureText: _obscurePassword,
                                              decoration: InputDecoration(
                                                hintText: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                                                prefixIcon: const Icon(Icons.lock_outline, size: 20),
                                                suffixIcon: IconButton(
                                                  icon: Icon(_obscurePassword ? Icons.visibility_outlined : Icons.visibility_off_outlined, size: 20),
                                                  onPressed: () => setState(() => _obscurePassword = !_obscurePassword),
                                                ),
                                                filled: true,
                                                fillColor: isDark ? Colors.white.withOpacity(0.05) : const Color(0xFFF2F2F7),
                                              ),
                                            ),
                                            const SizedBox(height: 28),
                                          ],

                                          SizedBox(
                                            width: double.infinity,
                                            height: 54,
                                            child: ElevatedButton(
                                              onPressed: auth.isLoading ? null : _handleSubmit,
                                              style: ElevatedButton.styleFrom(
                                                backgroundColor: AppTheme.primary,
                                                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                                              ),
                                              child: auth.isLoading
                                                  ? const SizedBox(width: 24, height: 24, child: CircularProgressIndicator(strokeWidth: 2.5, color: Colors.white))
                                                  : Text(
                                                      _isForgot ? 'Send Reset Link' : (_isSignUp ? 'Create Account' : 'Sign In'),
                                                      style: GoogleFonts.inter(fontSize: 16, fontWeight: FontWeight.w700),
                                                    ),
                                            ),
                                          ),
                                          const SizedBox(height: 20),

                                          Row(
                                            mainAxisAlignment: MainAxisAlignment.center,
                                            children: [
                                              if (!_isForgot)
                                                TextButton(
                                                  onPressed: () => setState(() => _isSignUp = !_isSignUp),
                                                  child: Text(
                                                    _isSignUp ? 'Already have an account? Sign In' : "Don't have an account? Sign Up",
                                                    style: GoogleFonts.inter(fontWeight: FontWeight.w600, color: AppTheme.primary),
                                                  ),
                                                ),
                                            ],
                                          ),
                                          Center(
                                            child: TextButton(
                                              onPressed: () => setState(() => _isForgot = !_isForgot),
                                              child: Text(
                                                _isForgot ? 'Back to Sign In' : 'Forgot Password?',
                                                style: GoogleFonts.inter(fontWeight: FontWeight.w600, color: const Color(0xFF8E8E93)),
                                              ),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                  ),
                                ).animate().fadeIn(duration: 700.ms, delay: 300.ms).slideY(begin: 0.2),
                                
                                const SizedBox(height: 32),
                                Text(
                                  'Timezone: Asia/Kolkata ‚Ä¢ DD-MM-YYYY',
                                  style: GoogleFonts.inter(fontSize: 12, color: const Color(0xFF8E8E93)),
                                ).animate().fadeIn(duration: 600.ms, delay: 500.ms),
                              ],
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          ''')

          # ============================================
          # lib/screens/main_shell.dart
          # ============================================
          write_file('flutter_app/lib/screens/main_shell.dart', '''
          import 'dart:ui';
          import 'package:flutter/material.dart';
          import 'package:flutter_animate/flutter_animate.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../providers/auth_provider.dart';
          import '../providers/app_provider.dart';
          import '../config/theme.dart';
          import 'home_screen.dart';
          import 'work_queue_screen.dart';
          import 'settings_screen.dart';

          class MainShell extends StatefulWidget {
            const MainShell({super.key});

            @override
            State<MainShell> createState() => _MainShellState();
          }

          class _MainShellState extends State<MainShell> {
            int _selectedIndex = 0;

            final List<_NavItem> _navItems = [
              _NavItem(icon: Icons.space_dashboard_rounded, activeIcon: Icons.space_dashboard, label: 'Home'),
              _NavItem(icon: Icons.list_alt_rounded, activeIcon: Icons.list_alt, label: 'Tasks'),
              _NavItem(icon: Icons.settings_outlined, activeIcon: Icons.settings, label: 'Settings'),
            ];

            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final isDark = Theme.of(context).brightness == Brightness.dark;

              return Scaffold(
                extendBody: true,
                appBar: _buildAppBar(context, auth, isDark),
                body: AnimatedSwitcher(
                  duration: const Duration(milliseconds: 300),
                  child: _buildBody(_selectedIndex),
                ),
                bottomNavigationBar: _buildBottomNav(context, isDark),
                floatingActionButton: _buildFAB(context),
              );
            }

            PreferredSizeWidget _buildAppBar(BuildContext context, AuthProvider auth, bool isDark) {
              return PreferredSize(
                preferredSize: const Size.fromHeight(70),
                child: ClipRRect(
                  child: BackdropFilter(
                    filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                    child: Container(
                      decoration: BoxDecoration(
                        color: isDark ? const Color(0xFF1C1C1E).withOpacity(0.8) : Colors.white.withOpacity(0.8),
                        border: Border(bottom: BorderSide(color: isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.05))),
                      ),
                      child: SafeArea(
                        child: Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 20),
                          child: Row(
                            children: [
                              Container(
                                width: 42, height: 42,
                                decoration: BoxDecoration(borderRadius: BorderRadius.circular(12), gradient: AppTheme.primaryGradient),
                                child: const Icon(Icons.check_circle_outline, color: Colors.white, size: 22),
                              ),
                              const SizedBox(width: 14),
                              Column(
                                mainAxisAlignment: MainAxisAlignment.center,
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text('ComplianceOS', style: GoogleFonts.inter(fontSize: 18, fontWeight: FontWeight.w800)),
                                  Text(auth.user?.role ?? 'USER', style: GoogleFonts.inter(fontSize: 12, fontWeight: FontWeight.w600, color: AppTheme.primary)),
                                ],
                              ),
                              const Spacer(),
                              IconButton(
                                onPressed: () => context.read<AppProvider>().toggleTheme(),
                                icon: Icon(isDark ? Icons.light_mode_rounded : Icons.dark_mode_rounded, color: isDark ? Colors.white70 : Colors.black54),
                              ),
                              GestureDetector(
                                onTap: () => _showProfileSheet(context, auth),
                                child: Container(
                                  width: 42, height: 42,
                                  decoration: BoxDecoration(
                                    shape: BoxShape.circle,
                                    gradient: LinearGradient(colors: [AppTheme.purple.withOpacity(0.8), AppTheme.pink.withOpacity(0.8)]),
                                  ),
                                  child: Center(
                                    child: Text((auth.user?.email ?? 'U')[0].toUpperCase(), style: GoogleFonts.inter(color: Colors.white, fontWeight: FontWeight.w700, fontSize: 16)),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
              );
            }

            Widget _buildBody(int index) {
              switch (index) {
                case 0: return const HomeScreen();
                case 1: return const WorkQueueScreen();
                case 2: return const SettingsScreen();
                default: return const HomeScreen();
              }
            }

            Widget _buildBottomNav(BuildContext context, bool isDark) {
              return ClipRRect(
                child: BackdropFilter(
                  filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                  child: Container(
                    decoration: BoxDecoration(
                      color: isDark ? const Color(0xFF1C1C1E).withOpacity(0.9) : Colors.white.withOpacity(0.9),
                      border: Border(top: BorderSide(color: isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.05))),
                    ),
                    child: SafeArea(
                      child: Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 8),
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.spaceAround,
                          children: _navItems.asMap().entries.map((entry) {
                            final index = entry.key;
                            final item = entry.value;
                            final isSelected = index == _selectedIndex;

                            return Expanded(
                              child: GestureDetector(
                                onTap: () => setState(() => _selectedIndex = index),
                                child: AnimatedContainer(
                                  duration: const Duration(milliseconds: 200),
                                  padding: const EdgeInsets.symmetric(vertical: 8),
                                  decoration: BoxDecoration(
                                    color: isSelected ? AppTheme.primary.withOpacity(0.1) : Colors.transparent,
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  child: Column(
                                    mainAxisSize: MainAxisSize.min,
                                    children: [
                                      Icon(isSelected ? item.activeIcon : item.icon, color: isSelected ? AppTheme.primary : (isDark ? Colors.white54 : Colors.black45), size: 24),
                                      const SizedBox(height: 4),
                                      Text(item.label, style: GoogleFonts.inter(fontSize: 11, fontWeight: isSelected ? FontWeight.w700 : FontWeight.w600, color: isSelected ? AppTheme.primary : (isDark ? Colors.white54 : Colors.black45))),
                                    ],
                                  ),
                                ),
                              ),
                            );
                          }).toList(),
                        ),
                      ),
                    ),
                  ),
                ),
              );
            }

            Widget _buildFAB(BuildContext context) {
              return FloatingActionButton(
                onPressed: () => ScaffoldMessenger.of(context).showSnackBar(const SnackBar(content: Text('Quick task coming soon!'))),
                child: Container(
                  width: 56, height: 56,
                  decoration: BoxDecoration(borderRadius: BorderRadius.circular(18), gradient: AppTheme.primaryGradient, boxShadow: [BoxShadow(color: AppTheme.primary.withOpacity(0.4), blurRadius: 20, offset: const Offset(0, 8))]),
                  child: const Icon(Icons.add_rounded, color: Colors.white, size: 28),
                ),
              ).animate().scale(delay: 500.ms, duration: 300.ms);
            }

            void _showProfileSheet(BuildContext context, AuthProvider auth) {
              showModalBottomSheet(
                context: context,
                backgroundColor: Colors.transparent,
                builder: (context) => Container(
                  padding: const EdgeInsets.all(24),
                  decoration: BoxDecoration(color: Theme.of(context).scaffoldBackgroundColor, borderRadius: const BorderRadius.vertical(top: Radius.circular(28))),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Container(width: 40, height: 4, decoration: BoxDecoration(color: Colors.grey.withOpacity(0.3), borderRadius: BorderRadius.circular(2))),
                      const SizedBox(height: 24),
                      Container(
                        width: 80, height: 80,
                        decoration: BoxDecoration(shape: BoxShape.circle, gradient: LinearGradient(colors: [AppTheme.purple, AppTheme.pink])),
                        child: Center(child: Text((auth.user?.email ?? 'U')[0].toUpperCase(), style: GoogleFonts.inter(color: Colors.white, fontWeight: FontWeight.w800, fontSize: 32))),
                      ),
                      const SizedBox(height: 16),
                      Text(auth.user?.displayName ?? 'User', style: GoogleFonts.inter(fontSize: 20, fontWeight: FontWeight.w800)),
                      const SizedBox(height: 4),
                      Text(auth.user?.email ?? '', style: GoogleFonts.inter(color: const Color(0xFF8E8E93))),
                      const SizedBox(height: 8),
                      Chip(label: Text(auth.user?.role ?? 'USER'), backgroundColor: AppTheme.primary.withOpacity(0.1), labelStyle: GoogleFonts.inter(color: AppTheme.primary, fontWeight: FontWeight.w700)),
                      const SizedBox(height: 32),
                      SizedBox(
                        width: double.infinity,
                        child: ElevatedButton.icon(
                          onPressed: () { Navigator.pop(context); auth.signOut(); },
                          icon: const Icon(Icons.logout_rounded),
                          label: const Text('Sign Out'),
                          style: ElevatedButton.styleFrom(backgroundColor: AppTheme.danger, padding: const EdgeInsets.symmetric(vertical: 16)),
                        ),
                      ),
                      const SizedBox(height: 16),
                    ],
                  ),
                ),
              );
            }
          }

          class _NavItem {
            final IconData icon;
            final IconData activeIcon;
            final String label;
            _NavItem({required this.icon, required this.activeIcon, required this.label});
          }
          ''')

          # ============================================
          # lib/screens/home_screen.dart
          # ============================================
          write_file('flutter_app/lib/screens/home_screen.dart', '''
          import 'package:flutter/material.dart';
          import 'package:flutter_animate/flutter_animate.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import 'package:shimmer/shimmer.dart';
          import '../providers/auth_provider.dart';
          import '../providers/app_provider.dart';
          import '../models/task_model.dart';
          import '../widgets/glass_card.dart';
          import '../widgets/status_pill.dart';
          import '../widgets/kpi_card.dart';
          import '../config/theme.dart';
          import '../utils/date_utils.dart';

          class HomeScreen extends StatelessWidget {
            const HomeScreen({super.key});

            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
              final isDark = Theme.of(context).brightness == Brightness.dark;

              return StreamBuilder<List<TaskModel>>(
                stream: app.tasksStream(isPartnerOrManager: auth.canSeeAllTasks),
                builder: (context, snapshot) {
                  if (!snapshot.hasData) return _buildLoadingState(isDark);

                  final tasks = snapshot.data!;
                  final stats = _computeStats(tasks);

                  return RefreshIndicator(
                    onRefresh: () async => await Future.delayed(const Duration(seconds: 1)),
                    child: SingleChildScrollView(
                      physics: const AlwaysScrollableScrollPhysics(),
                      padding: const EdgeInsets.fromLTRB(20, 20, 20, 120),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(_getGreeting(), style: GoogleFonts.inter(fontSize: 28, fontWeight: FontWeight.w900, letterSpacing: -0.5)).animate().fadeIn(duration: 500.ms).slideX(begin: -0.1),
                          const SizedBox(height: 4),
                          Text("Here's your compliance overview", style: GoogleFonts.inter(fontSize: 15, color: const Color(0xFF8E8E93))).animate().fadeIn(duration: 500.ms, delay: 100.ms),
                          const SizedBox(height: 28),

                          GridView.count(
                            shrinkWrap: true,
                            physics: const NeverScrollableScrollPhysics(),
                            crossAxisCount: 2,
                            crossAxisSpacing: 14,
                            mainAxisSpacing: 14,
                            childAspectRatio: 1.4,
                            children: [
                              KpiCard(label: 'Due Today', value: stats.dueToday, icon: Icons.today_rounded, color: AppTheme.danger, isAlert: true).animate().fadeIn(duration: 400.ms, delay: 100.ms).scale(begin: const Offset(0.9, 0.9)),
                              KpiCard(label: 'This Week', value: stats.due7, icon: Icons.date_range_rounded, color: AppTheme.warning).animate().fadeIn(duration: 400.ms, delay: 150.ms).scale(begin: const Offset(0.9, 0.9)),
                              KpiCard(label: 'Overdue', value: stats.overdue, icon: Icons.warning_rounded, color: AppTheme.pink, isAlert: true).animate().fadeIn(duration: 400.ms, delay: 200.ms).scale(begin: const Offset(0.9, 0.9)),
                              KpiCard(label: 'Pending Approval', value: stats.approval, icon: Icons.pending_actions_rounded, color: AppTheme.purple).animate().fadeIn(duration: 400.ms, delay: 250.ms).scale(begin: const Offset(0.9, 0.9)),
                            ],
                          ),
                          const SizedBox(height: 28),

                          GlassCard(
                            title: 'Focus Tasks',
                            subtitle: 'Tasks requiring immediate attention',
                            accentColor: AppTheme.primary,
                            child: stats.focusTasks.isEmpty
                                ? _buildEmptyState(isDark)
                                : Column(children: stats.focusTasks.take(8).map((task) => _TaskRow(task: task, clientName: app.getClientName(task.clientId))).toList()),
                          ).animate().fadeIn(duration: 500.ms, delay: 300.ms).slideY(begin: 0.1),
                        ],
                      ),
                    ),
                  );
                },
              );
            }

            Widget _buildLoadingState(bool isDark) {
              return Shimmer.fromColors(
                baseColor: isDark ? const Color(0xFF2C2C2E) : const Color(0xFFE5E5EA),
                highlightColor: isDark ? const Color(0xFF3A3A3C) : const Color(0xFFF2F2F7),
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(20),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Container(width: 200, height: 32, color: Colors.white),
                      const SizedBox(height: 28),
                      GridView.count(shrinkWrap: true, crossAxisCount: 2, crossAxisSpacing: 14, mainAxisSpacing: 14, childAspectRatio: 1.4, children: List.generate(4, (_) => Container(decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(20))))),
                    ],
                  ),
                ),
              );
            }

            Widget _buildEmptyState(bool isDark) {
              return Container(
                padding: const EdgeInsets.all(32),
                child: Column(
                  children: [
                    Container(width: 64, height: 64, decoration: BoxDecoration(color: AppTheme.success.withOpacity(0.15), shape: BoxShape.circle), child: const Icon(Icons.check_circle_rounded, color: AppTheme.success, size: 32)),
                    const SizedBox(height: 16),
                    Text('All caught up!', style: GoogleFonts.inter(fontSize: 18, fontWeight: FontWeight.w800)),
                    const SizedBox(height: 8),
                    Text('No urgent tasks at the moment', style: GoogleFonts.inter(color: const Color(0xFF8E8E93))),
                  ],
                ),
              );
            }

            String _getGreeting() {
              final hour = DateTime.now().hour;
              if (hour < 12) return 'Good morning';
              if (hour < 17) return 'Good afternoon';
              return 'Good evening';
            }

            _Stats _computeStats(List<TaskModel> tasks) {
              final today = AppDateUtils.todayYmd();
              int dueToday = 0, due7 = 0, overdue = 0, approval = 0;
              List<TaskModel> focusTasks = [];

              for (final task in tasks) {
                if (task.status == 'APPROVAL_PENDING') approval++;
                if (task.dueDateYmd == null) continue;
                final dd = AppDateUtils.diffDays(today, task.dueDateYmd!);
                if (task.status != 'COMPLETED') {
                  if (dd < 0) overdue++;
                  if (dd == 0) dueToday++;
                  if (dd >= 0 && dd <= 7) due7++;
                  if (dd <= 3) focusTasks.add(task);
                }
              }

              focusTasks.sort((a, b) => (a.dueDateYmd ?? '').compareTo(b.dueDateYmd ?? ''));
              return _Stats(dueToday: dueToday, due7: due7, overdue: overdue, approval: approval, focusTasks: focusTasks);
            }
          }

          class _Stats {
            final int dueToday, due7, overdue, approval;
            final List<TaskModel> focusTasks;
            _Stats({required this.dueToday, required this.due7, required this.overdue, required this.approval, required this.focusTasks});
          }

          class _TaskRow extends StatelessWidget {
            final TaskModel task;
            final String? clientName;
            const _TaskRow({required this.task, this.clientName});

            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
              return Container(
                margin: const EdgeInsets.only(bottom: 12),
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(color: isDark ? Colors.white.withOpacity(0.05) : const Color(0xFFF2F2F7), borderRadius: BorderRadius.circular(16), border: Border.all(color: isDark ? Colors.white.withOpacity(0.08) : Colors.black.withOpacity(0.03))),
                child: Row(
                  children: [
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(children: [StatusPill.forTask(task), const SizedBox(width: 8), Expanded(child: Text(task.title, style: GoogleFonts.inter(fontWeight: FontWeight.w700), maxLines: 1, overflow: TextOverflow.ellipsis))]),
                          const SizedBox(height: 8),
                          Text('\${clientName ?? "No client"} ‚Ä¢ \${task.dueDateYmd != null ? AppDateUtils.ymdToDmy(task.dueDateYmd!) : "No due date"}', style: GoogleFonts.inter(fontSize: 12, color: const Color(0xFF8E8E93))),
                        ],
                      ),
                    ),
                    const Icon(Icons.chevron_right_rounded, color: Color(0xFF8E8E93)),
                  ],
                ),
              );
            }
          }
          ''')

          # ============================================
          # lib/screens/work_queue_screen.dart
          # ============================================
          write_file('flutter_app/lib/screens/work_queue_screen.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../providers/auth_provider.dart';
          import '../providers/app_provider.dart';
          import '../models/task_model.dart';
          import '../widgets/status_pill.dart';
          import '../widgets/category_pill.dart';
          import '../config/theme.dart';
          import '../utils/date_utils.dart';

          class WorkQueueScreen extends StatefulWidget {
            const WorkQueueScreen({super.key});

            @override
            State<WorkQueueScreen> createState() => _WorkQueueScreenState();
          }

          class _WorkQueueScreenState extends State<WorkQueueScreen> {
            String _search = '';
            String _statusFilter = '';

            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
              final isDark = Theme.of(context).brightness == Brightness.dark;

              return StreamBuilder<List<TaskModel>>(
                stream: app.tasksStream(isPartnerOrManager: auth.canSeeAllTasks),
                builder: (context, snapshot) {
                  final tasks = _filterTasks(snapshot.data ?? [], app);

                  return SingleChildScrollView(
                    padding: const EdgeInsets.fromLTRB(20, 20, 20, 120),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text('Work Queue', style: GoogleFonts.inter(fontSize: 28, fontWeight: FontWeight.w900)),
                        const SizedBox(height: 4),
                        Text('\${tasks.length} tasks', style: GoogleFonts.inter(fontSize: 15, color: const Color(0xFF8E8E93))),
                        const SizedBox(height: 20),

                        TextField(
                          onChanged: (v) => setState(() => _search = v),
                          decoration: InputDecoration(hintText: 'Search tasks...', prefixIcon: const Icon(Icons.search_rounded), filled: true, fillColor: isDark ? const Color(0xFF2C2C2E) : const Color(0xFFF2F2F7)),
                        ),
                        const SizedBox(height: 16),

                        SingleChildScrollView(
                          scrollDirection: Axis.horizontal,
                          child: Row(
                            children: [
                              _FilterChip(label: 'All', isSelected: _statusFilter.isEmpty, onTap: () => setState(() => _statusFilter = '')),
                              _FilterChip(label: 'Pending', isSelected: _statusFilter == 'PENDING', onTap: () => setState(() => _statusFilter = 'PENDING')),
                              _FilterChip(label: 'In Progress', isSelected: _statusFilter == 'IN_PROGRESS', onTap: () => setState(() => _statusFilter = 'IN_PROGRESS')),
                              _FilterChip(label: 'Completed', isSelected: _statusFilter == 'COMPLETED', onTap: () => setState(() => _statusFilter = 'COMPLETED')),
                            ],
                          ),
                        ),
                        const SizedBox(height: 20),

                        if (tasks.isEmpty)
                          Center(child: Padding(padding: const EdgeInsets.all(40), child: Column(children: [Icon(Icons.inbox_rounded, size: 64, color: const Color(0xFF8E8E93)), const SizedBox(height: 16), Text('No tasks found', style: GoogleFonts.inter(fontWeight: FontWeight.w700))])))
                        else
                          ...tasks.take(50).map((task) => _TaskCard(task: task, clientName: app.getClientName(task.clientId))),
                      ],
                    ),
                  );
                },
              );
            }

            List<TaskModel> _filterTasks(List<TaskModel> tasks, AppProvider app) {
              return tasks.where((task) {
                if (_statusFilter.isNotEmpty && task.status != _statusFilter) return false;
                if (_search.isNotEmpty) {
                  final hay = '\${task.title} \${app.getClientName(task.clientId) ?? ""}'.toLowerCase();
                  if (!hay.contains(_search.toLowerCase())) return false;
                }
                return true;
              }).toList()..sort((a, b) => (a.dueDateYmd ?? '').compareTo(b.dueDateYmd ?? ''));
            }
          }

          class _FilterChip extends StatelessWidget {
            final String label;
            final bool isSelected;
            final VoidCallback onTap;
            const _FilterChip({required this.label, required this.isSelected, required this.onTap});

            @override
            Widget build(BuildContext context) {
              return Padding(
                padding: const EdgeInsets.only(right: 8),
                child: GestureDetector(
                  onTap: onTap,
                  child: Container(
                    padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 10),
                    decoration: BoxDecoration(color: isSelected ? AppTheme.primary : Colors.transparent, borderRadius: BorderRadius.circular(12), border: Border.all(color: isSelected ? AppTheme.primary : const Color(0xFF8E8E93).withOpacity(0.3))),
                    child: Text(label, style: GoogleFonts.inter(fontWeight: FontWeight.w700, color: isSelected ? Colors.white : const Color(0xFF8E8E93))),
                  ),
                ),
              );
            }
          }

          class _TaskCard extends StatelessWidget {
            final TaskModel task;
            final String? clientName;
            const _TaskCard({required this.task, this.clientName});

            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
              return Container(
                margin: const EdgeInsets.only(bottom: 12),
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(color: isDark ? const Color(0xFF1C1C1E) : Colors.white, borderRadius: BorderRadius.circular(16), border: Border.all(color: isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.05))),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Row(children: [StatusPill.forTask(task), const SizedBox(width: 8), CategoryPill(category: task.category ?? 'OTHER'), const Spacer(), Text(task.dueDateYmd != null ? AppDateUtils.ymdToDmy(task.dueDateYmd!) : '', style: GoogleFonts.inter(fontSize: 12, color: const Color(0xFF8E8E93)))]),
                    const SizedBox(height: 12),
                    Text(task.title, style: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 15)),
                    const SizedBox(height: 6),
                    Text(clientName ?? 'No client', style: GoogleFonts.inter(fontSize: 13, color: const Color(0xFF8E8E93))),
                  ],
                ),
              );
            }
          }
          ''')

          # ============================================
          # lib/screens/settings_screen.dart
          # ============================================
          write_file('flutter_app/lib/screens/settings_screen.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../providers/app_provider.dart';
          import '../config/theme.dart';

          class SettingsScreen extends StatelessWidget {
            const SettingsScreen({super.key});

            @override
            Widget build(BuildContext context) {
              final app = context.watch<AppProvider>();
              final isDark = Theme.of(context).brightness == Brightness.dark;

              return SingleChildScrollView(
                padding: const EdgeInsets.fromLTRB(20, 20, 20, 120),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Settings', style: GoogleFonts.inter(fontSize: 28, fontWeight: FontWeight.w900)),
                    const SizedBox(height: 20),
                    _SettingsTile(
                      icon: Icons.dark_mode_rounded,
                      title: 'Dark Mode',
                      trailing: Switch(value: isDark, onChanged: (_) => app.toggleTheme(), activeColor: AppTheme.primary),
                    ),
                    _SettingsTile(icon: Icons.info_outline_rounded, title: 'Version', trailing: Text('1.0.0', style: GoogleFonts.inter(color: const Color(0xFF8E8E93)))),
                  ],
                ),
              );
            }
          }

          class _SettingsTile extends StatelessWidget {
            final IconData icon;
            final String title;
            final Widget? trailing;
            const _SettingsTile({required this.icon, required this.title, this.trailing});

            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
              return Container(
                margin: const EdgeInsets.only(bottom: 12),
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(color: isDark ? const Color(0xFF1C1C1E) : Colors.white, borderRadius: BorderRadius.circular(16)),
                child: Row(children: [Icon(icon, color: AppTheme.primary), const SizedBox(width: 16), Expanded(child: Text(title, style: GoogleFonts.inter(fontWeight: FontWeight.w600))), if (trailing != null) trailing!]),
              );
            }
          }
          ''')

          # ============================================
          # lib/main.dart
          # ============================================
          write_file('flutter_app/lib/main.dart', '''
          import 'package:flutter/material.dart';
          import 'package:flutter/services.dart';
          import 'package:firebase_core/firebase_core.dart';
          import 'package:provider/provider.dart';
          import 'config/theme.dart';
          import 'config/constants.dart';
          import 'providers/auth_provider.dart';
          import 'providers/app_provider.dart';
          import 'screens/auth_screen.dart';
          import 'screens/main_shell.dart';

          void main() async {
            WidgetsFlutterBinding.ensureInitialized();
            
            await Firebase.initializeApp(
              options: const FirebaseOptions(
                apiKey: AppConstants.firebaseApiKey,
                authDomain: AppConstants.firebaseAuthDomain,
                projectId: AppConstants.firebaseProjectId,
                storageBucket: AppConstants.firebaseStorageBucket,
                messagingSenderId: AppConstants.firebaseMessagingSenderId,
                appId: AppConstants.firebaseAppId,
              ),
            );
            
            SystemChrome.setSystemUIOverlayStyle(const SystemUiOverlayStyle(statusBarColor: Colors.transparent));
            
            runApp(const ComplianceOSApp());
          }

          class ComplianceOSApp extends StatelessWidget {
            const ComplianceOSApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MultiProvider(
                providers: [
                  ChangeNotifierProvider(create: (_) => AuthProvider()),
                  ChangeNotifierProvider(create: (_) => AppProvider()),
                ],
                child: Consumer<AppProvider>(
                  builder: (context, appProvider, _) {
                    return MaterialApp(
                      title: 'ComplianceOS',
                      debugShowCheckedModeBanner: false,
                      theme: AppTheme.lightTheme,
                      darkTheme: AppTheme.darkTheme,
                      themeMode: appProvider.themeMode,
                      home: Consumer<AuthProvider>(
                        builder: (context, authProvider, _) {
                          return authProvider.isAuthenticated ? const MainShell() : const AuthScreen();
                        },
                      ),
                    );
                  },
                ),
              );
            }
          }
          ''')

          print("\\n‚úÖ All screen files created!")
          PYTHON_SCRIPT

      - name: ‚öôÔ∏è Configure Android
        run: |
          python << 'PYTHON_SCRIPT'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          write_file('flutter_app/android/app/build.gradle', '''
          plugins {
              id "com.android.application"
              id "kotlin-android"
              id "dev.flutter.flutter-gradle-plugin"
          }

          def localProperties = new Properties()
          def localPropertiesFile = rootProject.file('local.properties')
          if (localPropertiesFile.exists()) {
              localPropertiesFile.withReader('UTF-8') { reader -> localProperties.load(reader) }
          }

          def flutterVersionCode = localProperties.getProperty('flutter.versionCode') ?: '1'
          def flutterVersionName = localProperties.getProperty('flutter.versionName') ?: '1.0'

          android {
              namespace "com.complianceos.compliance_os"
              compileSdk 34
              ndkVersion flutter.ndkVersion

              compileOptions {
                  sourceCompatibility JavaVersion.VERSION_1_8
                  targetCompatibility JavaVersion.VERSION_1_8
              }

              kotlinOptions { jvmTarget = '1.8' }
              sourceSets { main.java.srcDirs += 'src/main/kotlin' }

              defaultConfig {
                  applicationId "com.complianceos.compliance_os"
                  minSdkVersion 23
                  targetSdkVersion 34
                  versionCode flutterVersionCode.toInteger()
                  versionName flutterVersionName
                  multiDexEnabled true
              }

              buildTypes {
                  release {
                      signingConfig signingConfigs.debug
                      minifyEnabled true
                      shrinkResources true
                      proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                  }
              }
          }

          flutter { source '../..' }
          dependencies { implementation 'androidx.multidex:multidex:2.0.1' }
          ''')

          write_file('flutter_app/android/app/src/main/AndroidManifest.xml', '''
          <manifest xmlns:android="http://schemas.android.com/apk/res/android">
              <uses-permission android:name="android.permission.INTERNET"/>
              <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>
              <application
                  android:label="ComplianceOS"
                  android:name="${applicationName}"
                  android:icon="@mipmap/ic_launcher"
                  android:usesCleartextTraffic="true">
                  <activity
                      android:name=".MainActivity"
                      android:exported="true"
                      android:launchMode="singleTop"
                      android:theme="@style/LaunchTheme"
                      android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
                      android:hardwareAccelerated="true"
                      android:windowSoftInputMode="adjustResize">
                      <meta-data android:name="io.flutter.embedding.android.NormalTheme" android:resource="@style/NormalTheme"/>
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN"/>
                          <category android:name="android.intent.category.LAUNCHER"/>
                      </intent-filter>
                  </activity>
                  <meta-data android:name="flutterEmbedding" android:value="2"/>
              </application>
          </manifest>
          ''')

          write_file('flutter_app/android/app/proguard-rules.pro', '''
          -keep class io.flutter.** { *; }
          -keep class com.google.firebase.** { *; }
          -dontwarn com.google.firebase.**
          ''')

          print("\\n‚úÖ Android config created!")
          PYTHON_SCRIPT

      - name: üì¶ Install Dependencies
        run: |
          cd flutter_app
          flutter pub get

      - name: üî® Build APK
        run: |
          cd flutter_app
          flutter build apk --release
          cp build/app/outputs/flutter-apk/app-release.apk ../ComplianceOS-release.apk
          ls -lh ../ComplianceOS-release.apk

      - name: üì§ Commit Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add flutter_app/ ComplianceOS-release.apk || true
          git diff --staged --quiet || git commit -m "üöÄ Build: Flutter APK $(date +'%Y-%m-%d %H:%M')"
          git push || true

      - name: üì¶ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ComplianceOS-APK
          path: ComplianceOS-release.apk
          retention-days: 30

      - name: üìä Summary
        run: |
          echo "## ‚úÖ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **APK Size:** $(du -h ComplianceOS-release.apk | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Flutter:** $(flutter --version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì± Features" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Native Flutter UI (Premium Design)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Firebase Auth + Firestore" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Glass morphism effects" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Smooth animations" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Light/Dark theme" >> $GITHUB_STEP_SUMMARY
