name: Build Complete Flutter App

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

env:
  FLUTTER_VERSION: "3.19.0"
  JAVA_VERSION: "17"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Verify Setup
        run: |
          python --version
          flutter --version
          flutter doctor -v

      - name: Create Flutter Project
        run: |
          rm -rf flutter_app
          flutter create --org com.complianceos --project-name compliance_os flutter_app

      - name: Create Directory Structure
        run: |
          mkdir -p flutter_app/lib/config
          mkdir -p flutter_app/lib/models
          mkdir -p flutter_app/lib/services
          mkdir -p flutter_app/lib/providers
          mkdir -p flutter_app/lib/screens
          mkdir -p flutter_app/lib/screens/tabs
          mkdir -p flutter_app/lib/widgets
          mkdir -p flutter_app/lib/utils
          mkdir -p flutter_app/assets/images
          touch flutter_app/assets/images/.gitkeep

      - name: üì¶ Create pubspec.yaml
        run: |
          python3 << 'EOF'
          content = '''name: compliance_os
          description: ComplianceOS - Complete Task Management System
          publish_to: 'none'
          version: 1.0.0+1

          environment:
            sdk: '>=3.0.0 <4.0.0'

          dependencies:
            flutter:
              sdk: flutter
            
            # Firebase
            firebase_core: ^2.27.0
            firebase_auth: ^4.17.8
            cloud_firestore: ^4.15.8
            
            # HTTP & API
            http: ^1.2.0
            
            # State Management
            provider: ^6.1.2
            
            # Storage & Persistence
            shared_preferences: ^2.2.2
            flutter_secure_storage: ^9.0.0
            path_provider: ^2.1.2
            
            # UI Components
            cupertino_icons: ^1.0.6
            google_fonts: ^6.1.0
            shimmer: ^3.0.0
            flutter_animate: ^4.5.0
            
            # Date & Calendar
            intl: ^0.19.0
            table_calendar: ^3.0.9
            
            # File Handling
            file_picker: ^6.2.0
            open_filex: ^4.4.0
            
            # URL & Links
            url_launcher: ^6.2.5

          dev_dependencies:
            flutter_test:
              sdk: flutter
            flutter_lints: ^3.0.0

          flutter:
            uses-material-design: true
            assets:
              - assets/images/
          '''
          with open('flutter_app/pubspec.yaml', 'w') as f:
              f.write(content.strip())
          print("‚úÖ pubspec.yaml created")
          EOF

      - name: ‚öôÔ∏è Create Config Files
        run: |
          python3 << 'EOF'
          import os

          def write_file(path, content):
            os.makedirs(os.path.dirname(path), exist_ok=True)
            with open(path, 'w', encoding='utf-8') as f:
              f.write(content.strip() + '\n')
            print(f"Created: {path}")

          # constants.dart
          write_file('flutter_app/lib/config/constants.dart', '''
          class AppConstants {
            static const String backendBaseUrl = "https://lease-moore-others-montreal.trycloudflare.com/.netlify/functions";
            static const String timezone = "Asia/Kolkata";
            
            // Firebase Config
            static const String firebaseApiKey = "AIzaSyCnWS-V96J6YDBVYKOeL5p8aa45GPTdSEg";
            static const String firebaseAuthDomain = "compliance-management-484405.firebaseapp.com";
            static const String firebaseProjectId = "compliance-management-484405";
            static const String firebaseStorageBucket = "compliance-management-484405.firebasestorage.app";
            static const String firebaseMessagingSenderId = "4348274796";
            static const String firebaseAppId = "1:4348274796:web:a9e1720c2ae223035bd049";
            
            // Roles
            static const String rolePartner = 'PARTNER';
            static const String roleManager = 'MANAGER';
            static const String roleAssociate = 'ASSOCIATE';
            
            // Task Statuses
            static const List<String> taskStatuses = [
              'PENDING',
              'IN_PROGRESS',
              'CLIENT_PENDING',
              'APPROVAL_PENDING',
              'COMPLETED',
            ];
            
            // Categories
            static const List<String> categories = [
              'GST',
              'TDS',
              'INCOME_TAX',
              'ROC',
              'ACCOUNTING',
              'AUDIT',
              'OTHER',
            ];
            
            // Priorities
            static const List<String> priorities = ['HIGH', 'MEDIUM', 'LOW'];
            
            // Recurrence Types
            static const List<String> recurrenceTypes = [
              'AD_HOC',
              'DAILY',
              'WEEKLY',
              'BIWEEKLY',
              'MONTHLY',
              'BIMONTHLY',
              'QUARTERLY',
              'HALF_YEARLY',
              'YEARLY',
            ];
            
            // Work Queue Modes
            static const List<String> workQueueModes = [
              'ACTIVE',
              'ALL',
              'SNOOZED',
              'APPROVAL',
              'COMPLETED',
            ];
            
            // Template Variables
            static const List<Map<String, String>> templateVariables = [
              {'name': 'Client Name', 'key': '{{clientName}}', 'desc': 'Client name'},
              {'name': 'Task Title', 'key': '{{taskTitle}}', 'desc': 'Task title'},
              {'name': 'Start Date', 'key': '{{startDate}}', 'desc': 'Start date (DD-MM-YYYY)'},
              {'name': 'Due Date', 'key': '{{dueDate}}', 'desc': 'Due date (DD-MM-YYYY)'},
              {'name': 'Calendar Link', 'key': '{{addToCalendarUrl}}', 'desc': 'Google Calendar link'},
              {'name': 'Completed At', 'key': '{{completedAt}}', 'desc': 'Completion time in IST'},
            ];
          }
          ''')

          # theme.dart
          write_file('flutter_app/lib/config/theme.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';

          class AppTheme {
            // Premium Color Palette
            static const Color primary = Color(0xFF0A84FF);
            static const Color primaryDark = Color(0xFF0066CC);
            static const Color accent = Color(0xFF5AC8FA);
            static const Color success = Color(0xFF34C759);
            static const Color warning = Color(0xFFFFCC00);
            static const Color danger = Color(0xFFFF3B30);
            static const Color purple = Color(0xFFAF52DE);
            static const Color pink = Color(0xFFFF2D55);
            static const Color teal = Color(0xFF5AC8FA);
            static const Color orange = Color(0xFFFF9500);
            static const Color gray = Color(0xFF8E8E93);
            
            static const LinearGradient primaryGradient = LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [Color(0xFF0A84FF), Color(0xFF5AC8FA), Color(0xFF64D2FF)],
            );

            // Category Colors
            static const Map<String, Color> categoryColors = {
              'GST': Color(0xFF34C759),
              'TDS': Color(0xFF007AFF),
              'INCOME_TAX': Color(0xFFAF52DE),
              'ROC': Color(0xFFFF9500),
              'ACCOUNTING': Color(0xFF5AC8FA),
              'AUDIT': Color(0xFFFF3B30),
              'OTHER': Color(0xFF8E8E93),
            };

            // Priority Colors
            static const Map<String, Color> priorityColors = {
              'HIGH': Color(0xFFFF3B30),
              'MEDIUM': Color(0xFFFF9500),
              'LOW': Color(0xFF34C759),
            };

            // View Accent Colors
            static const Map<String, Color> viewAccents = {
              'home': Color(0xFF0EA5E9),
              'work': Color(0xFF8B5CF6),
              'calendar': Color(0xFFF97316),
              'clients': Color(0xFF22C55E),
              'studio': Color(0xFF06B6D4),
              'ops': Color(0xFFEF4444),
              'help': Color(0xFFA855F7),
            };

            static ThemeData lightTheme = ThemeData(
              useMaterial3: true,
              brightness: Brightness.light,
              primaryColor: primary,
              scaffoldBackgroundColor: const Color(0xFFF2F2F7),
              colorScheme: ColorScheme.fromSeed(
                seedColor: primary,
                brightness: Brightness.light,
                surface: Colors.white,
              ),
              textTheme: GoogleFonts.interTextTheme().copyWith(
                displayLarge: GoogleFonts.inter(fontWeight: FontWeight.w900, letterSpacing: -1.5, color: Colors.black),
                headlineLarge: GoogleFonts.inter(fontWeight: FontWeight.w800, color: Colors.black),
                titleLarge: GoogleFonts.inter(fontWeight: FontWeight.w700, color: Colors.black),
                bodyLarge: GoogleFonts.inter(fontWeight: FontWeight.w500, color: Colors.black87),
                bodyMedium: GoogleFonts.inter(fontWeight: FontWeight.w500, color: Colors.black87),
                labelLarge: GoogleFonts.inter(fontWeight: FontWeight.w700, color: Colors.black),
              ),
              appBarTheme: AppBarTheme(
                elevation: 0,
                scrolledUnderElevation: 0,
                backgroundColor: Colors.white.withOpacity(0.9),
                surfaceTintColor: Colors.transparent,
                titleTextStyle: GoogleFonts.inter(fontSize: 17, fontWeight: FontWeight.w700, color: Colors.black),
                iconTheme: const IconThemeData(color: Colors.black87),
              ),
              cardTheme: CardTheme(
                elevation: 0,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                color: Colors.white,
              ),
              elevatedButtonTheme: ElevatedButtonThemeData(
                style: ElevatedButton.styleFrom(
                  elevation: 0,
                  backgroundColor: primary,
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  textStyle: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 15),
                ),
              ),
              outlinedButtonTheme: OutlinedButtonThemeData(
                style: OutlinedButton.styleFrom(
                  foregroundColor: primary,
                  side: BorderSide(color: primary.withOpacity(0.3)),
                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  textStyle: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 15),
                ),
              ),
              textButtonTheme: TextButtonThemeData(
                style: TextButton.styleFrom(
                  foregroundColor: primary,
                  textStyle: GoogleFonts.inter(fontWeight: FontWeight.w600),
                ),
              ),
              inputDecorationTheme: InputDecorationTheme(
                filled: true,
                fillColor: const Color(0xFFF2F2F7),
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(14), borderSide: BorderSide.none),
                enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(14), borderSide: BorderSide.none),
                focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(14), borderSide: const BorderSide(color: primary, width: 2)),
                errorBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(14), borderSide: const BorderSide(color: danger)),
                contentPadding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                hintStyle: GoogleFonts.inter(color: gray, fontWeight: FontWeight.w500),
                labelStyle: GoogleFonts.inter(color: gray, fontWeight: FontWeight.w600),
              ),
              chipTheme: ChipThemeData(
                backgroundColor: const Color(0xFFF2F2F7),
                labelStyle: GoogleFonts.inter(fontWeight: FontWeight.w600, fontSize: 13),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                side: BorderSide.none,
                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              ),
              bottomSheetTheme: const BottomSheetThemeData(
                backgroundColor: Colors.white,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.vertical(top: Radius.circular(28))),
              ),
              dialogTheme: DialogTheme(
                backgroundColor: Colors.white,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(28)),
              ),
              snackBarTheme: SnackBarThemeData(
                backgroundColor: const Color(0xFF1C1C1E),
                contentTextStyle: GoogleFonts.inter(color: Colors.white, fontWeight: FontWeight.w600),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                behavior: SnackBarBehavior.floating,
              ),
              dividerTheme: const DividerThemeData(color: Color(0xFFE5E5EA), thickness: 0.5),
              listTileTheme: ListTileThemeData(
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
              ),
              switchTheme: SwitchThemeData(
                thumbColor: WidgetStateProperty.resolveWith((states) {
                  if (states.contains(WidgetState.selected)) return primary;
                  return Colors.white;
                }),
                trackColor: WidgetStateProperty.resolveWith((states) {
                  if (states.contains(WidgetState.selected)) return primary.withOpacity(0.5);
                  return const Color(0xFFE5E5EA);
                }),
              ),
              tabBarTheme: TabBarTheme(
                labelColor: primary,
                unselectedLabelColor: gray,
                labelStyle: GoogleFonts.inter(fontWeight: FontWeight.w700),
                unselectedLabelStyle: GoogleFonts.inter(fontWeight: FontWeight.w600),
                indicator: UnderlineTabIndicator(borderSide: BorderSide(color: primary, width: 3)),
              ),
            );

            static ThemeData darkTheme = ThemeData(
              useMaterial3: true,
              brightness: Brightness.dark,
              primaryColor: primary,
              scaffoldBackgroundColor: const Color(0xFF000000),
              colorScheme: ColorScheme.fromSeed(
                seedColor: primary,
                brightness: Brightness.dark,
                surface: const Color(0xFF1C1C1E),
              ),
              textTheme: GoogleFonts.interTextTheme(ThemeData.dark().textTheme).copyWith(
                displayLarge: GoogleFonts.inter(fontWeight: FontWeight.w900, letterSpacing: -1.5, color: Colors.white),
                headlineLarge: GoogleFonts.inter(fontWeight: FontWeight.w800, color: Colors.white),
                titleLarge: GoogleFonts.inter(fontWeight: FontWeight.w700, color: Colors.white),
                bodyLarge: GoogleFonts.inter(fontWeight: FontWeight.w500, color: Colors.white),
                bodyMedium: GoogleFonts.inter(fontWeight: FontWeight.w500, color: Colors.white70),
                labelLarge: GoogleFonts.inter(fontWeight: FontWeight.w700, color: Colors.white),
              ),
              appBarTheme: AppBarTheme(
                elevation: 0,
                scrolledUnderElevation: 0,
                backgroundColor: const Color(0xFF1C1C1E).withOpacity(0.9),
                surfaceTintColor: Colors.transparent,
                titleTextStyle: GoogleFonts.inter(fontSize: 17, fontWeight: FontWeight.w700, color: Colors.white),
                iconTheme: const IconThemeData(color: Colors.white),
              ),
              cardTheme: CardTheme(
                elevation: 0,
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                color: const Color(0xFF1C1C1E),
              ),
              elevatedButtonTheme: ElevatedButtonThemeData(
                style: ElevatedButton.styleFrom(
                  elevation: 0,
                  backgroundColor: primary,
                  foregroundColor: Colors.white,
                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  textStyle: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 15),
                ),
              ),
              outlinedButtonTheme: OutlinedButtonThemeData(
                style: OutlinedButton.styleFrom(
                  foregroundColor: Colors.white,
                  side: BorderSide(color: Colors.white.withOpacity(0.2)),
                  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 14),
                  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                  textStyle: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 15),
                ),
              ),
              textButtonTheme: TextButtonThemeData(
                style: TextButton.styleFrom(
                  foregroundColor: primary,
                  textStyle: GoogleFonts.inter(fontWeight: FontWeight.w600),
                ),
              ),
              inputDecorationTheme: InputDecorationTheme(
                filled: true,
                fillColor: const Color(0xFF2C2C2E),
                border: OutlineInputBorder(borderRadius: BorderRadius.circular(14), borderSide: BorderSide.none),
                enabledBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(14), borderSide: BorderSide.none),
                focusedBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(14), borderSide: const BorderSide(color: primary, width: 2)),
                errorBorder: OutlineInputBorder(borderRadius: BorderRadius.circular(14), borderSide: const BorderSide(color: danger)),
                contentPadding: const EdgeInsets.symmetric(horizontal: 20, vertical: 16),
                hintStyle: GoogleFonts.inter(color: gray, fontWeight: FontWeight.w500),
                labelStyle: GoogleFonts.inter(color: gray, fontWeight: FontWeight.w600),
              ),
              chipTheme: ChipThemeData(
                backgroundColor: const Color(0xFF2C2C2E),
                labelStyle: GoogleFonts.inter(fontWeight: FontWeight.w600, fontSize: 13, color: Colors.white),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(10)),
                side: BorderSide.none,
                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              ),
              bottomSheetTheme: const BottomSheetThemeData(
                backgroundColor: Color(0xFF1C1C1E),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.vertical(top: Radius.circular(28))),
              ),
              dialogTheme: DialogTheme(
                backgroundColor: const Color(0xFF1C1C1E),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(28)),
              ),
              snackBarTheme: SnackBarThemeData(
                backgroundColor: const Color(0xFF2C2C2E),
                contentTextStyle: GoogleFonts.inter(color: Colors.white, fontWeight: FontWeight.w600),
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                behavior: SnackBarBehavior.floating,
              ),
              dividerTheme: const DividerThemeData(color: Color(0xFF38383A), thickness: 0.5),
              listTileTheme: ListTileThemeData(
                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(12)),
                contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 4),
              ),
              switchTheme: SwitchThemeData(
                thumbColor: WidgetStateProperty.resolveWith((states) {
                  if (states.contains(WidgetState.selected)) return primary;
                  return Colors.white;
                }),
                trackColor: WidgetStateProperty.resolveWith((states) {
                  if (states.contains(WidgetState.selected)) return primary.withOpacity(0.5);
                  return const Color(0xFF38383A);
                }),
              ),
              tabBarTheme: TabBarTheme(
                labelColor: primary,
                unselectedLabelColor: gray,
                labelStyle: GoogleFonts.inter(fontWeight: FontWeight.w700),
                unselectedLabelStyle: GoogleFonts.inter(fontWeight: FontWeight.w600),
                indicator: UnderlineTabIndicator(borderSide: BorderSide(color: primary, width: 3)),
              ),
            );
          }
          ''')
          EOF

      - name: üìä Create Models
        run: |
          python3 << 'EOF'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          # user_model.dart
          write_file('flutter_app/lib/models/user_model.dart', '''
          class UserModel {
            final String uid;
            final String email;
            final String displayName;
            final String role;
            final bool active;
            final String? managerEmail;

            UserModel({
              required this.uid,
              required this.email,
              required this.displayName,
              required this.role,
              this.active = true,
              this.managerEmail,
            });

            bool get isPartner => role.toUpperCase() == 'PARTNER';
            bool get isManager => role.toUpperCase() == 'MANAGER';
            bool get isAssociate => role.toUpperCase() == 'ASSOCIATE';
            bool get canSeeAllTasks => isPartner || isManager;
            bool get canEditDetails => isPartner || isManager;
            bool get canAccessClients => isPartner;
            bool get canAccessOps => isPartner || isManager;

            factory UserModel.fromJson(Map<String, dynamic> json) {
              String normalizedRole = (json['role'] ?? 'ASSOCIATE').toString().toUpperCase().trim();
              if (normalizedRole.isEmpty || normalizedRole == 'WORKER') {
                normalizedRole = 'ASSOCIATE';
              }
              return UserModel(
                uid: json['uid'] ?? '',
                email: json['email'] ?? '',
                displayName: json['displayName'] ?? '',
                role: normalizedRole,
                active: json['active'] ?? true,
                managerEmail: json['managerEmail'],
              );
            }

            Map<String, dynamic> toJson() => {
              'uid': uid,
              'email': email,
              'displayName': displayName,
              'role': role,
              'active': active,
              'managerEmail': managerEmail,
            };
          }
          ''')

          # task_model.dart
          write_file('flutter_app/lib/models/task_model.dart', '''
          class TaskModel {
            final String id;
            final String? clientId;
            final String? clientName;
            final String title;
            final String? type;
            final String? category;
            final String? priority;
            final String? status;
            final String? statusNote;
            final String? delayReason;
            final String? delayNotes;
            final String? startDateYmd;
            final String? dueDateYmd;
            final String? snoozedUntilYmd;
            final String? assignedToEmail;
            final String? assignedToUid;
            final String? seriesId;
            final int? triggerDaysBefore;
            final bool sendClientStartMail;
            final bool sendClientCompletionMail;
            final bool clientStartMailSent;
            final String? clientStartGmailThreadId;
            final String? calendarHtmlLink;
            final List<String>? clientToEmails;
            final List<String>? clientCcEmails;
            final List<String>? clientBccEmails;
            final String? clientStartSubject;
            final String? clientStartBody;
            final String? clientCompletionSubject;
            final String? clientCompletionBody;
            final bool ccAssigneeOnClientStart;
            final bool ccManagerOnClientStart;
            final bool ccAssigneeOnCompletion;
            final bool ccManagerOnCompletion;
            final List<Map<String, dynamic>> attachments;

            TaskModel({
              required this.id,
              this.clientId,
              this.clientName,
              required this.title,
              this.type,
              this.category,
              this.priority,
              this.status,
              this.statusNote,
              this.delayReason,
              this.delayNotes,
              this.startDateYmd,
              this.dueDateYmd,
              this.snoozedUntilYmd,
              this.assignedToEmail,
              this.assignedToUid,
              this.seriesId,
              this.triggerDaysBefore,
              this.sendClientStartMail = true,
              this.sendClientCompletionMail = true,
              this.clientStartMailSent = false,
              this.clientStartGmailThreadId,
              this.calendarHtmlLink,
              this.clientToEmails,
              this.clientCcEmails,
              this.clientBccEmails,
              this.clientStartSubject,
              this.clientStartBody,
              this.clientCompletionSubject,
              this.clientCompletionBody,
              this.ccAssigneeOnClientStart = false,
              this.ccManagerOnClientStart = false,
              this.ccAssigneeOnCompletion = false,
              this.ccManagerOnCompletion = false,
              this.attachments = const [],
            });

            bool get isCompleted => status == 'COMPLETED';
            bool get hasSeries => seriesId != null && seriesId!.isNotEmpty;

            String get normalizedCategory {
              final u = (category ?? '').toUpperCase().replaceAll(' ', '_');
              if (u == 'INCOME_TAX' || u == 'INCOME_TAX_RETURN' || u == 'INCOME') return 'INCOME_TAX';
              if (['GST', 'TDS', 'ROC', 'ACCOUNTING', 'AUDIT'].contains(u)) return u;
              return 'OTHER';
            }

            String get normalizedPriority => (priority ?? 'MEDIUM').toUpperCase();

            factory TaskModel.fromJson(Map<String, dynamic> json, String id) {
              return TaskModel(
                id: id,
                clientId: json['clientId'],
                clientName: json['clientName'],
                title: json['title'] ?? '',
                type: json['type'],
                category: json['category'],
                priority: json['priority'] ?? 'MEDIUM',
                status: json['status'] ?? 'PENDING',
                statusNote: json['statusNote'],
                delayReason: json['delayReason'],
                delayNotes: json['delayNotes'],
                startDateYmd: json['startDateYmd'],
                dueDateYmd: json['dueDateYmd'],
                snoozedUntilYmd: json['snoozedUntilYmd'],
                assignedToEmail: json['assignedToEmail'],
                assignedToUid: json['assignedToUid'],
                seriesId: json['seriesId'],
                triggerDaysBefore: json['triggerDaysBefore'],
                sendClientStartMail: json['sendClientStartMail'] ?? true,
                sendClientCompletionMail: json['sendClientCompletionMail'] ?? true,
                clientStartMailSent: json['clientStartMailSent'] ?? false,
                clientStartGmailThreadId: json['clientStartGmailThreadId'],
                calendarHtmlLink: json['calendarHtmlLink'],
                clientToEmails: json['clientToEmails'] != null ? List<String>.from(json['clientToEmails']) : null,
                clientCcEmails: json['clientCcEmails'] != null ? List<String>.from(json['clientCcEmails']) : null,
                clientBccEmails: json['clientBccEmails'] != null ? List<String>.from(json['clientBccEmails']) : null,
                clientStartSubject: json['clientStartSubject'],
                clientStartBody: json['clientStartBody'],
                clientCompletionSubject: json['clientCompletionSubject'],
                clientCompletionBody: json['clientCompletionBody'],
                ccAssigneeOnClientStart: json['ccAssigneeOnClientStart'] ?? false,
                ccManagerOnClientStart: json['ccManagerOnClientStart'] ?? false,
                ccAssigneeOnCompletion: json['ccAssigneeOnCompletion'] ?? false,
                ccManagerOnCompletion: json['ccManagerOnCompletion'] ?? false,
                attachments: json['attachments'] != null ? List<Map<String, dynamic>>.from(json['attachments']) : [],
              );
            }

            Map<String, dynamic> toJson() => {
              'clientId': clientId,
              'clientName': clientName,
              'title': title,
              'type': type,
              'category': category,
              'priority': priority,
              'status': status,
              'statusNote': statusNote,
              'delayReason': delayReason,
              'delayNotes': delayNotes,
              'startDateYmd': startDateYmd,
              'dueDateYmd': dueDateYmd,
              'snoozedUntilYmd': snoozedUntilYmd,
              'assignedToEmail': assignedToEmail,
              'assignedToUid': assignedToUid,
              'seriesId': seriesId,
              'triggerDaysBefore': triggerDaysBefore,
              'sendClientStartMail': sendClientStartMail,
              'sendClientCompletionMail': sendClientCompletionMail,
            };
          }
          ''')

          # client_model.dart
          write_file('flutter_app/lib/models/client_model.dart', '''
          class ClientModel {
            final String id;
            final String name;
            final String? pan;
            final String? gstin;
            final String? cin;
            final String? assessmentYear;
            final String? engagementType;
            final String? primaryEmail;
            final List<String> ccEmails;
            final List<String> bccEmails;

            ClientModel({
              required this.id,
              required this.name,
              this.pan,
              this.gstin,
              this.cin,
              this.assessmentYear,
              this.engagementType,
              this.primaryEmail,
              this.ccEmails = const [],
              this.bccEmails = const [],
            });

            factory ClientModel.fromJson(Map<String, dynamic> json, String id) {
              return ClientModel(
                id: id,
                name: json['name'] ?? '',
                pan: json['pan'],
                gstin: json['gstin'],
                cin: json['cin'],
                assessmentYear: json['assessmentYear'],
                engagementType: json['engagementType'],
                primaryEmail: json['primaryEmail'],
                ccEmails: json['ccEmails'] != null ? List<String>.from(json['ccEmails']) : [],
                bccEmails: json['bccEmails'] != null ? List<String>.from(json['bccEmails']) : [],
              );
            }

            Map<String, dynamic> toJson() => {
              'name': name,
              'pan': pan,
              'gstin': gstin,
              'cin': cin,
              'assessmentYear': assessmentYear,
              'engagementType': engagementType,
              'primaryEmail': primaryEmail,
              'ccEmails': ccEmails,
              'bccEmails': bccEmails,
            };
          }
          ''')

          # comment_model.dart
          write_file('flutter_app/lib/models/comment_model.dart', '''
          import 'package:cloud_firestore/cloud_firestore.dart';

          class CommentModel {
            final String id;
            final String text;
            final String authorEmail;
            final String? authorName;
            final DateTime createdAt;

            CommentModel({
              required this.id,
              required this.text,
              required this.authorEmail,
              this.authorName,
              required this.createdAt,
            });

            factory CommentModel.fromJson(Map<String, dynamic> json, String id) {
              DateTime created = DateTime.now();
              if (json['createdAt'] is Timestamp) {
                created = (json['createdAt'] as Timestamp).toDate();
              }
              return CommentModel(
                id: id,
                text: json['text'] ?? '',
                authorEmail: json['authorEmail'] ?? '',
                authorName: json['authorName'],
                createdAt: created,
              );
            }
          }
          ''')

          # audit_log_model.dart
          write_file('flutter_app/lib/models/audit_log_model.dart', '''
          import 'package:cloud_firestore/cloud_firestore.dart';

          class AuditLogModel {
            final String id;
            final String? taskId;
            final String action;
            final String? actorEmail;
            final Map<String, dynamic> details;
            final DateTime timestamp;

            AuditLogModel({
              required this.id,
              this.taskId,
              required this.action,
              this.actorEmail,
              this.details = const {},
              required this.timestamp,
            });

            factory AuditLogModel.fromJson(Map<String, dynamic> json, String id) {
              DateTime ts = DateTime.now();
              if (json['timestamp'] is Timestamp) {
                ts = (json['timestamp'] as Timestamp).toDate();
              }
              return AuditLogModel(
                id: id,
                taskId: json['taskId'],
                action: json['action'] ?? '',
                actorEmail: json['actorEmail'],
                details: json['details'] != null ? Map<String, dynamic>.from(json['details']) : {},
                timestamp: ts,
              );
            }
          }
          ''')
          EOF

      - name: üõ†Ô∏è Create Utils
        run: |
          python3 << 'EOF'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          # date_utils.dart
          write_file('flutter_app/lib/utils/date_utils.dart', '''
          import 'package:intl/intl.dart';

          class AppDateUtils {
            static const String timezone = 'Asia/Kolkata';

            static String todayYmd() {
              return DateFormat('yyyy-MM-dd').format(DateTime.now());
            }

            static String ymdToDmy(String? ymd) {
              if (ymd == null || ymd.isEmpty) return '';
              try {
                final date = DateTime.parse(ymd);
                return DateFormat('dd-MM-yyyy').format(date);
              } catch (_) {
                return '';
              }
            }

            static String dmyToYmd(String dmy) {
              final pattern = RegExp(r'^(\\d{2})-(\\d{2})-(\\d{4})$');
              final match = pattern.firstMatch(dmy.trim());
              if (match == null) throw FormatException('Invalid date format. Use DD-MM-YYYY');
              return '\${match.group(3)}-\${match.group(2)}-\${match.group(1)}';
            }

            static int diffDays(String fromYmd, String toYmd) {
              try {
                final from = DateTime.parse(fromYmd);
                final to = DateTime.parse(toYmd);
                return to.difference(from).inDays;
              } catch (_) {
                return 0;
              }
            }

            static String formatDateTime(DateTime dt) {
              return DateFormat('dd MMM yyyy, HH:mm').format(dt);
            }

            static String formatDate(DateTime dt) {
              return DateFormat('dd-MM-yyyy').format(dt);
            }

            static String formatDateShort(DateTime dt) {
              return DateFormat('dd MMM').format(dt);
            }

            static DateTime parseYmd(String ymd) {
              return DateTime.parse(ymd);
            }

            static DateTime? tryParseYmd(String? ymd) {
              if (ymd == null || ymd.isEmpty) return null;
              try {
                return DateTime.parse(ymd);
              } catch (_) {
                return null;
              }
            }

            static String monthLabel(DateTime date) {
              return DateFormat('MMMM yyyy').format(date);
            }

            static String dayOfWeekShort(DateTime date) {
              return DateFormat('EEE').format(date);
            }

            static bool isSameDay(DateTime a, DateTime b) {
              return a.year == b.year && a.month == b.month && a.day == b.day;
            }

            static DateTime startOfMonth(DateTime date) {
              return DateTime(date.year, date.month, 1);
            }

            static DateTime endOfMonth(DateTime date) {
              return DateTime(date.year, date.month + 1, 0);
            }

            static DateTime startOfWeek(DateTime date) {
              final weekday = date.weekday;
              return date.subtract(Duration(days: weekday - 1));
            }

            static List<DateTime> getDaysInMonth(DateTime month) {
              final first = startOfMonth(month);
              final last = endOfMonth(month);
              return List.generate(
                last.day,
                (index) => DateTime(first.year, first.month, index + 1),
              );
            }

            static String getRelativeDate(String? ymd) {
              if (ymd == null || ymd.isEmpty) return '';
              final today = todayYmd();
              final diff = diffDays(today, ymd);
              
              if (diff == 0) return 'Today';
              if (diff == 1) return 'Tomorrow';
              if (diff == -1) return 'Yesterday';
              if (diff > 0 && diff <= 7) return 'In \$diff days';
              if (diff < 0 && diff >= -7) return '\${-diff} days ago';
              
              return ymdToDmy(ymd);
            }
          }
          ''')

          # helpers.dart
          write_file('flutter_app/lib/utils/helpers.dart', '''
          import 'dart:convert';
          import 'dart:io';
          import 'package:flutter/material.dart';
          import 'package:flutter/services.dart';
          import 'package:path_provider/path_provider.dart';
          import 'package:open_filex/open_filex.dart';
          import '../config/theme.dart';

          class Helpers {
            static void showSnackBar(BuildContext context, String message, {bool isError = false, bool isSuccess = false, int durationSeconds = 3}) {
              ScaffoldMessenger.of(context).hideCurrentSnackBar();
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text(message),
                  backgroundColor: isError ? AppTheme.danger : (isSuccess ? AppTheme.success : null),
                  behavior: SnackBarBehavior.floating,
                  duration: Duration(seconds: isError ? 5 : durationSeconds),
                  action: SnackBarAction(
                    label: 'OK',
                    textColor: Colors.white,
                    onPressed: () => ScaffoldMessenger.of(context).hideCurrentSnackBar(),
                  ),
                ),
              );
            }

            static Future<void> downloadBase64File({
              required BuildContext context,
              required String base64Data,
              required String fileName,
              String? mimeType,
            }) async {
              try {
                final bytes = base64Decode(base64Data);
                final dir = await getApplicationDocumentsDirectory();
                final file = File('\${dir.path}/\$fileName');
                await file.writeAsBytes(bytes);
                
                await OpenFilex.open(file.path);
                
                if (context.mounted) {
                  showSnackBar(context, 'File saved: \$fileName', isSuccess: true);
                }
              } catch (e) {
                if (context.mounted) {
                  showSnackBar(context, 'Download failed: \$e', isError: true);
                }
              }
            }

            static Future<void> copyToClipboard(BuildContext context, String text, {String? successMessage}) async {
              await Clipboard.setData(ClipboardData(text: text));
              if (context.mounted) {
                showSnackBar(context, successMessage ?? 'Copied to clipboard', isSuccess: true, durationSeconds: 2);
              }
            }

            static List<String> parseEmailList(String? input) {
              if (input == null || input.isEmpty) return [];
              return input
                  .split(RegExp(r'[;,:]'))
                  .map((e) => e.trim())
                  .where((e) => e.isNotEmpty && e.contains('@'))
                  .toList();
            }

            static String joinEmails(List<String>? emails) {
              if (emails == null || emails.isEmpty) return '';
              return emails.join('; ');
            }

            static String truncate(String text, int maxLength) {
              if (text.length <= maxLength) return text;
              return '\${text.substring(0, maxLength)}...';
            }

            static Color getCategoryColor(String? category) {
              final normalized = (category ?? 'OTHER').toUpperCase().replaceAll(' ', '_');
              return AppTheme.categoryColors[normalized] ?? AppTheme.gray;
            }

            static Color getPriorityColor(String? priority) {
              final normalized = (priority ?? 'MEDIUM').toUpperCase();
              return AppTheme.priorityColors[normalized] ?? AppTheme.orange;
            }

            static String replaceTemplateVariables(String template, Map<String, String> variables) {
              String result = template;
              variables.forEach((key, value) {
                result = result.replaceAll('{{\$key}}', value);
              });
              return result;
            }

            static String tokensToRealLines(String s) => s.replaceAll('\\\\n', '\\n');
            static String realLinesToTokens(String s) => s.replaceAll('\\n', '\\\\n');
          }
          ''')
          EOF

      - name: üåê Create API Service
        run: |
          python3 << 'EOF'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          write_file('flutter_app/lib/services/api_service.dart', '''
          import 'dart:convert';
          import 'dart:typed_data';
          import 'package:http/http.dart' as http;
          import 'package:firebase_auth/firebase_auth.dart';
          import '../config/constants.dart';

          class ApiResponse {
            final bool ok;
            final dynamic data;
            final String? error;
            final int statusCode;

            ApiResponse({required this.ok, this.data, this.error, required this.statusCode});

            T? get<T>(String key) {
              if (data is Map) {
                return data[key] as T?;
              }
              return null;
            }
          }

          class ApiService {
            static final ApiService _instance = ApiService._internal();
            factory ApiService() => _instance;
            ApiService._internal();

            final String _baseUrl = AppConstants.backendBaseUrl;

            Future<String?> _getToken() async {
              final user = FirebaseAuth.instance.currentUser;
              if (user == null) return null;
              return await user.getIdToken();
            }

            Future<ApiResponse> post(String endpoint, Map<String, dynamic> body) async {
              try {
                final token = await _getToken();
                if (token == null) {
                  return ApiResponse(ok: false, error: 'Not signed in', statusCode: 401);
                }

                final response = await http.post(
                  Uri.parse('\$_baseUrl\$endpoint'),
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer \$token',
                  },
                  body: jsonEncode(body),
                ).timeout(const Duration(seconds: 30));

                dynamic data;
                try {
                  data = jsonDecode(response.body);
                } catch (_) {
                  data = {'raw': response.body};
                }

                final bool isOk = (data is Map && data['ok'] == true) || response.statusCode == 200;
                return ApiResponse(
                  ok: isOk,
                  data: data,
                  error: data is Map ? data['error']?.toString() : null,
                  statusCode: response.statusCode,
                );
              } catch (e) {
                return ApiResponse(ok: false, error: e.toString(), statusCode: 0);
              }
            }

            Future<ApiResponse> uploadFile(String endpoint, Uint8List fileBytes, String fileName, Map<String, String> fields) async {
              try {
                final token = await _getToken();
                if (token == null) {
                  return ApiResponse(ok: false, error: 'Not signed in', statusCode: 401);
                }

                final request = http.MultipartRequest('POST', Uri.parse('\$_baseUrl\$endpoint'));
                request.headers['Authorization'] = 'Bearer \$token';
                fields.forEach((key, value) => request.fields[key] = value);
                request.files.add(http.MultipartFile.fromBytes('file', fileBytes, filename: fileName));

                final streamedResponse = await request.send().timeout(const Duration(seconds: 60));
                final response = await http.Response.fromStream(streamedResponse);

                dynamic data;
                try {
                  data = jsonDecode(response.body);
                } catch (_) {
                  data = {'raw': response.body};
                }

                final bool isOk = (data is Map && data['ok'] == true) || response.statusCode == 200;
                return ApiResponse(ok: isOk, data: data, error: data is Map ? data['error']?.toString() : null, statusCode: response.statusCode);
              } catch (e) {
                return ApiResponse(ok: false, error: e.toString(), statusCode: 0);
              }
            }

            // ==================== AUTH ====================
            Future<ApiResponse> initSelf({String? displayName}) => post('/users_initself', {'displayName': displayName ?? ''});

            // ==================== TASKS ====================
            Future<ApiResponse> createTask(Map<String, dynamic> taskData) => post('/tasks_createone', taskData);

            Future<ApiResponse> updateTaskStatus({
              required String taskId,
              required String newStatus,
              String? statusNote,
              String? delayReason,
              String? delayNotes,
            }) => post('/tasks_updatestatus', {
              'taskId': taskId,
              'newStatus': newStatus,
              'statusNote': statusNote,
              'delayReason': delayReason,
              'delayNotes': delayNotes,
            });

            Future<ApiResponse> updateTask(Map<String, dynamic> taskData) => post('/tasks_updatetask', taskData);

            Future<ApiResponse> deleteTask(String taskId, {bool applyToSeries = false}) => post('/tasks_delete', {
              'taskId': taskId,
              'applyToSeries': applyToSeries,
            });

            Future<ApiResponse> addComment(String taskId, String text) => post('/tasks_addcomment', {
              'taskId': taskId,
              'text': text,
            });

            Future<ApiResponse> bulkUpdate({
              required List<String> taskIds,
              required String op,
              Map<String, dynamic>? payload,
            }) => post('/tasks_bulkUpdate', {
              'taskIds': taskIds,
              'op': op,
              ...?payload,
            });

            // ==================== SERIES ====================
            Future<ApiResponse> rebuildSeries({required String seriesId, required int addCount}) => post('/series_rebuild', {
              'seriesId': seriesId,
              'addCount': addCount,
            });

            Future<ApiResponse> reassignSeries({required String seriesId, required String assignedToEmail}) => post('/series_reassign', {
              'seriesId': seriesId,
              'assignedToEmail': assignedToEmail,
            });

            // ==================== CLIENTS ====================
            Future<ApiResponse> createClient(Map<String, dynamic> clientData) => post('/clients_create', clientData);
            Future<ApiResponse> updateClient(Map<String, dynamic> clientData) => post('/clients_update', clientData);

            // ==================== EXPORTS ====================
            Future<ApiResponse> exportFirmRangeXlsx({required String fromDmy, required String toDmy, bool includeAudit = true}) => post('/exports_firmRangeWithHistoryXlsx', {
              'fromDmy': fromDmy,
              'toDmy': toDmy,
              'includeAudit': includeAudit,
            });

            Future<ApiResponse> exportClientHistoryXlsx({required String clientId, required String fromYmd, required String toYmd}) => post('/exports_clientHistoryXlsx', {
              'clientId': clientId,
              'fromYmd': fromYmd,
              'toYmd': toYmd,
            });

            Future<ApiResponse> exportTaskHistoryXlsx(String taskId) => post('/exports_taskHistoryXlsx', {'taskId': taskId});

            Future<ApiResponse> quickExport(String mode) => post('/exports_quickXlsx', {'mode': mode});

            Future<ApiResponse> exportImportTemplate() => post('/exports_myClientsTemplateXlsx', {});

            Future<ApiResponse> exportTasksUpdateTemplate() => post('/exports_tasksUpdateTemplateXlsx', {});

            Future<ApiResponse> exportTasksForUpdate({int limit = 600}) => post('/exports_tasksExportForUpdateXlsx', {'limitTasks': limit});

            // ==================== REPORTS ====================
            Future<ApiResponse> reportFirmRangePdf({required String fromDmy, required String toDmy}) => post('/reports_firmRangePdf', {
              'fromDmy': fromDmy,
              'toDmy': toDmy,
            });

            Future<ApiResponse> reportClientHistoryPdf({required String clientId, required String fromYmd, required String toYmd}) => post('/reports_clientHistoryPdf', {
              'clientId': clientId,
              'fromYmd': fromYmd,
              'toYmd': toYmd,
            });

            Future<ApiResponse> reportTaskHistoryPdf(String taskId) => post('/reports_taskHistoryPdf', {'taskId': taskId});

            Future<ApiResponse> reportDailyDigestPdf() => post('/reports_dailyDigestPdf', {});

            Future<ApiResponse> reportMonthlyPdf(String monthYmd) => post('/reports_monthlyPdf', {'monthYmd': monthYmd});

            // ==================== SETTINGS ====================
            Future<ApiResponse> getSettings() => post('/settings_get', {});
            Future<ApiResponse> updateSettings(Map<String, dynamic> settings) => post('/settings_update', settings);
            Future<ApiResponse> getCalendarSettings() => post('/settings_calendar_get', {});
            Future<ApiResponse> updateCalendarSettings(Map<String, dynamic> settings) => post('/settings_calendar_update', settings);
            Future<ApiResponse> setWorkerImportPassword(String password) => post('/settings_workerImportPassword_set', {'password': password});

            // ==================== USERS ====================
            Future<ApiResponse> listUsers() => post('/users_list', {});
            Future<ApiResponse> setUserRole({required String uid, required String role, bool active = true}) => post('/users_setrole', {
              'uid': uid,
              'role': role,
              'active': active,
            });
            Future<ApiResponse> setUserManager({required String uid, required String managerEmail}) => post('/users_setmanager', {
              'uid': uid,
              'managerEmail': managerEmail,
            });
            Future<ApiResponse> setUserDisplayName({required String uid, required String displayName}) => post('/users_setdisplayname', {
              'uid': uid,
              'displayName': displayName,
            });
            Future<ApiResponse> migrateRoles({bool dryRun = true, int limit = 800}) => post('/roles_migrate_worker_to_associate', {
              'dryRun': dryRun,
              'limit': limit,
            });
          }
          ''')
          EOF

      - name: üîÑ Create Providers
        run: |
          python3 << 'EOF'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          # auth_provider.dart
          write_file('flutter_app/lib/providers/auth_provider.dart', '''
          import 'package:flutter/material.dart';
          import 'package:firebase_auth/firebase_auth.dart';
          import 'package:cloud_firestore/cloud_firestore.dart';
          import '../models/user_model.dart';
          import '../services/api_service.dart';

          class AuthProvider extends ChangeNotifier {
            final FirebaseAuth _auth = FirebaseAuth.instance;
            final FirebaseFirestore _firestore = FirebaseFirestore.instance;
            final ApiService _api = ApiService();

            User? _firebaseUser;
            UserModel? _userModel;
            bool _isLoading = false;
            String? _error;

            User? get firebaseUser => _firebaseUser;
            UserModel? get user => _userModel;
            bool get isLoading => _isLoading;
            String? get error => _error;
            bool get isAuthenticated => _firebaseUser != null;

            bool get isPartner => _userModel?.isPartner ?? false;
            bool get isManager => _userModel?.isManager ?? false;
            bool get isAssociate => _userModel?.isAssociate ?? true;
            bool get canSeeAllTasks => _userModel?.canSeeAllTasks ?? false;
            bool get canEditDetails => _userModel?.canEditDetails ?? false;
            bool get canAccessClients => _userModel?.canAccessClients ?? false;
            bool get canAccessOps => _userModel?.canAccessOps ?? false;
            String get role => _userModel?.role ?? 'ASSOCIATE';
            String get email => _userModel?.email ?? _firebaseUser?.email ?? '';
            String get displayName => _userModel?.displayName ?? '';
            String get uid => _firebaseUser?.uid ?? '';

            AuthProvider() {
              _auth.authStateChanges().listen(_onAuthStateChanged);
            }

            Future<void> _onAuthStateChanged(User? user) async {
              _firebaseUser = user;
              if (user == null) {
                _userModel = null;
                notifyListeners();
                return;
              }

              _isLoading = true;
              notifyListeners();

              try {
                await _api.initSelf();
                await _loadUserProfile(user.uid);
              } catch (e) {
                debugPrint('Error initializing user: \$e');
              }

              _isLoading = false;
              notifyListeners();
            }

            Future<void> _loadUserProfile(String uid) async {
              try {
                final doc = await _firestore.collection('users').doc(uid).get();
                if (doc.exists) {
                  _userModel = UserModel.fromJson({
                    ...doc.data()!,
                    'uid': uid,
                    'email': _firebaseUser?.email ?? '',
                  });
                } else {
                  _userModel = UserModel(
                    uid: uid,
                    email: _firebaseUser?.email ?? '',
                    displayName: _firebaseUser?.email?.split('@')[0] ?? '',
                    role: 'ASSOCIATE',
                  );
                }
              } catch (e) {
                debugPrint('Error loading profile: \$e');
                _userModel = UserModel(
                  uid: uid,
                  email: _firebaseUser?.email ?? '',
                  displayName: _firebaseUser?.email?.split('@')[0] ?? '',
                  role: 'ASSOCIATE',
                );
              }
            }

            Future<void> refreshProfile() async {
              if (_firebaseUser != null) {
                await _loadUserProfile(_firebaseUser!.uid);
                notifyListeners();
              }
            }

            Future<bool> signIn(String email, String password) async {
              _isLoading = true;
              _error = null;
              notifyListeners();
              try {
                await _auth.signInWithEmailAndPassword(email: email.trim(), password: password);
                _isLoading = false;
                notifyListeners();
                return true;
              } on FirebaseAuthException catch (e) {
                _error = e.message ?? 'Sign in failed';
                _isLoading = false;
                notifyListeners();
                return false;
              } catch (e) {
                _error = e.toString();
                _isLoading = false;
                notifyListeners();
                return false;
              }
            }

            Future<bool> signUp(String email, String password) async {
              _isLoading = true;
              _error = null;
              notifyListeners();
              try {
                await _auth.createUserWithEmailAndPassword(email: email.trim(), password: password);
                await _api.initSelf(displayName: email.split('@')[0]);
                _isLoading = false;
                notifyListeners();
                return true;
              } on FirebaseAuthException catch (e) {
                _error = e.message ?? 'Sign up failed';
                _isLoading = false;
                notifyListeners();
                return false;
              } catch (e) {
                _error = e.toString();
                _isLoading = false;
                notifyListeners();
                return false;
              }
            }

            Future<bool> resetPassword(String email) async {
              _isLoading = true;
              _error = null;
              notifyListeners();
              try {
                await _auth.sendPasswordResetEmail(email: email.trim());
                _isLoading = false;
                notifyListeners();
                return true;
              } catch (e) {
                _error = e.toString();
                _isLoading = false;
                notifyListeners();
                return false;
              }
            }

            Future<void> signOut() async {
              await _auth.signOut();
              _firebaseUser = null;
              _userModel = null;
              notifyListeners();
            }

            void clearError() {
              _error = null;
              notifyListeners();
            }
          }
          ''')

          # app_provider.dart
          write_file('flutter_app/lib/providers/app_provider.dart', '''
          import 'package:flutter/material.dart';
          import 'package:cloud_firestore/cloud_firestore.dart';
          import 'package:firebase_auth/firebase_auth.dart';
          import 'package:shared_preferences/shared_preferences.dart';
          import '../models/task_model.dart';
          import '../models/client_model.dart';
          import '../utils/date_utils.dart';

          class AppProvider extends ChangeNotifier {
            final FirebaseFirestore _firestore = FirebaseFirestore.instance;
            final FirebaseAuth _auth = FirebaseAuth.instance;

            static const String _themeKey = 'cos_theme_mode';
            static const String _sidebarKey = 'cos_sidebar_collapsed';

            List<TaskModel> _tasks = [];
            List<ClientModel> _clients = [];
            Map<String, ClientModel> _clientsById = {};
            ThemeMode _themeMode = ThemeMode.system;
            int _selectedNavIndex = 0;
            bool _sidebarCollapsed = false;
            bool _isInitialized = false;

            List<TaskModel> get tasks => _tasks;
            List<ClientModel> get clients => _clients;
            Map<String, ClientModel> get clientsById => _clientsById;
            ThemeMode get themeMode => _themeMode;
            int get selectedNavIndex => _selectedNavIndex;
            bool get sidebarCollapsed => _sidebarCollapsed;
            bool get isInitialized => _isInitialized;

            AppProvider() {
              _loadPreferences();
            }

            Future<void> _loadPreferences() async {
              try {
                final prefs = await SharedPreferences.getInstance();
                
                final themeModeStr = prefs.getString(_themeKey);
                if (themeModeStr == 'light') {
                  _themeMode = ThemeMode.light;
                } else if (themeModeStr == 'dark') {
                  _themeMode = ThemeMode.dark;
                } else {
                  _themeMode = ThemeMode.system;
                }

                _sidebarCollapsed = prefs.getBool(_sidebarKey) ?? false;
                _isInitialized = true;
                notifyListeners();
              } catch (e) {
                debugPrint('Error loading preferences: \$e');
                _isInitialized = true;
                notifyListeners();
              }
            }

            Future<void> setThemeMode(ThemeMode mode) async {
              _themeMode = mode;
              notifyListeners();
              
              try {
                final prefs = await SharedPreferences.getInstance();
                String value = 'system';
                if (mode == ThemeMode.light) value = 'light';
                if (mode == ThemeMode.dark) value = 'dark';
                await prefs.setString(_themeKey, value);
              } catch (e) {
                debugPrint('Error saving theme: \$e');
              }
            }

            void toggleTheme() {
              if (_themeMode == ThemeMode.light) {
                setThemeMode(ThemeMode.dark);
              } else {
                setThemeMode(ThemeMode.light);
              }
            }

            Future<void> setSidebarCollapsed(bool collapsed) async {
              _sidebarCollapsed = collapsed;
              notifyListeners();
              
              try {
                final prefs = await SharedPreferences.getInstance();
                await prefs.setBool(_sidebarKey, collapsed);
              } catch (e) {
                debugPrint('Error saving sidebar state: \$e');
              }
            }

            void toggleSidebar() {
              setSidebarCollapsed(!_sidebarCollapsed);
            }

            void setNavIndex(int index) {
              _selectedNavIndex = index;
              notifyListeners();
            }

            Stream<List<TaskModel>> tasksStream({bool isPartnerOrManager = false}) {
              final user = _auth.currentUser;
              if (user == null) return Stream.value([]);

              Query query;
              if (isPartnerOrManager) {
                query = _firestore.collection('tasks').limit(2500);
              } else {
                query = _firestore.collection('tasks').where('assignedToUid', isEqualTo: user.uid).limit(2500);
              }

              return query.snapshots().map((snapshot) {
                _tasks = snapshot.docs.map((doc) => TaskModel.fromJson(doc.data() as Map<String, dynamic>, doc.id)).toList();
                notifyListeners();
                return _tasks;
              });
            }

            Stream<List<ClientModel>> clientsStream() {
              return _firestore.collection('clients').orderBy('name').limit(1200).snapshots().map((snapshot) {
                _clients = snapshot.docs.map((doc) => ClientModel.fromJson(doc.data(), doc.id)).toList();
                _clientsById = {for (var c in _clients) c.id: c};
                notifyListeners();
                return _clients;
              });
            }

            String? getClientName(String? clientId) {
              if (clientId == null) return null;
              return _clientsById[clientId]?.name;
            }

            ClientModel? getClient(String? clientId) {
              if (clientId == null) return null;
              return _clientsById[clientId];
            }

            TaskModel? getTask(String taskId) {
              return _tasks.firstWhere((t) => t.id == taskId, orElse: () => throw Exception('Task not found'));
            }

            // Stats computation
            Map<String, int> computeStats() {
              final today = AppDateUtils.todayYmd();
              int startToday = 0, dueToday = 0, due7 = 0, overdue = 0, approval = 0, snoozed = 0;

              for (final task in _tasks) {
                // Snoozed
                if (task.snoozedUntilYmd != null && task.snoozedUntilYmd!.isNotEmpty) {
                  if (task.status != 'COMPLETED' && task.snoozedUntilYmd!.compareTo(today) > 0) {
                    snoozed++;
                  }
                }

                if (task.status == 'APPROVAL_PENDING') approval++;
                if (task.status != 'COMPLETED' && task.startDateYmd == today) startToday++;

                if (task.dueDateYmd == null || task.dueDateYmd!.isEmpty) continue;
                final dd = AppDateUtils.diffDays(today, task.dueDateYmd!);

                if (task.status != 'COMPLETED') {
                  if (dd < 0) overdue++;
                  if (dd == 0) dueToday++;
                  if (dd >= 0 && dd <= 7) due7++;
                }
              }

              return {
                'startToday': startToday,
                'dueToday': dueToday,
                'due7': due7,
                'overdue': overdue,
                'approval': approval,
                'snoozed': snoozed,
                'total': _tasks.length,
              };
            }

            List<TaskModel> getFocusTasks({int limit = 25}) {
              final today = AppDateUtils.todayYmd();
              final focus = <TaskModel>[];

              for (final task in _tasks) {
                if (task.status == 'COMPLETED') continue;
                if (task.dueDateYmd == null || task.dueDateYmd!.isEmpty) continue;

                final dd = AppDateUtils.diffDays(today, task.dueDateYmd!);
                if (dd <= 3) focus.add(task);
              }

              focus.sort((a, b) => (a.dueDateYmd ?? '').compareTo(b.dueDateYmd ?? ''));
              return focus.take(limit).toList();
            }
          }
          ''')
          EOF

      - name: üß© Create Widgets Part 1
        run: |
          python3 << 'EOF'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          # glass_card.dart
          write_file('flutter_app/lib/widgets/glass_card.dart', '''
          import 'dart:ui';
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../config/theme.dart';

          class GlassCard extends StatelessWidget {
            final String? title;
            final String? subtitle;
            final Widget? trailing;
            final Widget child;
            final Color? accentColor;
            final EdgeInsetsGeometry? padding;
            final EdgeInsetsGeometry? margin;
            final VoidCallback? onTap;
            final bool showAccentBar;

            const GlassCard({
              super.key,
              this.title,
              this.subtitle,
              this.trailing,
              required this.child,
              this.accentColor,
              this.padding,
              this.margin,
              this.onTap,
              this.showAccentBar = true,
            });

            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
              
              return Container(
                margin: margin,
                child: GestureDetector(
                  onTap: onTap,
                  child: Container(
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(20),
                      gradient: LinearGradient(
                        begin: Alignment.topLeft,
                        end: Alignment.bottomRight,
                        colors: isDark
                            ? [const Color(0xFF1C1C1E), const Color(0xFF2C2C2E).withOpacity(0.8)]
                            : [Colors.white.withOpacity(0.95), Colors.white.withOpacity(0.85)],
                      ),
                      border: Border.all(
                        color: accentColor?.withOpacity(0.3) ?? 
                               (isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.05)),
                        width: 1,
                      ),
                      boxShadow: [
                        BoxShadow(
                          color: (accentColor ?? AppTheme.primary).withOpacity(0.08),
                          blurRadius: 20,
                          offset: const Offset(0, 8),
                        ),
                        BoxShadow(
                          color: Colors.black.withOpacity(isDark ? 0.2 : 0.03),
                          blurRadius: 10,
                          offset: const Offset(0, 4),
                        ),
                      ],
                    ),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(20),
                      child: BackdropFilter(
                        filter: ImageFilter.blur(sigmaX: 10, sigmaY: 10),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            if (title != null) _buildHeader(context, isDark),
                            Padding(
                              padding: padding ?? const EdgeInsets.all(16),
                              child: child,
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),
                ),
              );
            }

            Widget _buildHeader(BuildContext context, bool isDark) {
              return Container(
                padding: const EdgeInsets.fromLTRB(16, 14, 16, 12),
                decoration: BoxDecoration(
                  border: Border(
                    bottom: BorderSide(
                      color: (isDark ? Colors.white : Colors.black).withOpacity(0.06),
                    ),
                  ),
                ),
                child: Row(
                  children: [
                    if (accentColor != null && showAccentBar)
                      Container(
                        width: 4,
                        height: 28,
                        margin: const EdgeInsets.only(right: 12),
                        decoration: BoxDecoration(
                          color: accentColor,
                          borderRadius: BorderRadius.circular(4),
                        ),
                      ),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            title!,
                            style: GoogleFonts.inter(
                              fontSize: 16,
                              fontWeight: FontWeight.w800,
                              letterSpacing: -0.3,
                            ),
                          ),
                          if (subtitle != null) ...[
                            const SizedBox(height: 2),
                            Text(
                              subtitle!,
                              style: GoogleFonts.inter(
                                fontSize: 12,
                                fontWeight: FontWeight.w500,
                                color: isDark ? const Color(0xFF8E8E93) : const Color(0xFF6D6D72),
                              ),
                            ),
                          ],
                        ],
                      ),
                    ),
                    if (trailing != null) trailing!,
                  ],
                ),
              );
            }
          }
          ''')

          # status_pill.dart
          write_file('flutter_app/lib/widgets/status_pill.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../config/theme.dart';
          import '../models/task_model.dart';
          import '../utils/date_utils.dart';

          enum PillType { normal, danger, warning, success, muted, info }

          class StatusPill extends StatelessWidget {
            final String text;
            final PillType type;
            final IconData? icon;
            final bool compact;

            const StatusPill({
              super.key,
              required this.text,
              this.type = PillType.normal,
              this.icon,
              this.compact = false,
            });

            factory StatusPill.forTask(TaskModel task, {bool compact = false}) {
              final today = AppDateUtils.todayYmd();
              
              if (task.status == 'COMPLETED') {
                return StatusPill(text: 'DONE', type: PillType.success, icon: Icons.check_circle_rounded, compact: compact);
              }

              // Check if snoozed
              if (task.snoozedUntilYmd != null && task.snoozedUntilYmd!.isNotEmpty) {
                if (task.snoozedUntilYmd!.compareTo(today) > 0) {
                  return StatusPill(text: 'SNOOZED', type: PillType.info, icon: Icons.snooze_rounded, compact: compact);
                }
              }
              
              if (task.dueDateYmd == null || task.dueDateYmd!.isEmpty) {
                return StatusPill(text: 'NO DUE', type: PillType.muted, compact: compact);
              }

              final dd = AppDateUtils.diffDays(today, task.dueDateYmd!);
              final sd = task.startDateYmd != null ? AppDateUtils.diffDays(today, task.startDateYmd!) : null;

              if (dd < 0) return StatusPill(text: 'OVERDUE', type: PillType.danger, icon: Icons.warning_rounded, compact: compact);
              if (dd == 0) return StatusPill(text: 'TODAY', type: PillType.danger, icon: Icons.schedule_rounded, compact: compact);
              if (dd <= 3) {
                if (sd != null && sd > 0) {
                  return StatusPill(text: 'HIGH ALERT', type: PillType.danger, icon: Icons.priority_high_rounded, compact: compact);
                }
                return StatusPill(text: 'DUE SOON', type: PillType.warning, icon: Icons.access_time_rounded, compact: compact);
              }
              if (sd != null && sd == 0) {
                return StatusPill(text: 'START TODAY', type: PillType.warning, icon: Icons.play_arrow_rounded, compact: compact);
              }
              if (dd <= 7) return StatusPill(text: 'THIS WEEK', type: PillType.warning, compact: compact);
              
              return StatusPill(text: 'OK', type: PillType.muted, compact: compact);
            }

            factory StatusPill.forStatus(String? status) {
              switch (status?.toUpperCase()) {
                case 'COMPLETED':
                  return const StatusPill(text: 'COMPLETED', type: PillType.success);
                case 'IN_PROGRESS':
                  return const StatusPill(text: 'IN PROGRESS', type: PillType.info);
                case 'CLIENT_PENDING':
                  return const StatusPill(text: 'CLIENT PENDING', type: PillType.warning);
                case 'APPROVAL_PENDING':
                  return const StatusPill(text: 'APPROVAL PENDING', type: PillType.warning);
                case 'PENDING':
                default:
                  return const StatusPill(text: 'PENDING', type: PillType.muted);
              }
            }

            @override
            Widget build(BuildContext context) {
              Color bgColor, textColor;
              switch (type) {
                case PillType.danger:
                  bgColor = AppTheme.danger.withOpacity(0.15);
                  textColor = AppTheme.danger;
                  break;
                case PillType.warning:
                  bgColor = AppTheme.warning.withOpacity(0.15);
                  textColor = AppTheme.orange;
                  break;
                case PillType.success:
                  bgColor = AppTheme.success.withOpacity(0.15);
                  textColor = AppTheme.success;
                  break;
                case PillType.info:
                  bgColor = AppTheme.primary.withOpacity(0.15);
                  textColor = AppTheme.primary;
                  break;
                case PillType.muted:
                  bgColor = AppTheme.gray.withOpacity(0.15);
                  textColor = AppTheme.gray;
                  break;
                default:
                  bgColor = AppTheme.primary.withOpacity(0.15);
                  textColor = AppTheme.primary;
              }

              return Container(
                padding: EdgeInsets.symmetric(
                  horizontal: compact ? 8 : 10,
                  vertical: compact ? 3 : 5,
                ),
                decoration: BoxDecoration(
                  color: bgColor,
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    if (icon != null) ...[
                      Icon(icon, size: compact ? 10 : 12, color: textColor),
                      SizedBox(width: compact ? 3 : 4),
                    ],
                    Text(
                      text,
                      style: GoogleFonts.inter(
                        fontSize: compact ? 10 : 11,
                        fontWeight: FontWeight.w700,
                        color: textColor,
                        letterSpacing: 0.3,
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          ''')

          # category_pill.dart
          write_file('flutter_app/lib/widgets/category_pill.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../config/theme.dart';

          class CategoryPill extends StatelessWidget {
            final String category;
            final bool compact;

            const CategoryPill({super.key, required this.category, this.compact = false});

            String get normalized {
              final u = category.toUpperCase().replaceAll(' ', '_');
              if (u == 'INCOME_TAX' || u == 'INCOME_TAX_RETURN' || u == 'INCOME') return 'INCOME_TAX';
              if (['GST', 'TDS', 'ROC', 'ACCOUNTING', 'AUDIT'].contains(u)) return u;
              return 'OTHER';
            }

            @override
            Widget build(BuildContext context) {
              final color = AppTheme.categoryColors[normalized] ?? AppTheme.gray;
              return Container(
                padding: EdgeInsets.symmetric(
                  horizontal: compact ? 8 : 10,
                  vertical: compact ? 3 : 5,
                ),
                decoration: BoxDecoration(
                  color: color.withOpacity(0.15),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Text(
                  normalized.replaceAll('_', ' '),
                  style: GoogleFonts.inter(
                    fontSize: compact ? 10 : 11,
                    fontWeight: FontWeight.w700,
                    color: color,
                    letterSpacing: 0.3,
                  ),
                ),
              );
            }
          }
          ''')

          # priority_pill.dart
          write_file('flutter_app/lib/widgets/priority_pill.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../config/theme.dart';

          class PriorityPill extends StatelessWidget {
            final String priority;
            final bool compact;

            const PriorityPill({super.key, required this.priority, this.compact = false});

            String get normalized => priority.toUpperCase();

            @override
            Widget build(BuildContext context) {
              final color = AppTheme.priorityColors[normalized] ?? AppTheme.orange;
              IconData icon;
              switch (normalized) {
                case 'HIGH':
                  icon = Icons.arrow_upward_rounded;
                  break;
                case 'LOW':
                  icon = Icons.arrow_downward_rounded;
                  break;
                default:
                  icon = Icons.remove_rounded;
              }

              return Container(
                padding: EdgeInsets.symmetric(
                  horizontal: compact ? 6 : 8,
                  vertical: compact ? 3 : 5,
                ),
                decoration: BoxDecoration(
                  color: color.withOpacity(0.15),
                  borderRadius: BorderRadius.circular(8),
                ),
                child: Row(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Icon(icon, size: compact ? 10 : 12, color: color),
                    SizedBox(width: compact ? 2 : 3),
                    Text(
                      normalized,
                      style: GoogleFonts.inter(
                        fontSize: compact ? 10 : 11,
                        fontWeight: FontWeight.w700,
                        color: color,
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          ''')

          # kpi_card.dart
          write_file('flutter_app/lib/widgets/kpi_card.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../config/theme.dart';

          class KpiCard extends StatelessWidget {
            final String label;
            final int value;
            final IconData icon;
            final Color color;
            final bool isAlert;
            final VoidCallback? onTap;

            const KpiCard({
              super.key,
              required this.label,
              required this.value,
              required this.icon,
              required this.color,
              this.isAlert = false,
              this.onTap,
            });

            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;

              return GestureDetector(
                onTap: onTap,
                child: Container(
                  padding: const EdgeInsets.all(14),
                  decoration: BoxDecoration(
                    gradient: LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        color.withOpacity(isDark ? 0.25 : 0.12),
                        color.withOpacity(isDark ? 0.15 : 0.05),
                      ],
                    ),
                    borderRadius: BorderRadius.circular(18),
                    border: Border.all(
                      color: color.withOpacity(isAlert && value > 0 ? 0.5 : 0.2),
                      width: isAlert && value > 0 ? 2 : 1,
                    ),
                  ),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    mainAxisAlignment: MainAxisAlignment.spaceBetween,
                    children: [
                      Container(
                        padding: const EdgeInsets.all(8),
                        decoration: BoxDecoration(
                          color: color.withOpacity(0.2),
                          borderRadius: BorderRadius.circular(10),
                        ),
                        child: Icon(icon, color: color, size: 18),
                      ),
                      const Spacer(),
                      Text(
                        value.toString(),
                        style: GoogleFonts.inter(
                          fontSize: 28,
                          fontWeight: FontWeight.w900,
                          color: color,
                          height: 1,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        label,
                        style: GoogleFonts.inter(
                          fontSize: 11,
                          fontWeight: FontWeight.w600,
                          color: isDark ? const Color(0xFF8E8E93) : const Color(0xFF6D6D72),
                        ),
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                      ),
                    ],
                  ),
                ),
              );
            }
          }
          ''')

          # loading_overlay.dart
          write_file('flutter_app/lib/widgets/loading_overlay.dart', '''
          import 'package:flutter/material.dart';
          import '../config/theme.dart';

          class LoadingOverlay extends StatelessWidget {
            final bool isLoading;
            final Widget child;
            final String? message;

            const LoadingOverlay({
              super.key,
              required this.isLoading,
              required this.child,
              this.message,
            });

            @override
            Widget build(BuildContext context) {
              return Stack(
                children: [
                  child,
                  if (isLoading)
                    Container(
                      color: Colors.black.withOpacity(0.4),
                      child: Center(
                        child: Container(
                          padding: const EdgeInsets.all(24),
                          decoration: BoxDecoration(
                            color: Theme.of(context).cardColor,
                            borderRadius: BorderRadius.circular(16),
                          ),
                          child: Column(
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              const SizedBox(
                                width: 48,
                                height: 48,
                                child: CircularProgressIndicator(
                                  strokeWidth: 4,
                                  valueColor: AlwaysStoppedAnimation<Color>(AppTheme.primary),
                                ),
                              ),
                              if (message != null) ...[
                                const SizedBox(height: 16),
                                Text(message!, style: const TextStyle(fontWeight: FontWeight.w600)),
                              ],
                            ],
                          ),
                        ),
                      ),
                    ),
                ],
              );
            }
          }

          class LoadingIndicator extends StatelessWidget {
            final double size;
            final Color? color;

            const LoadingIndicator({super.key, this.size = 24, this.color});

            @override
            Widget build(BuildContext context) {
              return SizedBox(
                width: size,
                height: size,
                child: CircularProgressIndicator(
                  strokeWidth: 3,
                  valueColor: AlwaysStoppedAnimation<Color>(color ?? AppTheme.primary),
                ),
              );
            }
          }
          ''')

          # empty_state.dart
          write_file('flutter_app/lib/widgets/empty_state.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../config/theme.dart';

          class EmptyState extends StatelessWidget {
            final IconData icon;
            final String title;
            final String? subtitle;
            final Widget? action;
            final Color? iconColor;

            const EmptyState({
              super.key,
              required this.icon,
              required this.title,
              this.subtitle,
              this.action,
              this.iconColor,
            });

            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;

              return Center(
                child: Padding(
                  padding: const EdgeInsets.all(32),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Container(
                        width: 72,
                        height: 72,
                        decoration: BoxDecoration(
                          color: (iconColor ?? AppTheme.gray).withOpacity(0.15),
                          shape: BoxShape.circle,
                        ),
                        child: Icon(
                          icon,
                          color: iconColor ?? AppTheme.gray,
                          size: 36,
                        ),
                      ),
                      const SizedBox(height: 20),
                      Text(
                        title,
                        style: GoogleFonts.inter(
                          fontSize: 18,
                          fontWeight: FontWeight.w800,
                        ),
                        textAlign: TextAlign.center,
                      ),
                      if (subtitle != null) ...[
                        const SizedBox(height: 8),
                        Text(
                          subtitle!,
                          style: GoogleFonts.inter(
                            fontSize: 14,
                            color: isDark ? const Color(0xFF8E8E93) : const Color(0xFF6D6D72),
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ],
                      if (action != null) ...[
                        const SizedBox(height: 24),
                        action!,
                      ],
                    ],
                  ),
                ),
              );
            }
          }
          ''')
          EOF

      - name: üì± Create Main Entry & Auth Screen
        run: |
          python3 << 'EOF'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          # main.dart
          write_file('flutter_app/lib/main.dart', '''
          import 'package:flutter/material.dart';
          import 'package:flutter/services.dart';
          import 'package:firebase_core/firebase_core.dart';
          import 'package:provider/provider.dart';
          import 'config/theme.dart';
          import 'config/constants.dart';
          import 'providers/auth_provider.dart';
          import 'providers/app_provider.dart';
          import 'screens/auth_screen.dart';
          import 'screens/main_shell.dart';
          import 'widgets/loading_overlay.dart';

          void main() async {
            WidgetsFlutterBinding.ensureInitialized();
            
            await Firebase.initializeApp(
              options: const FirebaseOptions(
                apiKey: AppConstants.firebaseApiKey,
                authDomain: AppConstants.firebaseAuthDomain,
                projectId: AppConstants.firebaseProjectId,
                storageBucket: AppConstants.firebaseStorageBucket,
                messagingSenderId: AppConstants.firebaseMessagingSenderId,
                appId: AppConstants.firebaseAppId,
              ),
            );
            
            SystemChrome.setSystemUIOverlayStyle(
              const SystemUiOverlayStyle(
                statusBarColor: Colors.transparent,
                statusBarIconBrightness: Brightness.dark,
              ),
            );
            
            runApp(const ComplianceOSApp());
          }

          class ComplianceOSApp extends StatelessWidget {
            const ComplianceOSApp({super.key});

            @override
            Widget build(BuildContext context) {
              return MultiProvider(
                providers: [
                  ChangeNotifierProvider(create: (_) => AuthProvider()),
                  ChangeNotifierProvider(create: (_) => AppProvider()),
                ],
                child: Consumer2<AppProvider, AuthProvider>(
                  builder: (context, appProvider, authProvider, _) {
                    // Wait for preferences to load
                    if (!appProvider.isInitialized) {
                      return MaterialApp(
                        debugShowCheckedModeBanner: false,
                        theme: AppTheme.lightTheme,
                        home: const Scaffold(
                          body: Center(child: LoadingIndicator(size: 48)),
                        ),
                      );
                    }

                    return MaterialApp(
                      title: 'ComplianceOS',
                      debugShowCheckedModeBanner: false,
                      theme: AppTheme.lightTheme,
                      darkTheme: AppTheme.darkTheme,
                      themeMode: appProvider.themeMode,
                      home: authProvider.isAuthenticated 
                          ? const MainShell() 
                          : const AuthScreen(),
                    );
                  },
                ),
              );
            }
          }
          ''')

          # auth_screen.dart - Full featured
          write_file('flutter_app/lib/screens/auth_screen.dart', '''
          import 'dart:ui';
          import 'package:flutter/material.dart';
          import 'package:flutter_animate/flutter_animate.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../providers/auth_provider.dart';
          import '../providers/app_provider.dart';
          import '../config/theme.dart';
          import '../utils/helpers.dart';

          class AuthScreen extends StatefulWidget {
            const AuthScreen({super.key});

            @override
            State<AuthScreen> createState() => _AuthScreenState();
          }

          class _AuthScreenState extends State<AuthScreen> {
            final _emailController = TextEditingController();
            final _passwordController = TextEditingController();
            bool _isSignUp = false;
            bool _isForgot = false;
            bool _obscurePassword = true;

            @override
            void dispose() {
              _emailController.dispose();
              _passwordController.dispose();
              super.dispose();
            }

            Future<void> _handleSubmit() async {
              final auth = context.read<AuthProvider>();
              final email = _emailController.text.trim();
              final password = _passwordController.text;

              if (email.isEmpty) {
                Helpers.showSnackBar(context, 'Please enter your email', isError: true);
                return;
              }

              if (_isForgot) {
                final success = await auth.resetPassword(email);
                if (mounted) {
                  if (success) {
                    Helpers.showSnackBar(context, 'Password reset email sent!', isSuccess: true);
                    setState(() => _isForgot = false);
                  } else if (auth.error != null) {
                    Helpers.showSnackBar(context, auth.error!, isError: true);
                  }
                }
                return;
              }

              if (password.isEmpty || password.length < 6) {
                Helpers.showSnackBar(context, 'Password must be at least 6 characters', isError: true);
                return;
              }

              bool success;
              if (_isSignUp) {
                success = await auth.signUp(email, password);
                if (mounted && success) {
                  Helpers.showSnackBar(context, 'Account created successfully!', isSuccess: true);
                }
              } else {
                success = await auth.signIn(email, password);
              }

              if (mounted && !success && auth.error != null) {
                Helpers.showSnackBar(context, auth.error!, isError: true);
              }
            }

            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
              final isDark = Theme.of(context).brightness == Brightness.dark;
              final size = MediaQuery.of(context).size;

              return Scaffold(
                body: Stack(
                  children: [
                    // Background gradient
                    Container(
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: isDark
                              ? [const Color(0xFF000000), const Color(0xFF1C1C1E)]
                              : [const Color(0xFFF2F2F7), const Color(0xFFE5E5EA)],
                        ),
                      ),
                    ),
                    
                    // Decorative circles
                    Positioned(
                      top: -size.width * 0.3,
                      right: -size.width * 0.2,
                      child: Container(
                        width: size.width * 0.8,
                        height: size.width * 0.8,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          gradient: RadialGradient(
                            colors: [
                              AppTheme.primary.withOpacity(0.3),
                              AppTheme.primary.withOpacity(0),
                            ],
                          ),
                        ),
                      ),
                    ).animate().fadeIn(duration: 1000.ms).scale(begin: const Offset(0.8, 0.8)),
                    
                    Positioned(
                      bottom: -size.width * 0.4,
                      left: -size.width * 0.3,
                      child: Container(
                        width: size.width * 0.9,
                        height: size.width * 0.9,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          gradient: RadialGradient(
                            colors: [
                              AppTheme.accent.withOpacity(0.25),
                              AppTheme.accent.withOpacity(0),
                            ],
                          ),
                        ),
                      ),
                    ).animate().fadeIn(duration: 1200.ms, delay: 200.ms),
                    
                    // Content
                    SafeArea(
                      child: Center(
                        child: SingleChildScrollView(
                          padding: const EdgeInsets.all(24),
                          child: ConstrainedBox(
                            constraints: const BoxConstraints(maxWidth: 420),
                            child: Column(
                              mainAxisAlignment: MainAxisAlignment.center,
                              children: [
                                // Theme toggle in corner
                                Align(
                                  alignment: Alignment.topRight,
                                  child: IconButton(
                                    onPressed: () => app.toggleTheme(),
                                    icon: Icon(
                                      isDark ? Icons.light_mode_rounded : Icons.dark_mode_rounded,
                                      color: isDark ? Colors.white70 : Colors.black54,
                                    ),
                                  ),
                                ).animate().fadeIn(delay: 600.ms),
                                
                                const SizedBox(height: 20),
                                
                                // Logo
                                Container(
                                  width: 80,
                                  height: 80,
                                  decoration: BoxDecoration(
                                    borderRadius: BorderRadius.circular(24),
                                    gradient: AppTheme.primaryGradient,
                                    boxShadow: [
                                      BoxShadow(
                                        color: AppTheme.primary.withOpacity(0.4),
                                        blurRadius: 30,
                                        offset: const Offset(0, 10),
                                      ),
                                    ],
                                  ),
                                  child: const Icon(Icons.check_circle_outline_rounded, color: Colors.white, size: 40),
                                ).animate().fadeIn(duration: 600.ms).slideY(begin: -0.3),
                                
                                const SizedBox(height: 24),
                                
                                // Title
                                Text(
                                  'ComplianceOS',
                                  style: GoogleFonts.inter(fontSize: 32, fontWeight: FontWeight.w900, letterSpacing: -1),
                                ).animate().fadeIn(duration: 600.ms, delay: 100.ms),
                                
                                const SizedBox(height: 8),
                                
                                Text(
                                  'Tasks ¬∑ Calendar ¬∑ Compliance',
                                  style: GoogleFonts.inter(fontSize: 15, fontWeight: FontWeight.w600, color: AppTheme.gray),
                                ).animate().fadeIn(duration: 600.ms, delay: 200.ms),
                                
                                const SizedBox(height: 48),

                                // Auth Card
                                ClipRRect(
                                  borderRadius: BorderRadius.circular(28),
                                  child: BackdropFilter(
                                    filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                                    child: Container(
                                      padding: const EdgeInsets.all(28),
                                      decoration: BoxDecoration(
                                        color: isDark ? Colors.white.withOpacity(0.08) : Colors.white.withOpacity(0.8),
                                        borderRadius: BorderRadius.circular(28),
                                        border: Border.all(color: isDark ? Colors.white.withOpacity(0.1) : Colors.white.withOpacity(0.5)),
                                        boxShadow: [BoxShadow(color: Colors.black.withOpacity(0.1), blurRadius: 40, offset: const Offset(0, 20))],
                                      ),
                                      child: Column(
                                        crossAxisAlignment: CrossAxisAlignment.start,
                                        children: [
                                          Text(
                                            _isForgot ? 'Reset Password' : (_isSignUp ? 'Create Account' : 'Welcome Back'),
                                            style: GoogleFonts.inter(fontSize: 24, fontWeight: FontWeight.w800),
                                          ),
                                          const SizedBox(height: 8),
                                          Text(
                                            _isForgot 
                                                ? 'Enter your email to receive a reset link' 
                                                : (_isSignUp ? 'Start managing compliance today' : 'Sign in to continue'),
                                            style: GoogleFonts.inter(fontSize: 14, color: AppTheme.gray),
                                          ),
                                          const SizedBox(height: 28),

                                          // Email field
                                          Text('Email', style: GoogleFonts.inter(fontSize: 13, fontWeight: FontWeight.w700, color: isDark ? Colors.white70 : Colors.black54)),
                                          const SizedBox(height: 8),
                                          TextField(
                                            controller: _emailController,
                                            keyboardType: TextInputType.emailAddress,
                                            textInputAction: _isForgot ? TextInputAction.done : TextInputAction.next,
                                            decoration: InputDecoration(
                                              hintText: 'your@email.com',
                                              prefixIcon: const Icon(Icons.email_outlined, size: 20),
                                              filled: true,
                                              fillColor: isDark ? Colors.white.withOpacity(0.05) : const Color(0xFFF2F2F7),
                                            ),
                                          ),
                                          
                                          const SizedBox(height: 20),

                                          // Password field
                                          if (!_isForgot) ...[
                                            Text('Password', style: GoogleFonts.inter(fontSize: 13, fontWeight: FontWeight.w700, color: isDark ? Colors.white70 : Colors.black54)),
                                            const SizedBox(height: 8),
                                            TextField(
                                              controller: _passwordController,
                                              obscureText: _obscurePassword,
                                              textInputAction: TextInputAction.done,
                                              onSubmitted: (_) => _handleSubmit(),
                                              decoration: InputDecoration(
                                                hintText: '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢',
                                                prefixIcon: const Icon(Icons.lock_outline, size: 20),
                                                suffixIcon: IconButton(
                                                  icon: Icon(_obscurePassword ? Icons.visibility_outlined : Icons.visibility_off_outlined, size: 20),
                                                  onPressed: () => setState(() => _obscurePassword = !_obscurePassword),
                                                ),
                                                filled: true,
                                                fillColor: isDark ? Colors.white.withOpacity(0.05) : const Color(0xFFF2F2F7),
                                              ),
                                            ),
                                            const SizedBox(height: 28),
                                          ],

                                          // Submit button
                                          SizedBox(
                                            width: double.infinity,
                                            height: 54,
                                            child: ElevatedButton(
                                              onPressed: auth.isLoading ? null : _handleSubmit,
                                              style: ElevatedButton.styleFrom(
                                                backgroundColor: AppTheme.primary,
                                                shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                                              ),
                                              child: auth.isLoading
                                                  ? const SizedBox(width: 24, height: 24, child: CircularProgressIndicator(strokeWidth: 2.5, color: Colors.white))
                                                  : Text(
                                                      _isForgot ? 'Send Reset Link' : (_isSignUp ? 'Create Account' : 'Sign In'),
                                                      style: GoogleFonts.inter(fontSize: 16, fontWeight: FontWeight.w700),
                                                    ),
                                            ),
                                          ),
                                          
                                          const SizedBox(height: 20),

                                          // Toggle buttons
                                          Row(
                                            mainAxisAlignment: MainAxisAlignment.center,
                                            children: [
                                              if (!_isForgot)
                                                TextButton(
                                                  onPressed: () => setState(() => _isSignUp = !_isSignUp),
                                                  child: Text(
                                                    _isSignUp ? 'Already have an account? Sign In' : "Don't have an account? Sign Up",
                                                    style: GoogleFonts.inter(fontWeight: FontWeight.w600, color: AppTheme.primary),
                                                  ),
                                                ),
                                            ],
                                          ),
                                          
                                          Center(
                                            child: TextButton(
                                              onPressed: () => setState(() => _isForgot = !_isForgot),
                                              child: Text(
                                                _isForgot ? 'Back to Sign In' : 'Forgot Password?',
                                                style: GoogleFonts.inter(fontWeight: FontWeight.w600, color: AppTheme.gray),
                                              ),
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                  ),
                                ).animate().fadeIn(duration: 700.ms, delay: 300.ms).slideY(begin: 0.2),
                                
                                const SizedBox(height: 32),
                                
                                Text(
                                  'Timezone: Asia/Kolkata ¬∑ Date format: DD-MM-YYYY',
                                  style: GoogleFonts.inter(fontSize: 12, color: AppTheme.gray),
                                ).animate().fadeIn(duration: 600.ms, delay: 500.ms),
                              ],
                            ),
                          ),
                        ),
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          ''')
          EOF

      - name: üì± Create Main Shell & Navigation
        run: |
          python3 << 'EOF'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          # main_shell.dart - Complete navigation shell
          write_file('flutter_app/lib/screens/main_shell.dart', '''
          import 'dart:ui';
          import 'package:flutter/material.dart';
          import 'package:flutter_animate/flutter_animate.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../providers/auth_provider.dart';
          import '../providers/app_provider.dart';
          import '../config/theme.dart';
          import 'tabs/home_tab.dart';
          import 'tabs/work_queue_tab.dart';
          import 'tabs/calendar_tab.dart';
          import 'tabs/clients_tab.dart';
          import 'tabs/studio_tab.dart';
          import 'tabs/ops_tab.dart';
          import 'tabs/help_tab.dart';

          class MainShell extends StatefulWidget {
            const MainShell({super.key});

            @override
            State<MainShell> createState() => _MainShellState();
          }

          class _MainShellState extends State<MainShell> {
            int _selectedIndex = 0;

            List<_NavItem> _getNavItems(AuthProvider auth) {
              return [
                const _NavItem(icon: Icons.space_dashboard_outlined, activeIcon: Icons.space_dashboard, label: 'Home', key: 'home'),
                const _NavItem(icon: Icons.list_alt_outlined, activeIcon: Icons.list_alt, label: 'Tasks', key: 'work'),
                const _NavItem(icon: Icons.calendar_month_outlined, activeIcon: Icons.calendar_month, label: 'Calendar', key: 'calendar'),
                if (auth.canAccessClients)
                  const _NavItem(icon: Icons.people_outline, activeIcon: Icons.people, label: 'Clients', key: 'clients'),
                const _NavItem(icon: Icons.edit_note_outlined, activeIcon: Icons.edit_note, label: 'Studio', key: 'studio'),
                if (auth.canAccessOps)
                  const _NavItem(icon: Icons.settings_outlined, activeIcon: Icons.settings, label: 'Ops', key: 'ops'),
                const _NavItem(icon: Icons.help_outline, activeIcon: Icons.help, label: 'Help', key: 'help'),
              ];
            }

            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
              final isDark = Theme.of(context).brightness == Brightness.dark;
              final navItems = _getNavItems(auth);

              // Clamp selected index
              if (_selectedIndex >= navItems.length) _selectedIndex = 0;

              return Scaffold(
                extendBody: true,
                appBar: _buildAppBar(context, auth, app, isDark),
                body: AnimatedSwitcher(
                  duration: const Duration(milliseconds: 250),
                  child: _buildBody(navItems[_selectedIndex].key, auth),
                ),
                bottomNavigationBar: _buildBottomNav(context, navItems, isDark),
                floatingActionButton: _buildFAB(context),
              );
            }

            PreferredSizeWidget _buildAppBar(BuildContext context, AuthProvider auth, AppProvider app, bool isDark) {
              return PreferredSize(
                preferredSize: const Size.fromHeight(64),
                child: ClipRRect(
                  child: BackdropFilter(
                    filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                    child: Container(
                      decoration: BoxDecoration(
                        color: isDark ? const Color(0xFF1C1C1E).withOpacity(0.85) : Colors.white.withOpacity(0.85),
                        border: Border(bottom: BorderSide(color: isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.05))),
                      ),
                      child: SafeArea(
                        child: Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          child: Row(
                            children: [
                              // Logo
                              Container(
                                width: 40, height: 40,
                                decoration: BoxDecoration(borderRadius: BorderRadius.circular(12), gradient: AppTheme.primaryGradient),
                                child: const Icon(Icons.check_circle_outline, color: Colors.white, size: 22),
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text('ComplianceOS', style: GoogleFonts.inter(fontSize: 16, fontWeight: FontWeight.w800)),
                                    Row(
                                      children: [
                                        Container(
                                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                          decoration: BoxDecoration(
                                            color: AppTheme.primary.withOpacity(0.15),
                                            borderRadius: BorderRadius.circular(4),
                                          ),
                                          child: Text(
                                            auth.role,
                                            style: GoogleFonts.inter(fontSize: 10, fontWeight: FontWeight.w700, color: AppTheme.primary),
                                          ),
                                        ),
                                        const SizedBox(width: 6),
                                        Flexible(
                                          child: Text(
                                            auth.email,
                                            style: GoogleFonts.inter(fontSize: 11, color: AppTheme.gray),
                                            overflow: TextOverflow.ellipsis,
                                          ),
                                        ),
                                      ],
                                    ),
                                  ],
                                ),
                              ),
                              
                              // Theme toggle
                              IconButton(
                                onPressed: () => app.toggleTheme(),
                                icon: Icon(
                                  isDark ? Icons.light_mode_rounded : Icons.dark_mode_rounded,
                                  color: isDark ? Colors.white70 : Colors.black54,
                                  size: 22,
                                ),
                                tooltip: isDark ? 'Light mode' : 'Dark mode',
                              ),
                              
                              // Profile
                              GestureDetector(
                                onTap: () => _showProfileSheet(context, auth),
                                child: Container(
                                  width: 40, height: 40,
                                  decoration: BoxDecoration(
                                    shape: BoxShape.circle,
                                    gradient: LinearGradient(colors: [AppTheme.purple.withOpacity(0.8), AppTheme.pink.withOpacity(0.8)]),
                                  ),
                                  child: Center(
                                    child: Text(
                                      (auth.email.isNotEmpty ? auth.email[0] : 'U').toUpperCase(),
                                      style: GoogleFonts.inter(color: Colors.white, fontWeight: FontWeight.w700, fontSize: 16),
                                    ),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
              );
            }

            Widget _buildBody(String key, AuthProvider auth) {
              switch (key) {
                case 'home': return const HomeTab();
                case 'work': return const WorkQueueTab();
                case 'calendar': return const CalendarTab();
                case 'clients': return const ClientsTab();
                case 'studio': return const StudioTab();
                case 'ops': return const OpsTab();
                case 'help': return const HelpTab();
                default: return const HomeTab();
              }
            }

            Widget _buildBottomNav(BuildContext context, List<_NavItem> items, bool isDark) {
              return ClipRRect(
                child: BackdropFilter(
                  filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                  child: Container(
                    decoration: BoxDecoration(
                      color: isDark ? const Color(0xFF1C1C1E).withOpacity(0.92) : Colors.white.withOpacity(0.92),
                      border: Border(top: BorderSide(color: isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.05))),
                    ),
                    child: SafeArea(
                      child: Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 4, vertical: 6),
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.spaceAround,
                          children: items.asMap().entries.map((entry) {
                            final index = entry.key;
                            final item = entry.value;
                            final isSelected = index == _selectedIndex;

                            return Expanded(
                              child: GestureDetector(
                                onTap: () => setState(() => _selectedIndex = index),
                                child: AnimatedContainer(
                                  duration: const Duration(milliseconds: 200),
                                  padding: const EdgeInsets.symmetric(vertical: 6),
                                  decoration: BoxDecoration(
                                    color: isSelected ? AppTheme.primary.withOpacity(0.12) : Colors.transparent,
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  child: Column(
                                    mainAxisSize: MainAxisSize.min,
                                    children: [
                                      Icon(
                                        isSelected ? item.activeIcon : item.icon,
                                        color: isSelected ? AppTheme.primary : (isDark ? Colors.white54 : Colors.black45),
                                        size: 22,
                                      ),
                                      const SizedBox(height: 3),
                                      Text(
                                        item.label,
                                        style: GoogleFonts.inter(
                                          fontSize: 10,
                                          fontWeight: isSelected ? FontWeight.w700 : FontWeight.w600,
                                          color: isSelected ? AppTheme.primary : (isDark ? Colors.white54 : Colors.black45),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                            );
                          }).toList(),
                        ),
                      ),
                    ),
                  ),
                ),
              );
            }

            Widget _buildFAB(BuildContext context) {
              return FloatingActionButton(
                onPressed: () => _showCreateTaskSheet(context),
                elevation: 4,
                child: Container(
                  width: 56, height: 56,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(18),
                    gradient: AppTheme.primaryGradient,
                    boxShadow: [BoxShadow(color: AppTheme.primary.withOpacity(0.4), blurRadius: 16, offset: const Offset(0, 6))],
                  ),
                  child: const Icon(Icons.add_rounded, color: Colors.white, size: 28),
                ),
              ).animate().scale(delay: 400.ms, duration: 300.ms);
            }

            void _showProfileSheet(BuildContext context, AuthProvider auth) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
              
              showModalBottomSheet(
                context: context,
                backgroundColor: Colors.transparent,
                isScrollControlled: true,
                builder: (context) => Container(
                  padding: const EdgeInsets.all(24),
                  decoration: BoxDecoration(
                    color: isDark ? const Color(0xFF1C1C1E) : Colors.white,
                    borderRadius: const BorderRadius.vertical(top: Radius.circular(28)),
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Container(width: 40, height: 4, decoration: BoxDecoration(color: Colors.grey.withOpacity(0.3), borderRadius: BorderRadius.circular(2))),
                      const SizedBox(height: 24),
                      Container(
                        width: 80, height: 80,
                        decoration: BoxDecoration(
                          shape: BoxShape.circle,
                          gradient: LinearGradient(colors: [AppTheme.purple, AppTheme.pink]),
                        ),
                        child: Center(
                          child: Text(
                            (auth.email.isNotEmpty ? auth.email[0] : 'U').toUpperCase(),
                            style: GoogleFonts.inter(color: Colors.white, fontWeight: FontWeight.w800, fontSize: 32),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      Text(auth.displayName.isNotEmpty ? auth.displayName : 'User', style: GoogleFonts.inter(fontSize: 20, fontWeight: FontWeight.w800)),
                      const SizedBox(height: 4),
                      Text(auth.email, style: GoogleFonts.inter(color: AppTheme.gray)),
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                        decoration: BoxDecoration(
                          color: AppTheme.primary.withOpacity(0.15),
                          borderRadius: BorderRadius.circular(8),
                        ),
                        child: Text(auth.role, style: GoogleFonts.inter(color: AppTheme.primary, fontWeight: FontWeight.w700)),
                      ),
                      const SizedBox(height: 32),
                      
                      // Settings options
                      _ProfileOption(
                        icon: Icons.person_outline,
                        label: 'Account Settings',
                        onTap: () {
                          Navigator.pop(context);
                          // TODO: Account settings
                        },
                      ),
                      _ProfileOption(
                        icon: Icons.notifications_outlined,
                        label: 'Notifications',
                        onTap: () {
                          Navigator.pop(context);
                          // TODO: Notifications
                        },
                      ),
                      const Divider(height: 32),
                      
                      SizedBox(
                        width: double.infinity,
                        child: ElevatedButton.icon(
                          onPressed: () {
                            Navigator.pop(context);
                            auth.signOut();
                          },
                          icon: const Icon(Icons.logout_rounded),
                          label: const Text('Sign Out'),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: AppTheme.danger,
                            padding: const EdgeInsets.symmetric(vertical: 14),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                    ],
                  ),
                ),
              );
            }

            void _showCreateTaskSheet(BuildContext context) {
              // TODO: Implement create task bottom sheet
              ScaffoldMessenger.of(context).showSnackBar(
                const SnackBar(content: Text('Quick task creation - Coming soon!')),
              );
            }
          }

          class _NavItem {
            final IconData icon;
            final IconData activeIcon;
            final String label;
            final String key;

            const _NavItem({required this.icon, required this.activeIcon, required this.label, required this.key});
          }

          class _ProfileOption extends StatelessWidget {
            final IconData icon;
            final String label;
            final VoidCallback onTap;

            const _ProfileOption({required this.icon, required this.label, required this.onTap});

            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
              
              return ListTile(
                onTap: onTap,
                leading: Icon(icon, color: AppTheme.primary),
                title: Text(label, style: GoogleFonts.inter(fontWeight: FontWeight.w600)),
                trailing: Icon(Icons.chevron_right, color: isDark ? Colors.white38 : Colors.black26),
                contentPadding: EdgeInsets.zero,
              );
            }
          }
          ''')
          EOF

      - name: üì± Create Tab Screens
        run: |
          python3 << 'EOF'
          import os

          def write_file(path, content):
              os.makedirs(os.path.dirname(path), exist_ok=True)
              with open(path, 'w') as f:
                  f.write(content.strip() + '\n')
              print(f"‚úÖ Created: {path}")

          # home_tab.dart
          write_file('flutter_app/lib/screens/tabs/home_tab.dart', '''
          import 'package:flutter/material.dart';
          import 'package:flutter_animate/flutter_animate.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import 'package:shimmer/shimmer.dart';
          import '../../providers/auth_provider.dart';
          import '../../providers/app_provider.dart';
          import '../../models/task_model.dart';
          import '../../widgets/glass_card.dart';
          import '../../widgets/status_pill.dart';
          import '../../widgets/kpi_card.dart';
          import '../../widgets/empty_state.dart';
          import '../../config/theme.dart';
          import '../../utils/date_utils.dart';
          import '../../screens/task_detail_screen.dart';

          class HomeTab extends StatelessWidget {
            const HomeTab({super.key});

            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
              final isDark = Theme.of(context).brightness == Brightness.dark;

              return StreamBuilder<List<TaskModel>>(
                stream: app.tasksStream(isPartnerOrManager: auth.canSeeAllTasks),
                builder: (context, snapshot) {
                  if (!snapshot.hasData) {
                    return _buildLoadingState(isDark);
                  }

                  final stats = app.computeStats();
                  final focusTasks = app.getFocusTasks(limit: 15);

                  return RefreshIndicator(
                    onRefresh: () async => await Future.delayed(const Duration(seconds: 1)),
                    child: SingleChildScrollView(
                      physics: const AlwaysScrollableScrollPhysics(),
                      padding: const EdgeInsets.fromLTRB(16, 16, 16, 100),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          // Greeting
                          Text(
                            _getGreeting(),
                            style: GoogleFonts.inter(fontSize: 26, fontWeight: FontWeight.w900, letterSpacing: -0.5),
                          ).animate().fadeIn(duration: 400.ms).slideX(begin: -0.1),
                          const SizedBox(height: 4),
                          Text(
                            "Here's your compliance overview",
                            style: GoogleFonts.inter(fontSize: 14, color: AppTheme.gray),
                          ).animate().fadeIn(duration: 400.ms, delay: 100.ms),
                          const SizedBox(height: 24),

                          // KPI Grid
                          GridView.count(
                            shrinkWrap: true,
                            physics: const NeverScrollableScrollPhysics(),
                            crossAxisCount: 2,
                            crossAxisSpacing: 12,
                            mainAxisSpacing: 12,
                            childAspectRatio: 1.35,
                            children: [
                              KpiCard(label: 'Due Today', value: stats['dueToday'] ?? 0, icon: Icons.today_rounded, color: AppTheme.danger, isAlert: true)
                                  .animate().fadeIn(duration: 350.ms, delay: 100.ms).scale(begin: const Offset(0.95, 0.95)),
                              KpiCard(label: 'This Week', value: stats['due7'] ?? 0, icon: Icons.date_range_rounded, color: AppTheme.warning)
                                  .animate().fadeIn(duration: 350.ms, delay: 150.ms).scale(begin: const Offset(0.95, 0.95)),
                              KpiCard(label: 'Overdue', value: stats['overdue'] ?? 0, icon: Icons.warning_rounded, color: AppTheme.pink, isAlert: true)
                                  .animate().fadeIn(duration: 350.ms, delay: 200.ms).scale(begin: const Offset(0.95, 0.95)),
                              KpiCard(label: 'Pending Approval', value: stats['approval'] ?? 0, icon: Icons.pending_actions_rounded, color: AppTheme.purple)
                                  .animate().fadeIn(duration: 350.ms, delay: 250.ms).scale(begin: const Offset(0.95, 0.95)),
                              KpiCard(label: 'Starting Today', value: stats['startToday'] ?? 0, icon: Icons.play_circle_outline_rounded, color: AppTheme.teal)
                                  .animate().fadeIn(duration: 350.ms, delay: 300.ms).scale(begin: const Offset(0.95, 0.95)),
                              KpiCard(label: 'Snoozed', value: stats['snoozed'] ?? 0, icon: Icons.snooze_rounded, color: AppTheme.gray)
                                  .animate().fadeIn(duration: 350.ms, delay: 350.ms).scale(begin: const Offset(0.95, 0.95)),
                            ],
                          ),
                          const SizedBox(height: 24),

                          // Focus Tasks
                          GlassCard(
                            title: 'Focus Tasks',
                            subtitle: 'Overdue, due today, and due soon',
                            accentColor: AppTheme.viewAccents['home'],
                            child: focusTasks.isEmpty
                                ? const EmptyState(
                                    icon: Icons.check_circle_rounded,
                                    title: 'All caught up!',
                                    subtitle: 'No urgent tasks at the moment',
                                    iconColor: AppTheme.success,
                                  )
                                : Column(
                                    children: focusTasks.map((task) => _TaskRow(
                                      task: task,
                                      clientName: app.getClientName(task.clientId),
                                    )).toList(),
                                  ),
                          ).animate().fadeIn(duration: 450.ms, delay: 400.ms).slideY(begin: 0.1),
                        ],
                      ),
                    ),
                  );
                },
              );
            }

            Widget _buildLoadingState(bool isDark) {
              return Shimmer.fromColors(
                baseColor: isDark ? const Color(0xFF2C2C2E) : const Color(0xFFE5E5EA),
                highlightColor: isDark ? const Color(0xFF3A3A3C) : const Color(0xFFF2F2F7),
                child: SingleChildScrollView(
                  padding: const EdgeInsets.all(16),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Container(width: 180, height: 28, decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(8))),
                      const SizedBox(height: 8),
                      Container(width: 240, height: 16, decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(6))),
                      const SizedBox(height: 24),
                      GridView.count(
                        shrinkWrap: true,
                        crossAxisCount: 2,
                        crossAxisSpacing: 12,
                        mainAxisSpacing: 12,
                        childAspectRatio: 1.35,
                        children: List.generate(6, (_) => Container(decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(18)))),
                      ),
                    ],
                  ),
                ),
              );
            }

            String _getGreeting() {
              final hour = DateTime.now().hour;
              if (hour < 12) return 'Good morning';
              if (hour < 17) return 'Good afternoon';
              return 'Good evening';
            }
          }

          class _TaskRow extends StatelessWidget {
            final TaskModel task;
            final String? clientName;

            const _TaskRow({required this.task, this.clientName});

            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
              return InkWell(
                onTap: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(builder: (_) => TaskDetailScreen(taskId: task.id)),
                  );
                },
                borderRadius: BorderRadius.circular(16),
                child: Container(
                  margin: const EdgeInsets.only(bottom: 10),
                  padding: const EdgeInsets.all(14),
                  decoration: BoxDecoration(
                    color: isDark ? Colors.white.withOpacity(0.05) : const Color(0xFFF2F2F7),
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(
                      color: isDark ? Colors.white.withOpacity(0.08) : Colors.black.withOpacity(0.04),
                    ),
                  ),
                  child: Row(
                    children: [
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                StatusPill.forTask(task, compact: true),
                                const SizedBox(width: 8),
                                Expanded(
                                  child: Text(
                                    task.title,
                                    style: GoogleFonts.inter(fontWeight: FontWeight.w800, fontSize: 13.5),
                                    maxLines: 1,
                                    overflow: TextOverflow.ellipsis,
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 8),
                            Text(
                              '${clientName ?? "No client"}'
                              '${task.dueDateYmd != null && task.dueDateYmd!.isNotEmpty ? " ‚Ä¢ Due ${AppDateUtils.ymdToDmy(task.dueDateYmd)}" : ""}'
                              '${task.status != null ? " ‚Ä¢ ${task.status}" : ""}',
                              style: GoogleFonts.inter(
                                fontSize: 12,
                                color: isDark ? const Color(0xFF8E8E93) : const Color(0xFF6D6D72),
                                fontWeight: FontWeight.w600,
                              ),
                              maxLines: 1,
                              overflow: TextOverflow.ellipsis,
                            ),
                          ],
                        ),
                      ),
                      Icon(Icons.chevron_right_rounded, color: isDark ? Colors.white38 : Colors.black26),
                    ],
                  ),
                ),
              );
            }
          }
          ''')
          
          # work_queue_tab.dart
          write_file('flutter_app/lib/screens/tabs/work_queue_tab.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../../config/constants.dart';
          import '../../config/theme.dart';
          import '../../models/task_model.dart';
          import '../../providers/app_provider.dart';
          import '../../providers/auth_provider.dart';
          import '../../screens/create_task_screen.dart';
          import '../../screens/task_detail_screen.dart';
          import '../../services/api_service.dart';
          import '../../utils/date_utils.dart';
          import '../../utils/helpers.dart';
          import '../../widgets/category_pill.dart';
          import '../../widgets/empty_state.dart';
          import '../../widgets/glass_card.dart';
          import '../../widgets/loading_overlay.dart';
          import '../../widgets/priority_pill.dart';
          import '../../widgets/status_pill.dart';
          
          class WorkQueueTab extends StatefulWidget {
            const WorkQueueTab({super.key});
          
            @override
            State<WorkQueueTab> createState() => _WorkQueueTabState();
          }
          
          class _WorkQueueTabState extends State<WorkQueueTab> {
            final _api = ApiService();
          
            String _q = '';
            String _mode = 'ACTIVE'; // ACTIVE | ALL | SNOOZED | APPROVAL | COMPLETED
            String _status = '';
            String _category = '';
            String _priority = '';
            String _assigneeEmail = '';
            String _clientId = '';
          
            final Set<String> _selected = {};
            bool _isBulkBusy = false;
          
            List<TaskModel> _applyFilters(List<TaskModel> tasks, AppProvider app) {
              final today = AppDateUtils.todayYmd();
              final q = _q.trim().toLowerCase();
          
              bool isSnoozedNow(TaskModel t) =>
                  (t.status != 'COMPLETED') &&
                  (t.snoozedUntilYmd != null && t.snoozedUntilYmd!.isNotEmpty) &&
                  (t.snoozedUntilYmd!.compareTo(today) > 0);
          
              final filtered = tasks.where((t) {
                final snoozedNow = isSnoozedNow(t);
          
                if (_mode == 'ACTIVE') {
                  if (t.status == 'COMPLETED') return false;
                  if (snoozedNow) return false;
                } else if (_mode == 'SNOOZED') {
                  if (!snoozedNow) return false;
                } else if (_mode == 'APPROVAL') {
                  if (t.status != 'APPROVAL_PENDING') return false;
                } else if (_mode == 'COMPLETED') {
                  if (t.status != 'COMPLETED') return false;
                }
          
                if (_status.isNotEmpty && (t.status ?? '') != _status) return false;
                if (_category.isNotEmpty && (t.normalizedCategory) != _category) return false;
                if (_priority.isNotEmpty && (t.normalizedPriority) != _priority) return false;
          
                if (_clientId.isNotEmpty && (t.clientId ?? '') != _clientId) return false;
          
                if (_assigneeEmail.isNotEmpty) {
                  if ((t.assignedToEmail ?? '').toLowerCase().trim() != _assigneeEmail.toLowerCase().trim()) {
                    return false;
                  }
                }
          
                if (q.isNotEmpty) {
                  final clientName = app.getClientName(t.clientId) ?? '';
                  final hay = '${t.title} ${t.type ?? ''} $clientName ${t.assignedToEmail ?? ''}'.toLowerCase();
                  if (!hay.contains(q)) return false;
                }
          
                return true;
              }).toList();
          
              filtered.sort((a, b) => (a.dueDateYmd ?? '').compareTo(b.dueDateYmd ?? ''));
              return filtered;
            }
          
            Future<void> _bulkUpdate(String op, Map<String, dynamic> payload, {String? success}) async {
              if (_selected.isEmpty) {
                Helpers.showSnackBar(context, 'Select tasks first', isError: true);
                return;
              }
              setState(() => _isBulkBusy = true);
              final res = await _api.bulkUpdate(taskIds: _selected.toList(), op: op, payload: payload);
              setState(() => _isBulkBusy = false);
          
              if (!mounted) return;
              if (!res.ok) {
                Helpers.showSnackBar(context, res.error ?? 'Bulk operation failed', isError: true);
                return;
              }
              _selected.clear();
              Helpers.showSnackBar(context, success ?? 'Bulk update applied', isSuccess: true);
            }
          
            Future<void> _promptSnooze() async {
              final picked = await showDatePicker(
                context: context,
                initialDate: DateTime.now().add(const Duration(days: 3)),
                firstDate: DateTime.now().subtract(const Duration(days: 365 * 5)),
                lastDate: DateTime.now().add(const Duration(days: 365 * 10)),
              );
              if (picked == null) return;
              final ymd = AppDateUtils.todayYmd().replaceRange(0, 10,
                  '${picked.year.toString().padLeft(4, '0')}-${picked.month.toString().padLeft(2, '0')}-${picked.day.toString().padLeft(2, '0')}');
              await _bulkUpdate('SNOOZE', {'snoozedUntilYmd': ymd}, success: 'Snoozed ${_selected.length} tasks');
            }
          
            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
          
              return StreamBuilder<List<TaskModel>>(
                stream: app.tasksStream(isPartnerOrManager: auth.canSeeAllTasks),
                builder: (context, snap) {
                  final tasks = _applyFilters(snap.data ?? [], app);
          
                  return LoadingOverlay(
                    isLoading: _isBulkBusy,
                    message: 'Applying bulk action‚Ä¶',
                    child: SingleChildScrollView(
                      padding: const EdgeInsets.fromLTRB(16, 16, 16, 120),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          GlassCard(
                            title: 'Work Queue',
                            subtitle: '${tasks.length} shown ‚Ä¢ ${auth.canSeeAllTasks ? "Team" : "My"} tasks',
                            accentColor: AppTheme.viewAccents['work'],
                            trailing: Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                if (_selected.isNotEmpty)
                                  Container(
                                    padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                    decoration: BoxDecoration(
                                      color: AppTheme.primary.withOpacity(0.12),
                                      borderRadius: BorderRadius.circular(10),
                                    ),
                                    child: Text(
                                      'Selected: ${_selected.length}',
                                      style: GoogleFonts.inter(fontWeight: FontWeight.w800, fontSize: 12, color: AppTheme.primary),
                                    ),
                                  ),
                                const SizedBox(width: 10),
                                IconButton(
                                  tooltip: 'Create task',
                                  onPressed: () {
                                    Navigator.push(
                                      context,
                                      MaterialPageRoute(builder: (_) => const CreateTaskScreen(oneOnly: false)),
                                    );
                                  },
                                  icon: const Icon(Icons.add_circle_outline_rounded),
                                ),
                              ],
                            ),
                            child: Column(
                              children: [
                                TextField(
                                  onChanged: (v) => setState(() => _q = v),
                                  decoration: InputDecoration(
                                    hintText: 'Search tasks, clients, assignees‚Ä¶',
                                    prefixIcon: const Icon(Icons.search_rounded),
                                  ),
                                ),
                                const SizedBox(height: 12),
                                _FilterRow(
                                  label: 'Mode',
                                  value: _mode,
                                  items: const {
                                    'ACTIVE': 'Active',
                                    'ALL': 'All',
                                    'SNOOZED': 'Snoozed',
                                    'APPROVAL': 'Approval',
                                    'COMPLETED': 'Completed',
                                  },
                                  onChanged: (v) => setState(() => _mode = v),
                                ),
                                const SizedBox(height: 8),
                                _FilterRow(
                                  label: 'Status',
                                  value: _status,
                                  items: const {
                                    '': 'All',
                                    'PENDING': 'Pending',
                                    'IN_PROGRESS': 'In progress',
                                    'CLIENT_PENDING': 'Client pending',
                                    'APPROVAL_PENDING': 'Approval pending',
                                    'COMPLETED': 'Completed',
                                  },
                                  onChanged: (v) => setState(() => _status = v),
                                ),
                                const SizedBox(height: 8),
                                _FilterRow(
                                  label: 'Category',
                                  value: _category,
                                  items: {
                                    '': 'All',
                                    for (final c in AppConstants.categories) c: c.replaceAll('_', ' '),
                                  },
                                  onChanged: (v) => setState(() => _category = v),
                                ),
                                const SizedBox(height: 8),
                                _FilterRow(
                                  label: 'Priority',
                                  value: _priority,
                                  items: const {'': 'All', 'HIGH': 'High', 'MEDIUM': 'Medium', 'LOW': 'Low'},
                                  onChanged: (v) => setState(() => _priority = v),
                                ),
                                if (auth.canSeeAllTasks) ...[
                                  const SizedBox(height: 10),
                                  TextField(
                                    onChanged: (v) => setState(() => _assigneeEmail = v),
                                    decoration: const InputDecoration(
                                      hintText: 'Assignee email (exact match)',
                                      prefixIcon: Icon(Icons.person_outline_rounded),
                                    ),
                                  ),
                                ],
                                if (auth.canAccessClients) ...[
                                  const SizedBox(height: 10),
                                  DropdownButtonFormField<String>(
                                    value: _clientId.isEmpty ? null : _clientId,
                                    items: [
                                      const DropdownMenuItem(value: '', child: Text('All clients')),
                                      ...app.clients.map((c) => DropdownMenuItem(value: c.id, child: Text(c.name))),
                                    ],
                                    onChanged: (v) => setState(() => _clientId = (v ?? '')),
                                    decoration: const InputDecoration(
                                      prefixIcon: Icon(Icons.people_outline_rounded),
                                      hintText: 'Client filter',
                                    ),
                                  ),
                                ],
                                const SizedBox(height: 12),
                                if (_selected.isNotEmpty) _buildBulkBar(auth),
                              ],
                            ),
                          ),
                          const SizedBox(height: 14),
                          if (tasks.isEmpty)
                            const EmptyState(
                              icon: Icons.inbox_rounded,
                              title: 'No tasks found',
                              subtitle: 'Try changing filters or search query.',
                            )
                          else
                            Column(
                              children: tasks.take(500).map((t) => _TaskTile(
                                task: t,
                                clientName: app.getClientName(t.clientId),
                                selected: _selected.contains(t.id),
                                onToggle: (on) => setState(() {
                                  if (on) _selected.add(t.id);
                                  else _selected.remove(t.id);
                                }),
                                onOpen: () {
                                  Navigator.push(
                                    context,
                                    MaterialPageRoute(builder: (_) => TaskDetailScreen(taskId: t.id)),
                                  );
                                },
                              )).toList(),
                            ),
                        ],
                      ),
                    ),
                  );
                },
              );
            }
          
            Widget _buildBulkBar(AuthProvider auth) {
              String? bulkStatus;
          
              final reassignCtrl = TextEditingController();
          
              return Container(
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: AppTheme.primary.withOpacity(0.10),
                  borderRadius: BorderRadius.circular(16),
                  border: Border.all(color: AppTheme.primary.withOpacity(0.18)),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text('Bulk actions', style: GoogleFonts.inter(fontWeight: FontWeight.w900)),
                    const SizedBox(height: 10),
                    Row(
                      children: [
                        Expanded(
                          child: DropdownButtonFormField<String>(
                            value: bulkStatus,
                            items: const [
                              DropdownMenuItem(value: null, child: Text('Change status‚Ä¶')),
                              DropdownMenuItem(value: 'PENDING', child: Text('PENDING')),
                              DropdownMenuItem(value: 'IN_PROGRESS', child: Text('IN_PROGRESS')),
                              DropdownMenuItem(value: 'CLIENT_PENDING', child: Text('CLIENT_PENDING')),
                              DropdownMenuItem(value: 'APPROVAL_PENDING', child: Text('APPROVAL_PENDING')),
                              DropdownMenuItem(value: 'COMPLETED', child: Text('COMPLETED')),
                            ],
                            onChanged: (v) => bulkStatus = v,
                            decoration: const InputDecoration(prefixIcon: Icon(Icons.flag_outlined)),
                          ),
                        ),
                        const SizedBox(width: 10),
                        ElevatedButton(
                          onPressed: () async {
                            if (bulkStatus == null || bulkStatus!.isEmpty) {
                              Helpers.showSnackBar(context, 'Pick a status', isError: true);
                              return;
                            }
                            await _bulkUpdate('STATUS', {'newStatus': bulkStatus}, success: 'Updated status for selected tasks');
                          },
                          child: const Text('Apply'),
                        ),
                      ],
                    ),
                    const SizedBox(height: 10),
                    if (auth.canSeeAllTasks) ...[
                      TextField(
                        controller: reassignCtrl,
                        decoration: const InputDecoration(
                          hintText: 'Reassign to email',
                          prefixIcon: Icon(Icons.swap_horiz_rounded),
                        ),
                      ),
                      const SizedBox(height: 10),
                      Row(
                        children: [
                          Expanded(
                            child: OutlinedButton(
                              onPressed: () async {
                                final email = reassignCtrl.text.trim();
                                if (email.isEmpty) {
                                  Helpers.showSnackBar(context, 'Enter assignee email', isError: true);
                                  return;
                                }
                                await _bulkUpdate('REASSIGN', {'assignedToEmail': email}, success: 'Reassigned selected tasks');
                              },
                              child: const Text('Reassign'),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 10),
                    ],
                    Row(
                      children: [
                        Expanded(
                          child: OutlinedButton.icon(
                            onPressed: _promptSnooze,
                            icon: const Icon(Icons.snooze_rounded),
                            label: const Text('Snooze'),
                          ),
                        ),
                        const SizedBox(width: 10),
                        Expanded(
                          child: ElevatedButton.icon(
                            style: ElevatedButton.styleFrom(backgroundColor: AppTheme.danger),
                            onPressed: () async {
                              final ok = await showDialog<bool>(
                                context: context,
                                builder: (ctx) => AlertDialog(
                                  title: const Text('Delete selected tasks?'),
                                  content: const Text('This cannot be undone.'),
                                  actions: [
                                    TextButton(onPressed: () => Navigator.pop(ctx, false), child: const Text('Cancel')),
                                    ElevatedButton(
                                      style: ElevatedButton.styleFrom(backgroundColor: AppTheme.danger),
                                      onPressed: () => Navigator.pop(ctx, true),
                                      child: const Text('Delete'),
                                    ),
                                  ],
                                ),
                              );
                              if (ok != true) return;
                              await _bulkUpdate('DELETE', {}, success: 'Deleted selected tasks');
                            },
                            icon: const Icon(Icons.delete_outline_rounded),
                            label: const Text('Delete'),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              );
            }
          }
          
          class _FilterRow extends StatelessWidget {
            final String label;
            final String value;
            final Map<String, String> items;
            final ValueChanged<String> onChanged;
          
            const _FilterRow({
              required this.label,
              required this.value,
              required this.items,
              required this.onChanged,
            });
          
            @override
            Widget build(BuildContext context) {
              return Row(
                children: [
                  SizedBox(width: 74, child: Text(label, style: GoogleFonts.inter(fontWeight: FontWeight.w800, fontSize: 12))),
                  const SizedBox(width: 8),
                  Expanded(
                    child: SingleChildScrollView(
                      scrollDirection: Axis.horizontal,
                      child: Row(
                        children: items.entries.map((e) {
                          final selected = e.key == value;
                          return Padding(
                            padding: const EdgeInsets.only(right: 8),
                            child: GestureDetector(
                              onTap: () => onChanged(e.key),
                              child: Container(
                                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
                                decoration: BoxDecoration(
                                  color: selected ? AppTheme.primary.withOpacity(0.14) : Colors.transparent,
                                  borderRadius: BorderRadius.circular(12),
                                  border: Border.all(
                                    color: selected ? AppTheme.primary.withOpacity(0.25) : Colors.grey.withOpacity(0.25),
                                  ),
                                ),
                                child: Text(
                                  e.value,
                                  style: GoogleFonts.inter(
                                    fontWeight: FontWeight.w700,
                                    fontSize: 12,
                                    color: selected ? AppTheme.primary : AppTheme.gray,
                                  ),
                                ),
                              ),
                            ),
                          );
                        }).toList(),
                      ),
                    ),
                  ),
                ],
              );
            }
          }
          
          class _TaskTile extends StatelessWidget {
            final TaskModel task;
            final String? clientName;
            final bool selected;
            final ValueChanged<bool> onToggle;
            final VoidCallback onOpen;
          
            const _TaskTile({
              required this.task,
              required this.clientName,
              required this.selected,
              required this.onToggle,
              required this.onOpen,
            });
          
            @override
            Widget build(BuildContext context) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
          
              return InkWell(
                onTap: onOpen,
                borderRadius: BorderRadius.circular(18),
                child: Container(
                  margin: const EdgeInsets.only(bottom: 10),
                  padding: const EdgeInsets.all(14),
                  decoration: BoxDecoration(
                    color: Theme.of(context).cardColor,
                    borderRadius: BorderRadius.circular(18),
                    border: Border.all(color: isDark ? Colors.white.withOpacity(0.10) : Colors.black.withOpacity(0.06)),
                  ),
                  child: Row(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Checkbox(value: selected, onChanged: (v) => onToggle(v ?? false)),
                      const SizedBox(width: 8),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                StatusPill.forTask(task, compact: true),
                                const SizedBox(width: 8),
                                CategoryPill(category: task.category ?? 'OTHER', compact: true),
                                const SizedBox(width: 8),
                                PriorityPill(priority: task.priority ?? 'MEDIUM', compact: true),
                              ],
                            ),
                            const SizedBox(height: 10),
                            Text(task.title, style: GoogleFonts.inter(fontSize: 14.5, fontWeight: FontWeight.w900)),
                            const SizedBox(height: 6),
                            Text(
                              '${clientName ?? "No client"}'
                              '${task.dueDateYmd != null ? " ‚Ä¢ Due ${AppDateUtils.ymdToDmy(task.dueDateYmd)}" : ""}'
                              '${task.assignedToEmail != null ? " ‚Ä¢ ${task.assignedToEmail}" : ""}',
                              style: GoogleFonts.inter(
                                fontSize: 12,
                                fontWeight: FontWeight.w600,
                                color: isDark ? const Color(0xFF8E8E93) : const Color(0xFF6D6D72),
                              ),
                              maxLines: 1,
                              overflow: TextOverflow.ellipsis,
                            ),
                          ],
                        ),
                      ),
                      Icon(Icons.chevron_right_rounded, color: isDark ? Colors.white38 : Colors.black26),
                    ],
                  ),
                ),
              );
            }
          }
          ''')
          
          # calendar_tab.dart
          write_file('flutter_app/lib/screens/tabs/calendar_tab.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import 'package:table_calendar/table_calendar.dart';
          import '../../config/theme.dart';
          import '../../models/task_model.dart';
          import '../../providers/app_provider.dart';
          import '../../providers/auth_provider.dart';
          import '../../screens/task_detail_screen.dart';
          import '../../utils/date_utils.dart';
          import '../../widgets/empty_state.dart';
          import '../../widgets/glass_card.dart';
          import '../../widgets/status_pill.dart';
          
          class CalendarTab extends StatefulWidget {
            const CalendarTab({super.key});
          
            @override
            State<CalendarTab> createState() => _CalendarTabState();
          }
          
          class _CalendarTabState extends State<CalendarTab> {
            DateTime _focusedDay = DateTime.now();
            DateTime? _selectedDay;
          
            String _ymdFromDate(DateTime d) =>
                '${d.year.toString().padLeft(4, '0')}-${d.month.toString().padLeft(2, '0')}-${d.day.toString().padLeft(2, '0')}';
          
            Map<String, List<TaskModel>> _byDue(List<TaskModel> tasks) {
              final map = <String, List<TaskModel>>{};
              for (final t in tasks) {
                final y = t.dueDateYmd;
                if (y == null || y.isEmpty) continue;
                map.putIfAbsent(y, () => []).add(t);
              }
              return map;
            }
          
            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
          
              return StreamBuilder<List<TaskModel>>(
                stream: app.tasksStream(isPartnerOrManager: auth.canSeeAllTasks),
                builder: (context, snap) {
                  final tasks = snap.data ?? [];
                  final map = _byDue(tasks);
          
                  final selectedYmd = _selectedDay != null ? _ymdFromDate(_selectedDay!) : AppDateUtils.todayYmd();
                  final dayTasks = (map[selectedYmd] ?? []).toList()
                    ..sort((a, b) => (a.status ?? '').compareTo(b.status ?? ''));
          
                  return SingleChildScrollView(
                    padding: const EdgeInsets.fromLTRB(16, 16, 16, 120),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        GlassCard(
                          title: 'Timeline',
                          subtitle: 'Tap a date to see due tasks (Month view)',
                          accentColor: AppTheme.viewAccents['calendar'],
                          child: Column(
                            children: [
                              TableCalendar<TaskModel>(
                                firstDay: DateTime.now().subtract(const Duration(days: 365 * 5)),
                                lastDay: DateTime.now().add(const Duration(days: 365 * 10)),
                                focusedDay: _focusedDay,
                                startingDayOfWeek: StartingDayOfWeek.monday,
                                calendarFormat: CalendarFormat.month,
                                selectedDayPredicate: (d) => _selectedDay != null && AppDateUtils.isSameDay(d, _selectedDay!),
                                onDaySelected: (selected, focused) => setState(() {
                                  _selectedDay = selected;
                                  _focusedDay = focused;
                                }),
                                onPageChanged: (focused) => setState(() => _focusedDay = focused),
                                eventLoader: (day) => map[_ymdFromDate(day)] ?? const [],
                                headerStyle: HeaderStyle(
                                  formatButtonVisible: false,
                                  titleTextStyle: GoogleFonts.inter(fontWeight: FontWeight.w900, fontSize: 16),
                                  leftChevronIcon: const Icon(Icons.chevron_left_rounded),
                                  rightChevronIcon: const Icon(Icons.chevron_right_rounded),
                                ),
                                calendarStyle: CalendarStyle(
                                  todayDecoration: BoxDecoration(
                                    color: AppTheme.primary.withOpacity(0.15),
                                    shape: BoxShape.circle,
                                  ),
                                  selectedDecoration: const BoxDecoration(
                                    color: AppTheme.primary,
                                    shape: BoxShape.circle,
                                  ),
                                  markerDecoration: const BoxDecoration(
                                    color: AppTheme.orange,
                                    shape: BoxShape.circle,
                                  ),
                                  markersMaxCount: 3,
                                ),
                              ),
                              const SizedBox(height: 12),
                              Align(
                                alignment: Alignment.centerLeft,
                                child: Text(
                                  'Due on ${AppDateUtils.ymdToDmy(selectedYmd)} ‚Ä¢ ${dayTasks.length} tasks',
                                  style: GoogleFonts.inter(fontWeight: FontWeight.w800),
                                ),
                              ),
                              const SizedBox(height: 10),
                              if (dayTasks.isEmpty)
                                const EmptyState(
                                  icon: Icons.event_available_rounded,
                                  title: 'No tasks due',
                                  subtitle: 'Pick another date or use Work Queue filters.',
                                )
                              else
                                Column(
                                  children: dayTasks.take(80).map((t) {
                                    final clientName = app.getClientName(t.clientId);
                                    return ListTile(
                                      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
                                      tileColor: Theme.of(context).cardColor,
                                      title: Text(t.title, style: GoogleFonts.inter(fontWeight: FontWeight.w800)),
                                      subtitle: Text(
                                        '${clientName ?? "No client"} ‚Ä¢ ${t.status ?? ""}',
                                        style: GoogleFonts.inter(fontWeight: FontWeight.w600),
                                      ),
                                      leading: StatusPill.forTask(t, compact: true),
                                      trailing: const Icon(Icons.chevron_right_rounded),
                                      onTap: () {
                                        Navigator.push(
                                          context,
                                          MaterialPageRoute(builder: (_) => TaskDetailScreen(taskId: t.id)),
                                        );
                                      },
                                    );
                                  }).toList(),
                                )
                            ],
                          ),
                        ),
                      ],
                    ),
                  );
                },
              );
            }
          }
          ''')
          
          # clients_tab.dart
          write_file('flutter_app/lib/screens/tabs/clients_tab.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../../config/theme.dart';
          import '../../models/client_model.dart';
          import '../../providers/app_provider.dart';
          import '../../providers/auth_provider.dart';
          import '../../screens/client_detail_screen.dart';
          import '../../services/api_service.dart';
          import '../../utils/helpers.dart';
          import '../../widgets/empty_state.dart';
          import '../../widgets/glass_card.dart';
          import '../../widgets/loading_overlay.dart';
          
          class ClientsTab extends StatefulWidget {
            const ClientsTab({super.key});
          
            @override
            State<ClientsTab> createState() => _ClientsTabState();
          }
          
          class _ClientsTabState extends State<ClientsTab> {
            final _api = ApiService();
            String _q = '';
            bool _busy = false;
          
            List<ClientModel> _filter(List<ClientModel> clients) {
              final q = _q.trim().toLowerCase();
              if (q.isEmpty) return clients;
              return clients.where((c) {
                final hay = '${c.name} ${c.primaryEmail ?? ''} ${c.pan ?? ''} ${c.gstin ?? ''} ${c.cin ?? ''}'.toLowerCase();
                return hay.contains(q);
              }).toList();
            }
          
            Future<void> _openCreateClient() async {
              final name = TextEditingController();
              final pan = TextEditingController();
              final gstin = TextEditingController();
              final cin = TextEditingController();
              final ay = TextEditingController();
              final eng = TextEditingController();
              final email = TextEditingController();
              final cc = TextEditingController();
              final bcc = TextEditingController();
          
              await showModalBottomSheet(
                context: context,
                isScrollControlled: true,
                backgroundColor: Colors.transparent,
                builder: (ctx) {
                  final isDark = Theme.of(ctx).brightness == Brightness.dark;
                  return Padding(
                    padding: EdgeInsets.only(bottom: MediaQuery.of(ctx).viewInsets.bottom),
                    child: Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: isDark ? const Color(0xFF1C1C1E) : Colors.white,
                        borderRadius: const BorderRadius.vertical(top: Radius.circular(28)),
                      ),
                      child: SingleChildScrollView(
                        child: Column(
                          children: [
                            Container(width: 40, height: 4, decoration: BoxDecoration(color: Colors.grey.withOpacity(0.3), borderRadius: BorderRadius.circular(2))),
                            const SizedBox(height: 14),
                            Row(
                              children: [
                                Expanded(
                                  child: Text('Create Client', style: GoogleFonts.inter(fontWeight: FontWeight.w900, fontSize: 18)),
                                ),
                                IconButton(onPressed: () => Navigator.pop(ctx), icon: const Icon(Icons.close_rounded)),
                              ],
                            ),
                            const SizedBox(height: 10),
                            TextField(controller: name, decoration: const InputDecoration(labelText: 'Client name')),
                            const SizedBox(height: 10),
                            Row(
                              children: [
                                Expanded(child: TextField(controller: pan, decoration: const InputDecoration(labelText: 'PAN'))),
                                const SizedBox(width: 10),
                                Expanded(child: TextField(controller: gstin, decoration: const InputDecoration(labelText: 'GSTIN'))),
                              ],
                            ),
                            const SizedBox(height: 10),
                            Row(
                              children: [
                                Expanded(child: TextField(controller: cin, decoration: const InputDecoration(labelText: 'CIN'))),
                                const SizedBox(width: 10),
                                Expanded(child: TextField(controller: ay, decoration: const InputDecoration(labelText: 'Assessment Year'))),
                              ],
                            ),
                            const SizedBox(height: 10),
                            TextField(controller: eng, decoration: const InputDecoration(labelText: 'Engagement type')),
                            const SizedBox(height: 10),
                            TextField(controller: email, decoration: const InputDecoration(labelText: 'Primary email')),
                            const SizedBox(height: 10),
                            TextField(controller: cc, decoration: const InputDecoration(labelText: 'CC emails (;)')),
                            const SizedBox(height: 10),
                            TextField(controller: bcc, decoration: const InputDecoration(labelText: 'BCC emails (;)')),
                            const SizedBox(height: 16),
                            SizedBox(
                              width: double.infinity,
                              child: ElevatedButton(
                                onPressed: _busy
                                    ? null
                                    : () async {
                                        if (name.text.trim().isEmpty) {
                                          Helpers.showSnackBar(context, 'Client name is required', isError: true);
                                          return;
                                        }
                                        setState(() => _busy = true);
                                        final res = await _api.createClient({
                                          'name': name.text.trim(),
                                          'pan': pan.text.trim(),
                                          'gstin': gstin.text.trim(),
                                          'cin': cin.text.trim(),
                                          'assessmentYear': ay.text.trim(),
                                          'engagementType': eng.text.trim(),
                                          'primaryEmail': email.text.trim(),
                                          'ccEmails': Helpers.parseEmailList(cc.text),
                                          'bccEmails': Helpers.parseEmailList(bcc.text),
                                        });
                                        setState(() => _busy = false);
                                        if (!mounted) return;
                                        if (!res.ok) {
                                          Helpers.showSnackBar(context, res.error ?? 'Create failed', isError: true);
                                          return;
                                        }
                                        Helpers.showSnackBar(context, 'Client created', isSuccess: true);
                                        Navigator.pop(ctx);
                                      },
                                child: const Text('Create'),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  );
                },
              );
            }
          
            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
          
              if (!auth.canAccessClients) {
                return const SingleChildScrollView(
                  padding: EdgeInsets.fromLTRB(16, 16, 16, 120),
                  child: EmptyState(
                    icon: Icons.lock_outline_rounded,
                    title: 'Clients locked',
                    subtitle: 'Clients are available to PARTNER role only.',
                  ),
                );
              }
          
              return StreamBuilder<List<ClientModel>>(
                stream: app.clientsStream(),
                builder: (context, snap) {
                  final all = snap.data ?? [];
                  final list = _filter(all);
          
                  return LoadingOverlay(
                    isLoading: _busy,
                    child: SingleChildScrollView(
                      padding: const EdgeInsets.fromLTRB(16, 16, 16, 120),
                      child: Column(
                        children: [
                          GlassCard(
                            title: 'Clients',
                            subtitle: '${list.length} shown ‚Ä¢ ${all.length} total',
                            accentColor: AppTheme.viewAccents['clients'],
                            trailing: IconButton(
                              onPressed: _openCreateClient,
                              icon: const Icon(Icons.add_circle_outline_rounded),
                            ),
                            child: Column(
                              children: [
                                TextField(
                                  onChanged: (v) => setState(() => _q = v),
                                  decoration: const InputDecoration(
                                    hintText: 'Search clients (name, email, PAN, GSTIN)‚Ä¶',
                                    prefixIcon: Icon(Icons.search_rounded),
                                  ),
                                ),
                                const SizedBox(height: 12),
                                if (list.isEmpty)
                                  const EmptyState(
                                    icon: Icons.people_outline_rounded,
                                    title: 'No clients found',
                                    subtitle: 'Try another search.',
                                  )
                                else
                                  Column(
                                    children: list.take(500).map((c) {
                                      return ListTile(
                                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                                        tileColor: Theme.of(context).cardColor,
                                        title: Text(c.name, style: GoogleFonts.inter(fontWeight: FontWeight.w900)),
                                        subtitle: Text(
                                          '${c.primaryEmail ?? ""}${(c.gstin ?? "").isNotEmpty ? " ‚Ä¢ ${c.gstin}" : ""}${(c.pan ?? "").isNotEmpty ? " ‚Ä¢ ${c.pan}" : ""}',
                                          style: GoogleFonts.inter(fontWeight: FontWeight.w600),
                                          maxLines: 1,
                                          overflow: TextOverflow.ellipsis,
                                        ),
                                        trailing: const Icon(Icons.chevron_right_rounded),
                                        onTap: () {
                                          Navigator.push(
                                            context,
                                            MaterialPageRoute(builder: (_) => ClientDetailScreen(clientId: c.id)),
                                          );
                                        },
                                      );
                                    }).toList(),
                                  ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  );
                },
              );
            }
          }
          ''')
          
          # studio_tab.dart
          write_file('flutter_app/lib/screens/tabs/studio_tab.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../../config/constants.dart';
          import '../../config/theme.dart';
          import '../../utils/helpers.dart';
          import '../../widgets/glass_card.dart';
          
          class StudioTab extends StatefulWidget {
            const StudioTab({super.key});
          
            @override
            State<StudioTab> createState() => _StudioTabState();
          }
          
          class _StudioTabState extends State<StudioTab> {
            final _subject = TextEditingController(text: 'We started {{taskTitle}}');
            final _body = TextEditingController(
              text:
                  'Dear {{clientName}},\\\\n\\\\nWe started work on {{taskTitle}}.\\\\nDue: {{dueDate}}\\\\n\\\\nAdd to calendar: {{addToCalendarUrl}}\\\\n\\\\nRegards,\\\\nCompliance Team',
            );
          
            bool _tokenMode = true; // token mode = keep \\n tokens for Excel
          
            @override
            void dispose() {
              _subject.dispose();
              _body.dispose();
              super.dispose();
            }
          
            void _insertVar(String key) {
              final text = _body.text;
              final sel = _body.selection;
              final start = sel.start < 0 ? text.length : sel.start;
              final end = sel.end < 0 ? text.length : sel.end;
              final next = text.replaceRange(start, end, key);
              _body.text = next;
              _body.selection = TextSelection.collapsed(offset: start + key.length);
            }
          
            @override
            Widget build(BuildContext context) {
              return SingleChildScrollView(
                padding: const EdgeInsets.fromLTRB(16, 16, 16, 120),
                child: GlassCard(
                  title: 'Studio',
                  subtitle: 'Draft templates + Excel-safe copy',
                  accentColor: AppTheme.viewAccents['studio'],
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Row(
                        children: [
                          Expanded(
                            child: Text('Template variables', style: GoogleFonts.inter(fontWeight: FontWeight.w900)),
                          ),
                          Switch(
                            value: _tokenMode,
                            onChanged: (v) => setState(() => _tokenMode = v),
                            activeColor: AppTheme.primary,
                          ),
                          Text(_tokenMode ? 'Excel token mode' : 'Real lines', style: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 12)),
                        ],
                      ),
                      const SizedBox(height: 10),
                      Wrap(
                        spacing: 8,
                        runSpacing: 8,
                        children: AppConstants.templateVariables.map((v) {
                          return OutlinedButton(
                            onPressed: () => _insertVar(v['key'] ?? ''),
                            child: Text(v['name'] ?? ''),
                          );
                        }).toList(),
                      ),
                      const SizedBox(height: 16),
                      Text('Subject', style: GoogleFonts.inter(fontWeight: FontWeight.w800, fontSize: 12)),
                      const SizedBox(height: 8),
                      TextField(controller: _subject),
                      const SizedBox(height: 14),
                      Text('Body', style: GoogleFonts.inter(fontWeight: FontWeight.w800, fontSize: 12)),
                      const SizedBox(height: 8),
                      TextField(
                        controller: _body,
                        maxLines: 10,
                        decoration: const InputDecoration(hintText: 'Write your email body‚Ä¶'),
                        onChanged: (v) {
                          if (!_tokenMode) return;
                        },
                      ),
                      const SizedBox(height: 12),
                      Row(
                        children: [
                          Expanded(
                            child: OutlinedButton(
                              onPressed: () => Helpers.copyToClipboard(context, _subject.text, successMessage: 'Subject copied'),
                              child: const Text('Copy subject'),
                            ),
                          ),
                          const SizedBox(width: 10),
                          Expanded(
                            child: ElevatedButton(
                              onPressed: () {
                                final text = _tokenMode
                                    ? Helpers.realLinesToTokens(Helpers.tokensToRealLines(_body.text))
                                    : Helpers.tokensToRealLines(_body.text);
                                Helpers.copyToClipboard(context, text, successMessage: _tokenMode ? 'Body copied (Excel-safe)' : 'Body copied');
                              },
                              child: Text(_tokenMode ? 'Copy body (Excel-safe)' : 'Copy body'),
                            ),
                          ),
                        ],
                      ),
                      const SizedBox(height: 10),
                      Text(
                        _tokenMode
                            ? 'Tip: Token mode keeps all lines inside a single Excel cell using \\\\n.'
                            : 'Tip: Real lines are easier to read; copy/paste into email editors directly.',
                        style: GoogleFonts.inter(color: AppTheme.gray, fontWeight: FontWeight.w600, fontSize: 12),
                      ),
                    ],
                  ),
                ),
              );
            }
          }
          ''')
          
          # help_tab.dart
          write_file('flutter_app/lib/screens/tabs/help_tab.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import '../../config/theme.dart';
          import '../../widgets/glass_card.dart';
          
          class HelpTab extends StatelessWidget {
            const HelpTab({super.key});
          
            @override
            Widget build(BuildContext context) {
              return SingleChildScrollView(
                padding: const EdgeInsets.fromLTRB(16, 16, 16, 120),
                child: GlassCard(
                  title: 'Help',
                  subtitle: 'Keyboard-first web features are mapped to mobile actions',
                  accentColor: AppTheme.viewAccents['help'],
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text('Roles', style: GoogleFonts.inter(fontWeight: FontWeight.w900)),
                      const SizedBox(height: 8),
                      Text(
                        'ASSOCIATE: update status, add comments, upload attachments.\\n'
                        'MANAGER: everything associate + edit details, ops/reports.\\n'
                        'PARTNER: everything + clients + admin settings.',
                        style: GoogleFonts.inter(fontWeight: FontWeight.w600, color: AppTheme.gray),
                      ),
                      const SizedBox(height: 16),
                      Text('Notes', style: GoogleFonts.inter(fontWeight: FontWeight.w900)),
                      const SizedBox(height: 8),
                      Text(
                        '‚Ä¢ Dates are stored as YYYY-MM-DD (IST) and shown as DD-MM-YYYY.\\n'
                        '‚Ä¢ Start/completion emails and calendar links are controlled by backend settings.\\n'
                        '‚Ä¢ Exports/Reports download base64 files and open locally.',
                        style: GoogleFonts.inter(fontWeight: FontWeight.w600, color: AppTheme.gray),
                      ),
                    ],
                  ),
                ),
              );
            }
          }
          ''')
          
          # ops_tab.dart
          write_file('flutter_app/lib/screens/tabs/ops_tab.dart', '''
          import 'dart:typed_data';
          import 'package:file_picker/file_picker.dart';
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../../config/theme.dart';
          import '../../providers/auth_provider.dart';
          import '../../services/api_service.dart';
          import '../../utils/date_utils.dart';
          import '../../utils/helpers.dart';
          import '../../widgets/empty_state.dart';
          import '../../widgets/glass_card.dart';
          import '../../widgets/loading_overlay.dart';
          
          class OpsTab extends StatefulWidget {
            const OpsTab({super.key});
          
            @override
            State<OpsTab> createState() => _OpsTabState();
          }
          
          class _OpsTabState extends State<OpsTab> {
            final _api = ApiService();
          
            bool _busy = false;
          
            final _fromCtrl = TextEditingController(text: '01-01-2026');
            final _toCtrl = TextEditingController(text: '31-12-2026');
            bool _includeAudit = true;
          
            final _monthCtrl = TextEditingController(text: AppDateUtils.todayYmd());
            final _offlineLimitCtrl = TextEditingController(text: '600');
          
            // Partner-only admin state
            Map<String, dynamic>? _settings;
            Map<String, dynamic>? _calSettings;
            List<Map<String, dynamic>> _users = [];
          
            @override
            void dispose() {
              _fromCtrl.dispose();
              _toCtrl.dispose();
              _monthCtrl.dispose();
              _offlineLimitCtrl.dispose();
              super.dispose();
            }
          
            Future<void> _downloadFromApi(Future<ApiResponse> future, {required String defaultName}) async {
              setState(() => _busy = true);
              final res = await future;
              setState(() => _busy = false);
              if (!mounted) return;
          
              if (!res.ok) {
                Helpers.showSnackBar(context, res.error ?? 'Operation failed', isError: true);
                return;
              }
              final fileName = (res.data is Map ? (res.data['fileName'] ?? defaultName) : defaultName).toString();
              final base64 = (res.data is Map ? (res.data['base64'] ?? '') : '').toString();
              final mime = (res.data is Map ? (res.data['mime'] ?? '') : '').toString();
              await Helpers.downloadBase64File(
                context: context,
                base64Data: base64,
                fileName: fileName,
                mimeType: mime.isEmpty ? null : mime,
              );
            }
          
            Future<PlatformFile?> _pickXlsx() async {
              final result = await FilePicker.platform.pickFiles(
                type: FileType.custom,
                allowedExtensions: const ['xlsx'],
                withData: true,
              );
              if (result == null || result.files.isEmpty) return null;
              return result.files.first;
            }
          
            Future<void> _uploadXlsxToEndpoint(String endpoint, PlatformFile file, {Map<String, String> fields = const {}}) async {
              final bytes = file.bytes;
              if (bytes == null) {
                Helpers.showSnackBar(context, 'Could not read file bytes', isError: true);
                return;
              }
              setState(() => _busy = true);
              final res = await _api.uploadFile(endpoint, bytes, file.name, fields);
              setState(() => _busy = false);
              if (!mounted) return;
          
              if (!res.ok) {
                Helpers.showSnackBar(context, res.error ?? 'Upload failed', isError: true);
                return;
              }
              Helpers.showSnackBar(context, 'Upload complete', isSuccess: true, durationSeconds: 4);
            }
          
            Future<void> _loadPartnerAdmin() async {
              setState(() => _busy = true);
              final s = await _api.getSettings();
              final c = await _api.getCalendarSettings();
              final u = await _api.listUsers();
              setState(() {
                _busy = false;
                _settings = s.ok && s.data is Map ? Map<String, dynamic>.from(s.data['data'] ?? {}) : null;
                _calSettings = c.ok && c.data is Map ? Map<String, dynamic>.from(c.data['data'] ?? {}) : null;
                _users = (u.ok && u.data is Map && u.data['users'] is List)
                    ? List<Map<String, dynamic>>.from(u.data['users'])
                    : [];
              });
            }
          
            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
          
              if (!auth.canAccessOps) {
                return const SingleChildScrollView(
                  padding: EdgeInsets.fromLTRB(16, 16, 16, 120),
                  child: EmptyState(
                    icon: Icons.lock_outline_rounded,
                    title: 'Ops locked',
                    subtitle: 'Ops & Reports are available to PARTNER and MANAGER roles.',
                  ),
                );
              }
          
              return LoadingOverlay(
                isLoading: _busy,
                message: 'Working‚Ä¶',
                child: SingleChildScrollView(
                  padding: const EdgeInsets.fromLTRB(16, 16, 16, 120),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      GlassCard(
                        title: 'Ops & Reports',
                        subtitle: 'Imports, exports, offline updates, and admin tools',
                        accentColor: AppTheme.viewAccents['ops'],
                        child: Column(
                          children: [
                            _sectionTitle('Import (XLSX)'),
                            Row(
                              children: [
                                Expanded(
                                  child: OutlinedButton.icon(
                                    onPressed: () => _downloadFromApi(_api.exportImportTemplate(), defaultName: 'Client_Tasks_Import_Template.xlsx'),
                                    icon: const Icon(Icons.download_rounded),
                                    label: const Text('Template'),
                                  ),
                                ),
                                const SizedBox(width: 10),
                                Expanded(
                                  child: ElevatedButton.icon(
                                    onPressed: () async {
                                      final f = await _pickXlsx();
                                      if (f == null) return;
                                      final pwd = await _askText('Import password (optional)');
                                      await _uploadXlsxToEndpoint('/tasks_bulkimportxlsx', f, fields: {
                                        if (pwd != null && pwd.trim().isNotEmpty) 'importPassword': pwd.trim(),
                                      });
                                    },
                                    icon: const Icon(Icons.upload_file_rounded),
                                    label: const Text('Import'),
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 16),
                            _sectionTitle('Firm range exports'),
                            TextField(
                              controller: _fromCtrl,
                              decoration: const InputDecoration(labelText: 'From (DD-MM-YYYY)'),
                            ),
                            const SizedBox(height: 10),
                            TextField(
                              controller: _toCtrl,
                              decoration: const InputDecoration(labelText: 'To (DD-MM-YYYY)'),
                            ),
                            const SizedBox(height: 10),
                            SwitchListTile(
                              value: _includeAudit,
                              onChanged: (v) => setState(() => _includeAudit = v),
                              title: Text('Include history (AuditLogs)', style: GoogleFonts.inter(fontWeight: FontWeight.w700)),
                              contentPadding: EdgeInsets.zero,
                            ),
                            Row(
                              children: [
                                Expanded(
                                  child: ElevatedButton(
                                    onPressed: () => _downloadFromApi(
                                      _api.exportFirmRangeXlsx(fromDmy: _fromCtrl.text.trim(), toDmy: _toCtrl.text.trim(), includeAudit: _includeAudit),
                                      defaultName: 'Firm_Range.xlsx',
                                    ),
                                    child: const Text('XLSX'),
                                  ),
                                ),
                                const SizedBox(width: 10),
                                Expanded(
                                  child: OutlinedButton(
                                    onPressed: () => _downloadFromApi(
                                      _api.reportFirmRangePdf(fromDmy: _fromCtrl.text.trim(), toDmy: _toCtrl.text.trim()),
                                      defaultName: 'Firm_Range.pdf',
                                    ),
                                    child: const Text('PDF'),
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 16),
                            _sectionTitle('Quick exports'),
                            Wrap(
                              spacing: 10,
                              runSpacing: 10,
                              children: [
                                _quick('NEXT_7', 'Next 7'),
                                _quick('NEXT_15', 'Next 15'),
                                _quick('NEXT_30', 'Next 30'),
                                _quick('OVERDUE', 'Overdue'),
                                _quick('APPROVAL_PENDING', 'Approval'),
                              ],
                            ),
                            const SizedBox(height: 16),
                            _sectionTitle('Reports'),
                            Row(
                              children: [
                                Expanded(
                                  child: OutlinedButton(
                                    onPressed: () => _downloadFromApi(_api.reportDailyDigestPdf(), defaultName: 'Daily_Digest.pdf'),
                                    child: const Text('Daily digest PDF'),
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 10),
                            TextField(
                              controller: _monthCtrl,
                              decoration: const InputDecoration(labelText: 'Month (YYYY-MM-DD; any date in month)'),
                            ),
                            const SizedBox(height: 10),
                            Row(
                              children: [
                                Expanded(
                                  child: ElevatedButton(
                                    onPressed: () => _downloadFromApi(_api.reportMonthlyPdf(_monthCtrl.text.trim()), defaultName: 'Monthly.pdf'),
                                    child: const Text('Monthly PDF'),
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 16),
                            _sectionTitle('Offline updates'),
                            Row(
                              children: [
                                Expanded(
                                  child: OutlinedButton.icon(
                                    onPressed: () => _downloadFromApi(_api.exportTasksUpdateTemplate(), defaultName: 'Tasks_Update_Template.xlsx'),
                                    icon: const Icon(Icons.download_rounded),
                                    label: const Text('Update template'),
                                  ),
                                ),
                                const SizedBox(width: 10),
                                Expanded(
                                  child: OutlinedButton.icon(
                                    onPressed: () async {
                                      final limit = int.tryParse(_offlineLimitCtrl.text.trim()) ?? 600;
                                      await _downloadFromApi(_api.exportTasksForUpdate(limit: limit), defaultName: 'Tasks_Export_For_Update.xlsx');
                                    },
                                    icon: const Icon(Icons.download_for_offline_rounded),
                                    label: const Text('Export tasks'),
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 10),
                            TextField(
                              controller: _offlineLimitCtrl,
                              keyboardType: TextInputType.number,
                              decoration: const InputDecoration(labelText: 'Export limit (e.g., 600)'),
                            ),
                            const SizedBox(height: 10),
                            ElevatedButton.icon(
                              onPressed: () async {
                                final f = await _pickXlsx();
                                if (f == null) return;
                                await _uploadXlsxToEndpoint('/tasks_bulkupdate_from_xlsx', f);
                              },
                              icon: const Icon(Icons.upload_rounded),
                              label: const Text('Upload updates XLSX'),
                            ),
                            const SizedBox(height: 18),
                            if (auth.isPartner) ...[
                              _sectionTitle('Partner admin'),
                              OutlinedButton.icon(
                                onPressed: _loadPartnerAdmin,
                                icon: const Icon(Icons.refresh_rounded),
                                label: const Text('Load admin data'),
                              ),
                              const SizedBox(height: 10),
                              if (_settings != null) _settingsCard(),
                              const SizedBox(height: 10),
                              if (_calSettings != null) _calendarCard(),
                              const SizedBox(height: 10),
                              if (_users.isNotEmpty) _usersCard(),
                              const SizedBox(height: 10),
                              _migrateCard(),
                            ],
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
              );
            }
          
            Widget _quick(String mode, String label) {
              return OutlinedButton(
                onPressed: () => _downloadFromApi(_api.quickExport(mode), defaultName: '$mode.xlsx'),
                child: Text(label),
              );
            }
          
            Widget _sectionTitle(String t) => Align(
                  alignment: Alignment.centerLeft,
                  child: Padding(
                    padding: const EdgeInsets.only(bottom: 10),
                    child: Text(t, style: GoogleFonts.inter(fontWeight: FontWeight.w900)),
                  ),
                );
          
            Future<String?> _askText(String title) async {
              final ctrl = TextEditingController();
              final v = await showDialog<String?>(
                context: context,
                builder: (ctx) => AlertDialog(
                  title: Text(title),
                  content: TextField(controller: ctrl, decoration: const InputDecoration(hintText: 'Optional')),
                  actions: [
                    TextButton(onPressed: () => Navigator.pop(ctx, null), child: const Text('Skip')),
                    ElevatedButton(onPressed: () => Navigator.pop(ctx, ctrl.text), child: const Text('OK')),
                  ],
                ),
              );
              return v;
            }
          
            Widget _settingsCard() {
              final digest = TextEditingController(text: ((_settings!['dailyInternalEmails'] ?? []) as List).join('; '));
              final windowDays = TextEditingController(text: (_settings!['dailyWindowDays'] ?? 30).toString());
              bool sendToAssignees = (_settings!['sendDailyToAssignees'] ?? true) == true;
          
              return GlassCard(
                title: 'Daily digest settings',
                subtitle: 'Partner-only',
                accentColor: AppTheme.purple,
                child: Column(
                  children: [
                    TextField(controller: digest, decoration: const InputDecoration(labelText: 'Internal emails (;)')),
                    const SizedBox(height: 10),
                    TextField(controller: windowDays, keyboardType: TextInputType.number, decoration: const InputDecoration(labelText: 'Window days')),
                    const SizedBox(height: 10),
                    SwitchListTile(
                      value: sendToAssignees,
                      onChanged: (v) => setState(() => sendToAssignees = v),
                      title: Text('Send to assignees', style: GoogleFonts.inter(fontWeight: FontWeight.w700)),
                      contentPadding: EdgeInsets.zero,
                    ),
                    const SizedBox(height: 8),
                    ElevatedButton(
                      onPressed: () async {
                        final res = await _api.updateSettings({
                          'dailyInternalEmails': digest.text,
                          'dailyWindowDays': int.tryParse(windowDays.text) ?? 30,
                          'sendDailyToAssignees': sendToAssignees,
                        });
                        if (!mounted) return;
                        if (!res.ok) {
                          Helpers.showSnackBar(context, res.error ?? 'Save failed', isError: true);
                          return;
                        }
                        Helpers.showSnackBar(context, 'Saved', isSuccess: true);
                      },
                      child: const Text('Save'),
                    ),
                  ],
                ),
              );
            }
          
            Widget _calendarCard() {
              final startHH = TextEditingController(text: (_calSettings!['startHH'] ?? 10).toString());
              final endHH = TextEditingController(text: (_calSettings!['endHH'] ?? 12).toString());
              final tz = TextEditingController(text: (_calSettings!['timeZone'] ?? 'Asia/Kolkata').toString());
          
              return GlassCard(
                title: 'Calendar settings',
                subtitle: 'Partner-only',
                accentColor: AppTheme.teal,
                child: Column(
                  children: [
                    Row(
                      children: [
                        Expanded(child: TextField(controller: startHH, keyboardType: TextInputType.number, decoration: const InputDecoration(labelText: 'Start HH'))),
                        const SizedBox(width: 10),
                        Expanded(child: TextField(controller: endHH, keyboardType: TextInputType.number, decoration: const InputDecoration(labelText: 'End HH'))),
                      ],
                    ),
                    const SizedBox(height: 10),
                    TextField(controller: tz, decoration: const InputDecoration(labelText: 'Time zone')),
                    const SizedBox(height: 10),
                    ElevatedButton(
                      onPressed: () async {
                        final res = await _api.updateCalendarSettings({
                          'startHH': int.tryParse(startHH.text) ?? 10,
                          'endHH': int.tryParse(endHH.text) ?? 12,
                          'timeZone': tz.text.trim(),
                        });
                        if (!mounted) return;
                        if (!res.ok) {
                          Helpers.showSnackBar(context, res.error ?? 'Save failed', isError: true);
                          return;
                        }
                        Helpers.showSnackBar(context, 'Saved', isSuccess: true);
                      },
                      child: const Text('Save'),
                    ),
                  ],
                ),
              );
            }
          
            Widget _usersCard() {
              return GlassCard(
                title: 'Team',
                subtitle: 'Partner-only role management',
                accentColor: AppTheme.orange,
                child: Column(
                  children: _users.take(200).map((u) {
                    final email = (u['email'] ?? '').toString();
                    final uid = (u['uid'] ?? '').toString();
                    final role = (u['role'] ?? 'ASSOCIATE').toString();
                    final active = (u['active'] ?? true) == true;
                    return ListTile(
                      title: Text(email.isEmpty ? uid : email, style: GoogleFonts.inter(fontWeight: FontWeight.w800)),
                      subtitle: Text('Role: $role ‚Ä¢ ${active ? "active" : "inactive"}', style: GoogleFonts.inter(fontWeight: FontWeight.w600)),
                      trailing: const Icon(Icons.edit_rounded),
                      onTap: () => _editUser(u),
                    );
                  }).toList(),
                ),
              );
            }
          
            Future<void> _editUser(Map<String, dynamic> u) async {
              final uid = (u['uid'] ?? '').toString();
              final role = ValueNotifier<String>((u['role'] ?? 'ASSOCIATE').toString());
              final active = ValueNotifier<bool>((u['active'] ?? true) == true);
              final mgr = TextEditingController(text: (u['managerEmail'] ?? '').toString());
              final name = TextEditingController(text: (u['displayName'] ?? '').toString());
          
              await showModalBottomSheet(
                context: context,
                isScrollControlled: true,
                backgroundColor: Colors.transparent,
                builder: (ctx) {
                  final isDark = Theme.of(ctx).brightness == Brightness.dark;
                  return Padding(
                    padding: EdgeInsets.only(bottom: MediaQuery.of(ctx).viewInsets.bottom),
                    child: Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: isDark ? const Color(0xFF1C1C1E) : Colors.white,
                        borderRadius: const BorderRadius.vertical(top: Radius.circular(28)),
                      ),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          Text('Edit user', style: GoogleFonts.inter(fontWeight: FontWeight.w900, fontSize: 18)),
                          const SizedBox(height: 12),
                          TextField(controller: name, decoration: const InputDecoration(labelText: 'Display name')),
                          const SizedBox(height: 10),
                          TextField(controller: mgr, decoration: const InputDecoration(labelText: 'Manager email')),
                          const SizedBox(height: 10),
                          ValueListenableBuilder<String>(
                            valueListenable: role,
                            builder: (_, v, __) => DropdownButtonFormField<String>(
                              value: v,
                              items: const [
                                DropdownMenuItem(value: 'PARTNER', child: Text('PARTNER')),
                                DropdownMenuItem(value: 'MANAGER', child: Text('MANAGER')),
                                DropdownMenuItem(value: 'ASSOCIATE', child: Text('ASSOCIATE')),
                              ],
                              onChanged: (x) => role.value = x ?? 'ASSOCIATE',
                              decoration: const InputDecoration(labelText: 'Role'),
                            ),
                          ),
                          const SizedBox(height: 10),
                          ValueListenableBuilder<bool>(
                            valueListenable: active,
                            builder: (_, v, __) => SwitchListTile(
                              value: v,
                              onChanged: (x) => active.value = x,
                              title: Text('Active', style: GoogleFonts.inter(fontWeight: FontWeight.w700)),
                              contentPadding: EdgeInsets.zero,
                            ),
                          ),
                          const SizedBox(height: 10),
                          Row(
                            children: [
                              Expanded(
                                child: ElevatedButton(
                                  onPressed: () async {
                                    setState(() => _busy = true);
                                    final r1 = await _api.setUserRole(uid: uid, role: role.value, active: active.value);
                                    final r2 = await _api.setUserManager(uid: uid, managerEmail: mgr.text.trim());
                                    final r3 = await _api.setUserDisplayName(uid: uid, displayName: name.text.trim());
                                    setState(() => _busy = false);
          
                                    if (!mounted) return;
                                    if (!r1.ok || !r2.ok || !r3.ok) {
                                      Helpers.showSnackBar(context, 'Save failed', isError: true);
                                      return;
                                    }
                                    Helpers.showSnackBar(context, 'Saved', isSuccess: true);
                                    Navigator.pop(ctx);
                                    await _loadPartnerAdmin();
                                  },
                                  child: const Text('Save'),
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  );
                },
              );
            }
          
            Widget _migrateCard() {
              return GlassCard(
                title: 'Role migration',
                subtitle: 'Convert legacy WORKER roles to ASSOCIATE',
                accentColor: AppTheme.pink,
                child: Row(
                  children: [
                    Expanded(
                      child: OutlinedButton(
                        onPressed: () async {
                          setState(() => _busy = true);
                          final res = await _api.migrateRoles(dryRun: true, limit: 800);
                          setState(() => _busy = false);
                          if (!mounted) return;
                          if (!res.ok) {
                            Helpers.showSnackBar(context, res.error ?? 'Dry run failed', isError: true);
                            return;
                          }
                          Helpers.showSnackBar(context, 'Dry run complete (see logs/server response)', isSuccess: true, durationSeconds: 5);
                        },
                        child: const Text('Dry run'),
                      ),
                    ),
                    const SizedBox(width: 10),
                    Expanded(
                      child: ElevatedButton(
                        onPressed: () async {
                          final ok = await showDialog<bool>(
                            context: context,
                            builder: (ctx) => AlertDialog(
                              title: const Text('Run migration?'),
                              content: const Text('This will update users.role where role == WORKER.'),
                              actions: [
                                TextButton(onPressed: () => Navigator.pop(ctx, false), child: const Text('Cancel')),
                                ElevatedButton(onPressed: () => Navigator.pop(ctx, true), child: const Text('Run')),
                              ],
                            ),
                          );
                          if (ok != true) return;
          
                          setState(() => _busy = true);
                          final res = await _api.migrateRoles(dryRun: false, limit: 800);
                          setState(() => _busy = false);
                          if (!mounted) return;
                          if (!res.ok) {
                            Helpers.showSnackBar(context, res.error ?? 'Migration failed', isError: true);
                            return;
                          }
                          Helpers.showSnackBar(context, 'Migration done', isSuccess: true);
                          await _loadPartnerAdmin();
                        },
                        child: const Text('Run'),
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          ''')
          
          # ======= ADD SCREENS (Task detail / Create task / Client detail) =======
          
          write_file('flutter_app/lib/screens/task_detail_screen.dart', '''
          import 'dart:typed_data';
          import 'package:cloud_firestore/cloud_firestore.dart';
          import 'package:file_picker/file_picker.dart';
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../config/constants.dart';
          import '../config/theme.dart';
          import '../models/task_model.dart';
          import '../models/comment_model.dart';
          import '../models/audit_log_model.dart';
          import '../providers/app_provider.dart';
          import '../providers/auth_provider.dart';
          import '../services/api_service.dart';
          import '../utils/date_utils.dart';
          import '../utils/helpers.dart';
          import '../widgets/category_pill.dart';
          import '../widgets/glass_card.dart';
          import '../widgets/loading_overlay.dart';
          import '../widgets/priority_pill.dart';
          import '../widgets/status_pill.dart';
          import 'create_task_screen.dart';
          import 'package:url_launcher/url_launcher.dart';
          
          class TaskDetailScreen extends StatefulWidget {
            final String taskId;
            const TaskDetailScreen({super.key, required this.taskId});
          
            @override
            State<TaskDetailScreen> createState() => _TaskDetailScreenState();
          }
          
          class _TaskDetailScreenState extends State<TaskDetailScreen> {
            final _api = ApiService();
            bool _busy = false;
          
            Future<void> _setBusy(Future<void> Function() fn) async {
              setState(() => _busy = true);
              try {
                await fn();
              } finally {
                if (mounted) setState(() => _busy = false);
              }
            }
          
            TaskModel? _findTask(AppProvider app) {
              try {
                return app.tasks.firstWhere((t) => t.id == widget.taskId);
              } catch (_) {
                return null;
              }
            }
          
            Future<void> _download(Future<ApiResponse> f) async {
              await _setBusy(() async {
                final res = await f;
                if (!mounted) return;
                if (!res.ok) {
                  Helpers.showSnackBar(context, res.error ?? 'Download failed', isError: true);
                  return;
                }
                final fileName = (res.data is Map ? res.data['fileName'] : null)?.toString() ?? 'download.bin';
                final base64 = (res.data is Map ? res.data['base64'] : null)?.toString() ?? '';
                final mime = (res.data is Map ? res.data['mime'] : null)?.toString();
                await Helpers.downloadBase64File(context: context, base64Data: base64, fileName: fileName, mimeType: mime);
              });
            }
          
            Future<void> _uploadAttachment(String taskId) async {
              final result = await FilePicker.platform.pickFiles(withData: true);
              if (result == null || result.files.isEmpty) return;
              final file = result.files.first;
              final bytes = file.bytes;
              if (bytes == null) {
                Helpers.showSnackBar(context, 'Could not read file bytes', isError: true);
                return;
              }
              final type = await _pickDocType();
              if (type == null) return;
          
              await _setBusy(() async {
                final res = await _api.uploadFile(
                  '/tasks_uploadattachment',
                  bytes,
                  file.name,
                  {'taskId': taskId, 'type': type},
                );
                if (!mounted) return;
                if (!res.ok) {
                  Helpers.showSnackBar(context, res.error ?? 'Upload failed', isError: true);
                  return;
                }
                Helpers.showSnackBar(context, 'Uploaded', isSuccess: true);
              });
            }
          
            Future<String?> _pickDocType() async {
              final types = ['CHALLAN', 'RETURN', 'ACK', 'OTHER'];
              return await showModalBottomSheet<String>(
                context: context,
                builder: (ctx) => SafeArea(
                  child: ListView(
                    shrinkWrap: true,
                    children: [
                      ListTile(
                        title: Text('Document type', style: GoogleFonts.inter(fontWeight: FontWeight.w900)),
                      ),
                      ...types.map((t) => ListTile(
                            title: Text(t),
                            onTap: () => Navigator.pop(ctx, t),
                          )),
                    ],
                  ),
                ),
              );
            }
          
            Future<void> _openLink(String url) async {
              try {
                final uri = Uri.parse(url);
                await launchUrl(uri, mode: LaunchMode.externalApplication);
              } catch (e) {
                if (!mounted) return;
                Helpers.showSnackBar(context, 'Could not open link: $e', isError: true);
              }
            }
          
            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
              final task = _findTask(app);
          
              return LoadingOverlay(
                isLoading: _busy,
                message: 'Working‚Ä¶',
                child: Scaffold(
                  appBar: AppBar(
                    title: Text(task?.title ?? 'Task'),
                    actions: [
                      IconButton(
                        tooltip: 'Create one task',
                        onPressed: () => Navigator.push(
                          context,
                          MaterialPageRoute(builder: (_) => const CreateTaskScreen(oneOnly: true)),
                        ),
                        icon: const Icon(Icons.add_rounded),
                      ),
                    ],
                  ),
                  body: task == null
                      ? const Center(child: LoadingIndicator(size: 44))
                      : SingleChildScrollView(
                          padding: const EdgeInsets.fromLTRB(16, 16, 16, 20),
                          child: Column(
                            children: [
                              GlassCard(
                                title: 'Quick info',
                                subtitle: 'Status, dates, calendar, exports',
                                accentColor: AppTheme.primary,
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Wrap(
                                      spacing: 8,
                                      runSpacing: 8,
                                      children: [
                                        StatusPill.forTask(task),
                                        CategoryPill(category: task.category ?? 'OTHER'),
                                        PriorityPill(priority: task.priority ?? 'MEDIUM'),
                                        if ((task.seriesId ?? '').isNotEmpty)
                                          Container(
                                            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
                                            decoration: BoxDecoration(
                                              color: AppTheme.purple.withOpacity(0.12),
                                              borderRadius: BorderRadius.circular(10),
                                            ),
                                            child: Text('SERIES', style: GoogleFonts.inter(fontWeight: FontWeight.w900, color: AppTheme.purple, fontSize: 11)),
                                          ),
                                      ],
                                    ),
                                    const SizedBox(height: 12),
                                    Text(
                                      '${app.getClientName(task.clientId) ?? task.clientName ?? "No client"}',
                                      style: GoogleFonts.inter(fontWeight: FontWeight.w900, fontSize: 16),
                                    ),
                                    const SizedBox(height: 8),
                                    Text(
                                      'Start: ${AppDateUtils.ymdToDmy(task.startDateYmd)} ‚Ä¢ Due: ${AppDateUtils.ymdToDmy(task.dueDateYmd)}\\n'
                                      'Assignee: ${task.assignedToEmail ?? "‚Äî"}\\n'
                                      'Start mail sent: ${task.clientStartMailSent ? "Yes" : "No"}',
                                      style: GoogleFonts.inter(color: AppTheme.gray, fontWeight: FontWeight.w600, height: 1.3),
                                    ),
                                    const SizedBox(height: 10),
                                    Wrap(
                                      spacing: 10,
                                      runSpacing: 10,
                                      children: [
                                        if ((task.calendarHtmlLink ?? '').isNotEmpty)
                                          OutlinedButton.icon(
                                            onPressed: () => _openLink(task.calendarHtmlLink!),
                                            icon: const Icon(Icons.calendar_month_rounded),
                                            label: const Text('Open Calendar'),
                                          ),
                                        OutlinedButton.icon(
                                          onPressed: () => _download(_api.exportTaskHistoryXlsx(task.id)),
                                          icon: const Icon(Icons.grid_on_rounded),
                                          label: const Text('History XLSX'),
                                        ),
                                        ElevatedButton.icon(
                                          onPressed: () => _download(_api.reportTaskHistoryPdf(task.id)),
                                          icon: const Icon(Icons.picture_as_pdf_rounded),
                                          label: const Text('History PDF'),
                                        ),
                                      ],
                                    ),
                                  ],
                                ),
                              ),
                              const SizedBox(height: 14),
                              _StatusUpdateCard(task: task),
                              const SizedBox(height: 14),
                              if (auth.canEditDetails) ...[
                                _EditDetailsCard(task: task),
                                const SizedBox(height: 14),
                              ],
                              _AttachmentsCard(task: task, onUpload: () => _uploadAttachment(task.id)),
                              const SizedBox(height: 14),
                              _CommentsCard(taskId: task.id),
                              const SizedBox(height: 14),
                              _TimelineCard(taskId: task.id),
                              const SizedBox(height: 22),
                              _DangerZone(task: task),
                            ],
                          ),
                        ),
                ),
              );
            }
          }
          
          class _StatusUpdateCard extends StatefulWidget {
            final TaskModel task;
            const _StatusUpdateCard({required this.task});
          
            @override
            State<_StatusUpdateCard> createState() => _StatusUpdateCardState();
          }
          
          class _StatusUpdateCardState extends State<_StatusUpdateCard> {
            final _api = ApiService();
            String _status = '';
            final _note = TextEditingController();
            String _delayReason = '';
            final _delayNotes = TextEditingController();
            bool _busy = false;
          
            @override
            void initState() {
              super.initState();
              _status = widget.task.status ?? 'PENDING';
              _note.text = widget.task.statusNote ?? '';
              _delayReason = widget.task.delayReason ?? '';
              _delayNotes.text = widget.task.delayNotes ?? '';
            }
          
            @override
            void dispose() {
              _note.dispose();
              _delayNotes.dispose();
              super.dispose();
            }
          
            Future<void> _save() async {
              setState(() => _busy = true);
              final res = await _api.updateTaskStatus(
                taskId: widget.task.id,
                newStatus: _status,
                statusNote: _note.text.trim().isEmpty ? null : _note.text.trim(),
                delayReason: _delayReason.isEmpty ? null : _delayReason,
                delayNotes: _delayNotes.text.trim().isEmpty ? null : _delayNotes.text.trim(),
              );
              setState(() => _busy = false);
              if (!mounted) return;
              if (!res.ok) {
                Helpers.showSnackBar(context, res.error ?? 'Save failed', isError: true);
                return;
              }
              Helpers.showSnackBar(context, 'Status saved', isSuccess: true);
            }
          
            Future<void> _snooze() async {
              final picked = await showDatePicker(
                context: context,
                initialDate: DateTime.now().add(const Duration(days: 3)),
                firstDate: DateTime.now().subtract(const Duration(days: 365 * 5)),
                lastDate: DateTime.now().add(const Duration(days: 365 * 10)),
              );
              if (picked == null) return;
              final ymd = '${picked.year.toString().padLeft(4, '0')}-${picked.month.toString().padLeft(2, '0')}-${picked.day.toString().padLeft(2, '0')}';
              setState(() => _busy = true);
              final res = await _api.bulkUpdate(taskIds: [widget.task.id], op: 'SNOOZE', payload: {'snoozedUntilYmd': ymd});
              setState(() => _busy = false);
              if (!mounted) return;
              if (!res.ok) {
                Helpers.showSnackBar(context, res.error ?? 'Snooze failed', isError: true);
                return;
              }
              Helpers.showSnackBar(context, 'Snoozed', isSuccess: true);
            }
          
            @override
            Widget build(BuildContext context) {
              return GlassCard(
                title: 'Update status',
                subtitle: 'Includes delay reason + notes',
                accentColor: AppTheme.warning,
                trailing: _busy ? const LoadingIndicator() : null,
                child: Column(
                  children: [
                    DropdownButtonFormField<String>(
                      value: _status,
                      items: AppConstants.taskStatuses
                          .map((s) => DropdownMenuItem(value: s, child: Text(s)))
                          .toList(),
                      onChanged: _busy ? null : (v) => setState(() => _status = v ?? _status),
                      decoration: const InputDecoration(labelText: 'Status'),
                    ),
                    const SizedBox(height: 10),
                    TextField(
                      controller: _note,
                      maxLines: 3,
                      decoration: const InputDecoration(labelText: 'Status note (optional)'),
                    ),
                    const SizedBox(height: 10),
                    DropdownButtonFormField<String>(
                      value: _delayReason.isEmpty ? null : _delayReason,
                      items: const [
                        DropdownMenuItem(value: 'CLIENT_DELAY', child: Text('CLIENT_DELAY')),
                        DropdownMenuItem(value: 'INTERNAL_DELAY', child: Text('INTERNAL_DELAY')),
                      ],
                      onChanged: _busy ? null : (v) => setState(() => _delayReason = v ?? ''),
                      decoration: const InputDecoration(labelText: 'Delay reason (optional)'),
                    ),
                    const SizedBox(height: 10),
                    TextField(
                      controller: _delayNotes,
                      maxLines: 3,
                      decoration: const InputDecoration(labelText: 'Delay notes (optional)'),
                    ),
                    const SizedBox(height: 12),
                    Row(
                      children: [
                        Expanded(
                          child: OutlinedButton.icon(
                            onPressed: _busy ? null : _snooze,
                            icon: const Icon(Icons.snooze_rounded),
                            label: const Text('Snooze'),
                          ),
                        ),
                        const SizedBox(width: 10),
                        Expanded(
                          child: ElevatedButton.icon(
                            onPressed: _busy ? null : _save,
                            icon: const Icon(Icons.save_rounded),
                            label: const Text('Save'),
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              );
            }
          }
          
          class _EditDetailsCard extends StatefulWidget {
            final TaskModel task;
            const _EditDetailsCard({required this.task});
          
            @override
            State<_EditDetailsCard> createState() => _EditDetailsCardState();
          }
          
          class _EditDetailsCardState extends State<_EditDetailsCard> {
            final _api = ApiService();
            bool _busy = false;
          
            bool _applySeries = false;
          
            late final TextEditingController _title = TextEditingController(text: widget.task.title);
            late final TextEditingController _type = TextEditingController(text: widget.task.type ?? '');
            String _category = 'OTHER';
            String _priority = 'MEDIUM';
            final _due = TextEditingController(text: AppDateUtils.ymdToDmy(widget.task.dueDateYmd));
            final _trigger = TextEditingController(text: (widget.task.triggerDaysBefore ?? 15).toString());
            final _snooze = TextEditingController(text: AppDateUtils.ymdToDmy(widget.task.snoozedUntilYmd));
            final _assignee = TextEditingController(text: widget.task.assignedToEmail ?? '');
          
            // start mail
            bool _sendStart = true;
            final _to = TextEditingController(text: Helpers.joinEmails(widget.task.clientToEmails));
            final _cc = TextEditingController(text: Helpers.joinEmails(widget.task.clientCcEmails));
            final _bcc = TextEditingController(text: Helpers.joinEmails(widget.task.clientBccEmails));
            bool _ccAssigneeStart = false;
            bool _ccManagerStart = false;
            final _startSubj = TextEditingController(text: widget.task.clientStartSubject ?? '');
            final _startBody = TextEditingController(text: widget.task.clientStartBody ?? '');
          
            // completion mail
            bool _sendComp = true;
            final _compSubj = TextEditingController(text: widget.task.clientCompletionSubject ?? '');
            final _compBody = TextEditingController(text: widget.task.clientCompletionBody ?? '');
            bool _ccAssigneeComp = false;
            bool _ccManagerComp = false;
          
            @override
            void initState() {
              super.initState();
              _category = widget.task.normalizedCategory;
              _priority = widget.task.normalizedPriority;
          
              _sendStart = widget.task.sendClientStartMail;
              _sendComp = widget.task.sendClientCompletionMail;
          
              _ccAssigneeStart = widget.task.ccAssigneeOnClientStart;
              _ccManagerStart = widget.task.ccManagerOnClientStart;
              _ccAssigneeComp = widget.task.ccAssigneeOnCompletion;
              _ccManagerComp = widget.task.ccManagerOnCompletion;
            }
          
            @override
            void dispose() {
              _title.dispose();
              _type.dispose();
              _due.dispose();
              _trigger.dispose();
              _snooze.dispose();
              _assignee.dispose();
              _to.dispose();
              _cc.dispose();
              _bcc.dispose();
              _startSubj.dispose();
              _startBody.dispose();
              _compSubj.dispose();
              _compBody.dispose();
              super.dispose();
            }
          
            Future<void> _save() async {
              setState(() => _busy = true);
          
              String? dueYmd;
              if (_due.text.trim().isNotEmpty) {
                try {
                  dueYmd = AppDateUtils.dmyToYmd(_due.text.trim());
                } catch (e) {
                  setState(() => _busy = false);
                  if (!mounted) return;
                  Helpers.showSnackBar(context, e.toString(), isError: true);
                  return;
                }
              }
          
              String? snoozeYmd;
              if (_snooze.text.trim().isNotEmpty) {
                try {
                  snoozeYmd = AppDateUtils.dmyToYmd(_snooze.text.trim());
                } catch (e) {
                  setState(() => _busy = false);
                  if (!mounted) return;
                  Helpers.showSnackBar(context, e.toString(), isError: true);
                  return;
                }
              }
          
              final res = await _api.updateTask({
                'taskId': widget.task.id,
                'applyToSeries': _applySeries,
                'title': _title.text.trim(),
                'type': _type.text.trim(),
                'category': _category,
                'priority': _priority,
                'dueDateYmd': dueYmd,
                'triggerDaysBefore': int.tryParse(_trigger.text.trim()) ?? 15,
                'snoozedUntilYmd': snoozeYmd,
                'assignedToEmail': _assignee.text.trim(),
                'sendClientStartMail': _sendStart,
                'clientToEmails': Helpers.parseEmailList(_to.text),
                'clientCcEmails': Helpers.parseEmailList(_cc.text),
                'clientBccEmails': Helpers.parseEmailList(_bcc.text),
                'ccAssigneeOnClientStart': _ccAssigneeStart,
                'ccManagerOnClientStart': _ccManagerStart,
                'clientStartSubject': _startSubj.text,
                'clientStartBody': _startBody.text,
                'sendClientCompletionMail': _sendComp,
                'ccAssigneeOnCompletion': _ccAssigneeComp,
                'ccManagerOnCompletion': _ccManagerComp,
                'clientCompletionSubject': _compSubj.text,
                'clientCompletionBody': _compBody.text,
              });
          
              setState(() => _busy = false);
              if (!mounted) return;
          
              if (!res.ok) {
                Helpers.showSnackBar(context, res.error ?? 'Save failed', isError: true);
                return;
              }
              Helpers.showSnackBar(context, 'Saved', isSuccess: true);
            }
          
            @override
            Widget build(BuildContext context) {
              final hasSeries = (widget.task.seriesId ?? '').isNotEmpty;
          
              return GlassCard(
                title: 'Edit details',
                subtitle: hasSeries ? 'Series available (apply-to-series supported)' : 'One task only',
                accentColor: AppTheme.purple,
                trailing: _busy ? const LoadingIndicator() : null,
                child: Column(
                  children: [
                    if (hasSeries)
                      SwitchListTile(
                        value: _applySeries,
                        onChanged: _busy ? null : (v) => setState(() => _applySeries = v),
                        title: Text('Apply to series', style: GoogleFonts.inter(fontWeight: FontWeight.w800)),
                        contentPadding: EdgeInsets.zero,
                      ),
                    TextField(controller: _title, decoration: const InputDecoration(labelText: 'Title')),
                    const SizedBox(height: 10),
                    Row(
                      children: [
                        Expanded(
                          child: DropdownButtonFormField<String>(
                            value: _category,
                            items: AppConstants.categories.map((c) => DropdownMenuItem(value: c, child: Text(c))).toList(),
                            onChanged: _busy ? null : (v) => setState(() => _category = v ?? _category),
                            decoration: const InputDecoration(labelText: 'Category'),
                          ),
                        ),
                        const SizedBox(width: 10),
                        Expanded(
                          child: DropdownButtonFormField<String>(
                            value: _priority,
                            items: AppConstants.priorities.map((p) => DropdownMenuItem(value: p, child: Text(p))).toList(),
                            onChanged: _busy ? null : (v) => setState(() => _priority = v ?? _priority),
                            decoration: const InputDecoration(labelText: 'Priority'),
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 10),
                    TextField(controller: _type, decoration: const InputDecoration(labelText: 'Type')),
                    const SizedBox(height: 10),
                    Row(
                      children: [
                        Expanded(child: TextField(controller: _due, decoration: const InputDecoration(labelText: 'Due (DD-MM-YYYY)'))),
                        const SizedBox(width: 10),
                        Expanded(child: TextField(controller: _trigger, keyboardType: TextInputType.number, decoration: const InputDecoration(labelText: 'Trigger days'))),
                      ],
                    ),
                    const SizedBox(height: 10),
                    Row(
                      children: [
                        Expanded(child: TextField(controller: _snooze, decoration: const InputDecoration(labelText: 'Snoozed until (DD-MM-YYYY)'))),
                        const SizedBox(width: 10),
                        Expanded(child: TextField(controller: _assignee, decoration: const InputDecoration(labelText: 'Assignee email'))),
                      ],
                    ),
                    const SizedBox(height: 16),
                    Align(alignment: Alignment.centerLeft, child: Text('Start email', style: GoogleFonts.inter(fontWeight: FontWeight.w900))),
                    SwitchListTile(
                      value: _sendStart,
                      onChanged: _busy ? null : (v) => setState(() => _sendStart = v),
                      title: Text('Send start email', style: GoogleFonts.inter(fontWeight: FontWeight.w800)),
                      contentPadding: EdgeInsets.zero,
                    ),
                    TextField(controller: _to, decoration: const InputDecoration(labelText: 'To overrides (;)')),
                    const SizedBox(height: 10),
                    Row(
                      children: [
                        Expanded(child: TextField(controller: _cc, decoration: const InputDecoration(labelText: 'CC overrides (;)'))),
                        const SizedBox(width: 10),
                        Expanded(child: TextField(controller: _bcc, decoration: const InputDecoration(labelText: 'BCC overrides (;)'))),
                      ],
                    ),
                    const SizedBox(height: 10),
                    Row(
                      children: [
                        Expanded(
                          child: SwitchListTile(
                            value: _ccAssigneeStart,
                            onChanged: _busy ? null : (v) => setState(() => _ccAssigneeStart = v),
                            title: Text('CC assignee', style: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 13)),
                            contentPadding: EdgeInsets.zero,
                          ),
                        ),
                        Expanded(
                          child: SwitchListTile(
                            value: _ccManagerStart,
                            onChanged: _busy ? null : (v) => setState(() => _ccManagerStart = v),
                            title: Text('CC manager', style: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 13)),
                            contentPadding: EdgeInsets.zero,
                          ),
                        ),
                      ],
                    ),
                    TextField(controller: _startSubj, decoration: const InputDecoration(labelText: 'Start subject')),
                    const SizedBox(height: 10),
                    TextField(controller: _startBody, maxLines: 5, decoration: const InputDecoration(labelText: 'Start body')),
                    const SizedBox(height: 16),
                    Align(alignment: Alignment.centerLeft, child: Text('Completion email', style: GoogleFonts.inter(fontWeight: FontWeight.w900))),
                    SwitchListTile(
                      value: _sendComp,
                      onChanged: _busy ? null : (v) => setState(() => _sendComp = v),
                      title: Text('Send completion email', style: GoogleFonts.inter(fontWeight: FontWeight.w800)),
                      contentPadding: EdgeInsets.zero,
                    ),
                    Row(
                      children: [
                        Expanded(
                          child: SwitchListTile(
                            value: _ccAssigneeComp,
                            onChanged: _busy ? null : (v) => setState(() => _ccAssigneeComp = v),
                            title: Text('CC assignee', style: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 13)),
                            contentPadding: EdgeInsets.zero,
                          ),
                        ),
                        Expanded(
                          child: SwitchListTile(
                            value: _ccManagerComp,
                            onChanged: _busy ? null : (v) => setState(() => _ccManagerComp = v),
                            title: Text('CC manager', style: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 13)),
                            contentPadding: EdgeInsets.zero,
                          ),
                        ),
                      ],
                    ),
                    TextField(controller: _compSubj, decoration: const InputDecoration(labelText: 'Completion subject')),
                    const SizedBox(height: 10),
                    TextField(controller: _compBody, maxLines: 5, decoration: const InputDecoration(labelText: 'Completion body')),
                    const SizedBox(height: 12),
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        onPressed: _busy ? null : _save,
                        icon: const Icon(Icons.save_rounded),
                        label: const Text('Save changes'),
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          
          class _AttachmentsCard extends StatelessWidget {
            final TaskModel task;
            final VoidCallback onUpload;
            const _AttachmentsCard({required this.task, required this.onUpload});
          
            @override
            Widget build(BuildContext context) {
              final items = task.attachments;
              return GlassCard(
                title: 'Attachments',
                subtitle: 'Upload and open documents',
                accentColor: AppTheme.teal,
                trailing: IconButton(
                  onPressed: onUpload,
                  icon: const Icon(Icons.upload_file_rounded),
                ),
                child: items.isEmpty
                    ? const Text('No attachments yet.')
                    : Column(
                        children: items.reversed.map((a) {
                          final fileName = (a['fileName'] ?? '').toString();
                          final type = (a['type'] ?? 'DOC').toString();
                          final link = (a['driveWebViewLink'] ?? '').toString();
                          return ListTile(
                            title: Text('$type ‚Ä¢ $fileName', style: GoogleFonts.inter(fontWeight: FontWeight.w800)),
                            subtitle: Text(link.isEmpty ? 'No link' : link, maxLines: 1, overflow: TextOverflow.ellipsis),
                            trailing: link.isEmpty ? null : const Icon(Icons.open_in_new_rounded),
                            onTap: link.isEmpty
                                ? null
                                : () async {
                                    try {
                                      await launchUrl(Uri.parse(link), mode: LaunchMode.externalApplication);
                                    } catch (_) {}
                                  },
                          );
                        }).toList(),
                      ),
              );
            }
          }
          
          class _CommentsCard extends StatefulWidget {
            final String taskId;
            const _CommentsCard({required this.taskId});
          
            @override
            State<_CommentsCard> createState() => _CommentsCardState();
          }
          
          class _CommentsCardState extends State<_CommentsCard> {
            final _api = ApiService();
            final _text = TextEditingController();
            bool _busy = false;
          
            @override
            void dispose() {
              _text.dispose();
              super.dispose();
            }
          
            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
          
              final stream = FirebaseFirestore.instance
                  .collection('tasks')
                  .doc(widget.taskId)
                  .collection('comments')
                  .orderBy('createdAt', descending: false)
                  .limit(250)
                  .snapshots();
          
              return GlassCard(
                title: 'Comments',
                subtitle: 'Mentions notify teammates',
                accentColor: AppTheme.orange,
                trailing: _busy ? const LoadingIndicator(size: 18) : null,
                child: Column(
                  children: [
                    StreamBuilder<QuerySnapshot>(
                      stream: stream,
                      builder: (context, snap) {
                        if (!snap.hasData) {
                          return const Padding(
                            padding: EdgeInsets.all(12),
                            child: Center(child: LoadingIndicator()),
                          );
                        }
                        final docs = snap.data!.docs;
                        if (docs.isEmpty) {
                          return const Padding(
                            padding: EdgeInsets.all(8),
                            child: Text('No comments yet.'),
                          );
                        }
                        final comments = docs.map((d) => CommentModel.fromJson(d.data() as Map<String, dynamic>, d.id)).toList();
                        return Column(
                          children: comments.map((c) {
                            return ListTile(
                              title: Text(c.authorName ?? c.authorEmail, style: GoogleFonts.inter(fontWeight: FontWeight.w800)),
                              subtitle: Text(
                                c.text,
                                style: GoogleFonts.inter(fontWeight: FontWeight.w600),
                              ),
                              trailing: Text(AppDateUtils.formatDateTime(c.createdAt), style: GoogleFonts.inter(fontSize: 11, color: AppTheme.gray)),
                            );
                          }).toList(),
                        );
                      },
                    ),
                    const SizedBox(height: 10),
                    TextField(
                      controller: _text,
                      maxLines: 3,
                      decoration: const InputDecoration(
                        hintText: 'Write a comment‚Ä¶',
                        prefixIcon: Icon(Icons.chat_bubble_outline_rounded),
                      ),
                    ),
                    const SizedBox(height: 10),
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        onPressed: _busy
                            ? null
                            : () async {
                                final t = _text.text.trim();
                                if (t.isEmpty) {
                                  Helpers.showSnackBar(context, 'Write a comment first', isError: true);
                                  return;
                                }
                                setState(() => _busy = true);
                                final res = await _api.addComment(widget.taskId, t);
                                setState(() => _busy = false);
                                if (!mounted) return;
                                if (!res.ok) {
                                  Helpers.showSnackBar(context, res.error ?? 'Comment failed', isError: true);
                                  return;
                                }
                                _text.clear();
                                Helpers.showSnackBar(context, 'Comment added', isSuccess: true);
                              },
                        icon: const Icon(Icons.send_rounded),
                        label: const Text('Add comment'),
                      ),
                    ),
                  ],
                ),
              );
            }
          }
          
          class _TimelineCard extends StatelessWidget {
            final String taskId;
            const _TimelineCard({required this.taskId});
          
            @override
            Widget build(BuildContext context) {
              final stream = FirebaseFirestore.instance
                  .collection('auditLogs')
                  .where('taskId', isEqualTo: taskId)
                  .limit(250)
                  .snapshots();
          
              return GlassCard(
                title: 'Timeline',
                subtitle: 'Audit logs for status, edits, uploads, offline updates',
                accentColor: AppTheme.gray,
                child: StreamBuilder<QuerySnapshot>(
                  stream: stream,
                  builder: (context, snap) {
                    if (!snap.hasData) {
                      return const Center(child: LoadingIndicator());
                    }
                    final docs = snap.data!.docs;
                    if (docs.isEmpty) {
                      return const Text('No timeline entries yet.');
                    }
                    final items = docs
                        .map((d) => AuditLogModel.fromJson(d.data() as Map<String, dynamic>, d.id))
                        .toList()
                      ..sort((a, b) => a.timestamp.compareTo(b.timestamp));
          
                    return Column(
                      children: items.map((a) {
                        return ListTile(
                          title: Text(a.action, style: GoogleFonts.inter(fontWeight: FontWeight.w900)),
                          subtitle: Text(
                            '${a.actorEmail ?? ''}\\n${a.details.isNotEmpty ? a.details.toString() : ''}',
                            style: GoogleFonts.inter(fontWeight: FontWeight.w600),
                          ),
                          trailing: Text(AppDateUtils.formatDateTime(a.timestamp), style: GoogleFonts.inter(fontSize: 11, color: AppTheme.gray)),
                        );
                      }).toList(),
                    );
                  },
                ),
              );
            }
          }
          
          class _DangerZone extends StatelessWidget {
            final TaskModel task;
            const _DangerZone({required this.task});
          
            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final api = ApiService();
          
              return GlassCard(
                title: 'Danger zone',
                subtitle: 'Delete task / series',
                accentColor: AppTheme.danger,
                child: Column(
                  children: [
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton.icon(
                        style: ElevatedButton.styleFrom(backgroundColor: AppTheme.danger),
                        onPressed: () async {
                          final ok = await showDialog<bool>(
                            context: context,
                            builder: (ctx) => AlertDialog(
                              title: const Text('Delete task?'),
                              content: const Text('This cannot be undone.'),
                              actions: [
                                TextButton(onPressed: () => Navigator.pop(ctx, false), child: const Text('Cancel')),
                                ElevatedButton(
                                  style: ElevatedButton.styleFrom(backgroundColor: AppTheme.danger),
                                  onPressed: () => Navigator.pop(ctx, true),
                                  child: const Text('Delete'),
                                ),
                              ],
                            ),
                          );
                          if (ok != true) return;
                          final res = await api.deleteTask(task.id, applyToSeries: false);
                          if (!context.mounted) return;
                          if (!res.ok) {
                            Helpers.showSnackBar(context, res.error ?? 'Delete failed', isError: true);
                            return;
                          }
                          Helpers.showSnackBar(context, 'Deleted', isSuccess: true);
                          Navigator.pop(context);
                        },
                        icon: const Icon(Icons.delete_outline_rounded),
                        label: const Text('Delete task'),
                      ),
                    ),
                    if ((task.seriesId ?? '').isNotEmpty && auth.canEditDetails) ...[
                      const SizedBox(height: 10),
                      SizedBox(
                        width: double.infinity,
                        child: OutlinedButton.icon(
                          onPressed: () async {
                            final ok = await showDialog<bool>(
                              context: context,
                              builder: (ctx) => AlertDialog(
                                title: const Text('Delete entire series?'),
                                content: const Text('Deletes all tasks in this series.'),
                                actions: [
                                  TextButton(onPressed: () => Navigator.pop(ctx, false), child: const Text('Cancel')),
                                  ElevatedButton(
                                    style: ElevatedButton.styleFrom(backgroundColor: AppTheme.danger),
                                    onPressed: () => Navigator.pop(ctx, true),
                                    child: const Text('Delete series'),
                                  ),
                                ],
                              ),
                            );
                            if (ok != true) return;
                            final res = await api.deleteTask(task.id, applyToSeries: true);
                            if (!context.mounted) return;
                            if (!res.ok) {
                              Helpers.showSnackBar(context, res.error ?? 'Delete failed', isError: true);
                              return;
                            }
                            Helpers.showSnackBar(context, 'Series deleted', isSuccess: true);
                            Navigator.pop(context);
                          },
                          icon: const Icon(Icons.delete_sweep_rounded),
                          label: const Text('Delete series'),
                        ),
                      ),
                    ],
                  ],
                ),
              );
            }
          }
          ''')
          
          write_file('flutter_app/lib/screens/create_task_screen.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../config/constants.dart';
          import '../config/theme.dart';
          import '../providers/app_provider.dart';
          import '../providers/auth_provider.dart';
          import '../services/api_service.dart';
          import '../utils/date_utils.dart';
          import '../utils/helpers.dart';
          import '../widgets/loading_overlay.dart';
          
          class CreateTaskScreen extends StatefulWidget {
            final bool oneOnly; // if true => AD_HOC + generateCount=1
            const CreateTaskScreen({super.key, required this.oneOnly});
          
            @override
            State<CreateTaskScreen> createState() => _CreateTaskScreenState();
          }
          
          class _CreateTaskScreenState extends State<CreateTaskScreen> {
            final _api = ApiService();
            bool _busy = false;
          
            String _clientId = '';
            final _clientName = TextEditingController();
            final _clientEmail = TextEditingController();
          
            final _assignedToEmail = TextEditingController();
            final _title = TextEditingController();
            final _type = TextEditingController(text: 'FILING');
          
            String _category = 'OTHER';
            String _priority = 'MEDIUM';
          
            final _dueDmy = TextEditingController();
            final _triggerDays = TextEditingController(text: '15');
          
            String _recurrence = 'AD_HOC';
            final _generateCount = TextEditingController(text: '1');
          
            // mail settings
            bool _sendStart = true;
            bool _sendCompletion = true;
          
            final _to = TextEditingController();
            final _cc = TextEditingController();
            final _bcc = TextEditingController();
            bool _ccAssigneeStart = false;
            bool _ccManagerStart = false;
          
            final _startSubject = TextEditingController(text: 'We started {{taskTitle}}');
            final _startBody = TextEditingController(
              text:
                  'Dear {{clientName}},\\\\n\\\\nWe started work on {{taskTitle}}.\\\\nDue: {{dueDate}}\\\\n\\\\nAdd to calendar: {{addToCalendarUrl}}\\\\n\\\\nRegards,\\\\nCompliance Team',
            );
          
            bool _ccAssigneeCompletion = false;
            bool _ccManagerCompletion = false;
            final _completionSubject = TextEditingController(text: 'Completed: {{taskTitle}}');
            final _completionBody = TextEditingController(
              text:
                  'Dear {{clientName}},\\\\n\\\\nWe have completed {{taskTitle}}.\\\\nCompleted at: {{completedAt}}\\\\n\\\\nRegards,\\\\nCompliance Team',
            );
          
            @override
            void initState() {
              super.initState();
              if (widget.oneOnly) {
                _recurrence = 'AD_HOC';
                _generateCount.text = '1';
              }
              final auth = context.read<AuthProvider>();
              if (!auth.canEditDetails) {
                _assignedToEmail.text = auth.email;
              }
            }
          
            @override
            void dispose() {
              _clientName.dispose();
              _clientEmail.dispose();
              _assignedToEmail.dispose();
              _title.dispose();
              _type.dispose();
              _dueDmy.dispose();
              _triggerDays.dispose();
              _generateCount.dispose();
              _to.dispose();
              _cc.dispose();
              _bcc.dispose();
              _startSubject.dispose();
              _startBody.dispose();
              _completionSubject.dispose();
              _completionBody.dispose();
              super.dispose();
            }
          
            Future<void> _create() async {
              final auth = context.read<AuthProvider>();
              final app = context.read<AppProvider>();
          
              if (_title.text.trim().isEmpty) {
                Helpers.showSnackBar(context, 'Title is required', isError: true);
                return;
              }
              if ((_clientId.isEmpty) && _clientName.text.trim().isEmpty) {
                Helpers.showSnackBar(context, 'Select a client or enter client name', isError: true);
                return;
              }
          
              String dueYmd;
              try {
                dueYmd = AppDateUtils.dmyToYmd(_dueDmy.text.trim());
              } catch (e) {
                Helpers.showSnackBar(context, e.toString(), isError: true);
                return;
              }
          
              setState(() => _busy = true);
              final res = await _api.createTask({
                'clientId': _clientId.isEmpty ? null : _clientId,
                'clientName': _clientName.text.trim().isEmpty ? null : _clientName.text.trim(),
                'clientEmail': _clientEmail.text.trim().isEmpty ? null : _clientEmail.text.trim(),
                'assignedToEmail': _assignedToEmail.text.trim().isEmpty ? null : _assignedToEmail.text.trim(),
                'title': _title.text.trim(),
                'type': _type.text.trim(),
                'category': _category,
                'priority': _priority,
                'dueDateYmd': dueYmd,
                'triggerDaysBefore': int.tryParse(_triggerDays.text.trim()) ?? 15,
                'recurrence': widget.oneOnly ? 'AD_HOC' : _recurrence,
                'generateCount': widget.oneOnly ? 1 : (int.tryParse(_generateCount.text.trim()) ?? 1),
                // Start mail
                'sendClientStartMail': _sendStart,
                'clientToEmails': Helpers.parseEmailList(_to.text),
                'clientCcEmails': Helpers.parseEmailList(_cc.text),
                'clientBccEmails': Helpers.parseEmailList(_bcc.text),
                'ccAssigneeOnClientStart': _ccAssigneeStart,
                'ccManagerOnClientStart': _ccManagerStart,
                'clientStartSubject': _startSubject.text,
                'clientStartBody': _startBody.text,
                // Completion mail
                'sendClientCompletionMail': _sendCompletion,
                'ccAssigneeOnCompletion': _ccAssigneeCompletion,
                'ccManagerOnCompletion': _ccManagerCompletion,
                'clientCompletionSubject': _completionSubject.text,
                'clientCompletionBody': _completionBody.text,
              });
              setState(() => _busy = false);
          
              if (!mounted) return;
              if (!res.ok) {
                Helpers.showSnackBar(context, res.error ?? 'Create failed', isError: true);
                return;
              }
              Helpers.showSnackBar(context, 'Task(s) created', isSuccess: true);
              Navigator.pop(context);
            }
          
            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
          
              return LoadingOverlay(
                isLoading: _busy,
                message: 'Creating‚Ä¶',
                child: Scaffold(
                  appBar: AppBar(
                    title: Text(widget.oneOnly ? 'Create ONE task' : 'Create task / series'),
                  ),
                  body: SingleChildScrollView(
                    padding: const EdgeInsets.fromLTRB(16, 16, 16, 16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        if (auth.canAccessClients)
                          DropdownButtonFormField<String>(
                            value: _clientId.isEmpty ? null : _clientId,
                            items: [
                              const DropdownMenuItem(value: '', child: Text('(select client)')),
                              ...app.clients.map((c) => DropdownMenuItem(value: c.id, child: Text(c.name))),
                            ],
                            onChanged: (v) => setState(() => _clientId = (v ?? '')),
                            decoration: const InputDecoration(labelText: 'Client (list)'),
                          ),
                        const SizedBox(height: 10),
                        TextField(controller: _clientName, decoration: const InputDecoration(labelText: 'Client name (if not in list)')),
                        const SizedBox(height: 10),
                        TextField(controller: _clientEmail, decoration: const InputDecoration(labelText: 'Client email (optional)')),
                        const SizedBox(height: 10),
                        TextField(
                          controller: _assignedToEmail,
                          enabled: auth.canEditDetails,
                          decoration: InputDecoration(
                            labelText: 'Assignee email',
                            helperText: auth.canEditDetails ? null : 'Associates create tasks assigned to themselves',
                          ),
                        ),
                        const SizedBox(height: 10),
                        TextField(controller: _title, decoration: const InputDecoration(labelText: 'Title')),
                        const SizedBox(height: 10),
                        Row(
                          children: [
                            Expanded(
                              child: DropdownButtonFormField<String>(
                                value: _category,
                                items: AppConstants.categories.map((c) => DropdownMenuItem(value: c, child: Text(c))).toList(),
                                onChanged: (v) => setState(() => _category = v ?? _category),
                                decoration: const InputDecoration(labelText: 'Category'),
                              ),
                            ),
                            const SizedBox(width: 10),
                            Expanded(
                              child: DropdownButtonFormField<String>(
                                value: _priority,
                                items: AppConstants.priorities.map((p) => DropdownMenuItem(value: p, child: Text(p))).toList(),
                                onChanged: (v) => setState(() => _priority = v ?? _priority),
                                decoration: const InputDecoration(labelText: 'Priority'),
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 10),
                        TextField(controller: _type, decoration: const InputDecoration(labelText: 'Type')),
                        const SizedBox(height: 10),
                        Row(
                          children: [
                            Expanded(child: TextField(controller: _dueDmy, decoration: const InputDecoration(labelText: 'Due (DD-MM-YYYY)'))),
                            const SizedBox(width: 10),
                            Expanded(child: TextField(controller: _triggerDays, keyboardType: TextInputType.number, decoration: const InputDecoration(labelText: 'Trigger days'))),
                          ],
                        ),
                        const SizedBox(height: 10),
                        if (!widget.oneOnly)
                          Row(
                            children: [
                              Expanded(
                                child: DropdownButtonFormField<String>(
                                  value: _recurrence,
                                  items: AppConstants.recurrenceTypes.map((r) {
                                    return DropdownMenuItem(value: r, child: Text(r));
                                  }).toList(),
                                  onChanged: (v) => setState(() => _recurrence = v ?? _recurrence),
                                  decoration: const InputDecoration(labelText: 'Recurrence'),
                                ),
                              ),
                              const SizedBox(width: 10),
                              Expanded(
                                child: TextField(
                                  controller: _generateCount,
                                  keyboardType: TextInputType.number,
                                  decoration: const InputDecoration(labelText: 'Generate count'),
                                ),
                              ),
                            ],
                          ),
                        const SizedBox(height: 16),
                        Text('Start email', style: GoogleFonts.inter(fontWeight: FontWeight.w900)),
                        SwitchListTile(
                          value: _sendStart,
                          onChanged: (v) => setState(() => _sendStart = v),
                          title: Text('Send start email', style: GoogleFonts.inter(fontWeight: FontWeight.w800)),
                          contentPadding: EdgeInsets.zero,
                        ),
                        TextField(controller: _to, decoration: const InputDecoration(labelText: 'To overrides (;)')),
                        const SizedBox(height: 10),
                        Row(
                          children: [
                            Expanded(child: TextField(controller: _cc, decoration: const InputDecoration(labelText: 'CC overrides (;)'))),
                            const SizedBox(width: 10),
                            Expanded(child: TextField(controller: _bcc, decoration: const InputDecoration(labelText: 'BCC overrides (;)'))),
                          ],
                        ),
                        const SizedBox(height: 10),
                        Row(
                          children: [
                            Expanded(
                              child: SwitchListTile(
                                value: _ccAssigneeStart,
                                onChanged: (v) => setState(() => _ccAssigneeStart = v),
                                title: Text('CC assignee', style: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 13)),
                                contentPadding: EdgeInsets.zero,
                              ),
                            ),
                            Expanded(
                              child: SwitchListTile(
                                value: _ccManagerStart,
                                onChanged: (v) => setState(() => _ccManagerStart = v),
                                title: Text('CC manager', style: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 13)),
                                contentPadding: EdgeInsets.zero,
                              ),
                            ),
                          ],
                        ),
                        TextField(controller: _startSubject, decoration: const InputDecoration(labelText: 'Start subject')),
                        const SizedBox(height: 10),
                        TextField(controller: _startBody, maxLines: 5, decoration: const InputDecoration(labelText: 'Start body')),
                        const SizedBox(height: 16),
                        Text('Completion email', style: GoogleFonts.inter(fontWeight: FontWeight.w900)),
                        SwitchListTile(
                          value: _sendCompletion,
                          onChanged: (v) => setState(() => _sendCompletion = v),
                          title: Text('Send completion email', style: GoogleFonts.inter(fontWeight: FontWeight.w800)),
                          contentPadding: EdgeInsets.zero,
                        ),
                        Row(
                          children: [
                            Expanded(
                              child: SwitchListTile(
                                value: _ccAssigneeCompletion,
                                onChanged: (v) => setState(() => _ccAssigneeCompletion = v),
                                title: Text('CC assignee', style: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 13)),
                                contentPadding: EdgeInsets.zero,
                              ),
                            ),
                            Expanded(
                              child: SwitchListTile(
                                value: _ccManagerCompletion,
                                onChanged: (v) => setState(() => _ccManagerCompletion = v),
                                title: Text('CC manager', style: GoogleFonts.inter(fontWeight: FontWeight.w700, fontSize: 13)),
                                contentPadding: EdgeInsets.zero,
                              ),
                            ),
                          ],
                        ),
                        TextField(controller: _completionSubject, decoration: const InputDecoration(labelText: 'Completion subject')),
                        const SizedBox(height: 10),
                        TextField(controller: _completionBody, maxLines: 5, decoration: const InputDecoration(labelText: 'Completion body')),
                        const SizedBox(height: 16),
                        SizedBox(
                          width: double.infinity,
                          child: ElevatedButton.icon(
                            onPressed: _create,
                            icon: const Icon(Icons.check_circle_outline_rounded),
                            label: Text(widget.oneOnly ? 'Create task' : 'Create task(s)'),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            }
          }
          ''')
          
          write_file('flutter_app/lib/screens/client_detail_screen.dart', '''
          import 'package:flutter/material.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../config/theme.dart';
          import '../models/client_model.dart';
          import '../providers/app_provider.dart';
          import '../providers/auth_provider.dart';
          import '../services/api_service.dart';
          import '../utils/date_utils.dart';
          import '../utils/helpers.dart';
          import '../widgets/glass_card.dart';
          import '../widgets/loading_overlay.dart';
          
          class ClientDetailScreen extends StatefulWidget {
            final String clientId;
            const ClientDetailScreen({super.key, required this.clientId});
          
            @override
            State<ClientDetailScreen> createState() => _ClientDetailScreenState();
          }
          
          class _ClientDetailScreenState extends State<ClientDetailScreen> {
            final _api = ApiService();
            bool _busy = false;
          
            final _from = TextEditingController(text: '01-01-2026');
            final _to = TextEditingController(text: '31-12-2026');
          
            ClientModel? _client(AppProvider app) => app.clientsById[widget.clientId];
          
            Future<void> _save(ClientModel c) async {
              setState(() => _busy = true);
              final res = await _api.updateClient({
                'clientId': c.id,
                'name': _name.text.trim(),
                'pan': _pan.text.trim(),
                'gstin': _gstin.text.trim(),
                'cin': _cin.text.trim(),
                'assessmentYear': _ay.text.trim(),
                'engagementType': _eng.text.trim(),
                'primaryEmail': _email.text.trim(),
                'ccEmails': Helpers.parseEmailList(_cc.text),
                'bccEmails': Helpers.parseEmailList(_bcc.text),
              });
              setState(() => _busy = false);
              if (!mounted) return;
              if (!res.ok) {
                Helpers.showSnackBar(context, res.error ?? 'Save failed', isError: true);
                return;
              }
              Helpers.showSnackBar(context, 'Saved', isSuccess: true);
            }
          
            late final _name = TextEditingController();
            late final _pan = TextEditingController();
            late final _gstin = TextEditingController();
            late final _cin = TextEditingController();
            late final _ay = TextEditingController();
            late final _eng = TextEditingController();
            late final _email = TextEditingController();
            late final _cc = TextEditingController();
            late final _bcc = TextEditingController();
          
            bool _inited = false;
            void _initIfNeeded(ClientModel c) {
              if (_inited) return;
              _inited = true;
              _name.text = c.name;
              _pan.text = c.pan ?? '';
              _gstin.text = c.gstin ?? '';
              _cin.text = c.cin ?? '';
              _ay.text = c.assessmentYear ?? '';
              _eng.text = c.engagementType ?? '';
              _email.text = c.primaryEmail ?? '';
              _cc.text = Helpers.joinEmails(c.ccEmails);
              _bcc.text = Helpers.joinEmails(c.bccEmails);
            }
          
            @override
            void dispose() {
              _from.dispose();
              _to.dispose();
              _name.dispose();
              _pan.dispose();
              _gstin.dispose();
              _cin.dispose();
              _ay.dispose();
              _eng.dispose();
              _email.dispose();
              _cc.dispose();
              _bcc.dispose();
              super.dispose();
            }
          
            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
              final c = _client(app);
          
              if (!auth.canAccessClients) {
                return const Scaffold(
                  body: Center(child: Text('Clients are partner-only')),
                );
              }
          
              if (c == null) {
                return const Scaffold(body: Center(child: CircularProgressIndicator()));
              }
          
              _initIfNeeded(c);
          
              return LoadingOverlay(
                isLoading: _busy,
                message: 'Working‚Ä¶',
                child: Scaffold(
                  appBar: AppBar(title: Text(c.name)),
                  body: SingleChildScrollView(
                    padding: const EdgeInsets.fromLTRB(16, 16, 16, 16),
                    child: Column(
                      children: [
                        GlassCard(
                          title: 'Client details',
                          subtitle: 'Edit and save master profile',
                          accentColor: AppTheme.viewAccents['clients'],
                          child: Column(
                            children: [
                              TextField(controller: _name, decoration: const InputDecoration(labelText: 'Name')),
                              const SizedBox(height: 10),
                              Row(
                                children: [
                                  Expanded(child: TextField(controller: _pan, decoration: const InputDecoration(labelText: 'PAN'))),
                                  const SizedBox(width: 10),
                                  Expanded(child: TextField(controller: _gstin, decoration: const InputDecoration(labelText: 'GSTIN'))),
                                ],
                              ),
                              const SizedBox(height: 10),
                              Row(
                                children: [
                                  Expanded(child: TextField(controller: _cin, decoration: const InputDecoration(labelText: 'CIN'))),
                                  const SizedBox(width: 10),
                                  Expanded(child: TextField(controller: _ay, decoration: const InputDecoration(labelText: 'Assessment Year'))),
                                ],
                              ),
                              const SizedBox(height: 10),
                              TextField(controller: _eng, decoration: const InputDecoration(labelText: 'Engagement type')),
                              const SizedBox(height: 10),
                              TextField(controller: _email, decoration: const InputDecoration(labelText: 'Primary email')),
                              const SizedBox(height: 10),
                              TextField(controller: _cc, decoration: const InputDecoration(labelText: 'CC emails (;)')),
                              const SizedBox(height: 10),
                              TextField(controller: _bcc, decoration: const InputDecoration(labelText: 'BCC emails (;)')),
                              const SizedBox(height: 12),
                              SizedBox(
                                width: double.infinity,
                                child: ElevatedButton.icon(
                                  onPressed: () => _save(c),
                                  icon: const Icon(Icons.save_rounded),
                                  label: const Text('Save'),
                                ),
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(height: 14),
                        GlassCard(
                          title: 'Client history exports',
                          subtitle: 'XLSX + PDF for a date range',
                          accentColor: AppTheme.orange,
                          child: Column(
                            children: [
                              TextField(controller: _from, decoration: const InputDecoration(labelText: 'From (DD-MM-YYYY)')),
                              const SizedBox(height: 10),
                              TextField(controller: _to, decoration: const InputDecoration(labelText: 'To (DD-MM-YYYY)')),
                              const SizedBox(height: 12),
                              Row(
                                children: [
                                  Expanded(
                                    child: OutlinedButton(
                                      onPressed: () async {
                                        final fromYmd = AppDateUtils.dmyToYmd(_from.text.trim());
                                        final toYmd = AppDateUtils.dmyToYmd(_to.text.trim());
                                        final res = await _api.exportClientHistoryXlsx(clientId: c.id, fromYmd: fromYmd, toYmd: toYmd);
                                        if (!context.mounted) return;
                                        if (!res.ok) {
                                          Helpers.showSnackBar(context, res.error ?? 'Export failed', isError: true);
                                          return;
                                        }
                                        await Helpers.downloadBase64File(
                                          context: context,
                                          fileName: (res.data['fileName'] ?? 'Client_History.xlsx').toString(),
                                          base64Data: (res.data['base64'] ?? '').toString(),
                                          mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                                        );
                                      },
                                      child: const Text('XLSX'),
                                    ),
                                  ),
                                  const SizedBox(width: 10),
                                  Expanded(
                                    child: ElevatedButton(
                                      onPressed: () async {
                                        final fromYmd = AppDateUtils.dmyToYmd(_from.text.trim());
                                        final toYmd = AppDateUtils.dmyToYmd(_to.text.trim());
                                        final res = await _api.reportClientHistoryPdf(clientId: c.id, fromYmd: fromYmd, toYmd: toYmd);
                                        if (!context.mounted) return;
                                        if (!res.ok) {
                                          Helpers.showSnackBar(context, res.error ?? 'PDF failed', isError: true);
                                          return;
                                        }
                                        await Helpers.downloadBase64File(
                                          context: context,
                                          fileName: (res.data['fileName'] ?? 'Client_History.pdf').toString(),
                                          base64Data: (res.data['base64'] ?? '').toString(),
                                          mimeType: (res.data['mime'] ?? 'application/pdf').toString(),
                                        );
                                      },
                                      child: const Text('PDF'),
                                    ),
                                  ),
                                ],
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              );
            }
          }
          ''')
          
          # ======= PATCH main_shell.dart (replace the TODO quick create) =======
          write_file('flutter_app/lib/screens/main_shell.dart', '''
          import 'dart:ui';
          import 'package:flutter/material.dart';
          import 'package:flutter_animate/flutter_animate.dart';
          import 'package:google_fonts/google_fonts.dart';
          import 'package:provider/provider.dart';
          import '../providers/auth_provider.dart';
          import '../providers/app_provider.dart';
          import '../config/theme.dart';
          import 'create_task_screen.dart';
          import 'tabs/home_tab.dart';
          import 'tabs/work_queue_tab.dart';
          import 'tabs/calendar_tab.dart';
          import 'tabs/clients_tab.dart';
          import 'tabs/studio_tab.dart';
          import 'tabs/ops_tab.dart';
          import 'tabs/help_tab.dart';
          
          class MainShell extends StatefulWidget {
            const MainShell({super.key});
            @override
            State<MainShell> createState() => _MainShellState();
          }
          
          class _MainShellState extends State<MainShell> {
            int _selectedIndex = 0;
          
            List<_NavItem> _getNavItems(AuthProvider auth) {
              return [
                const _NavItem(icon: Icons.space_dashboard_outlined, activeIcon: Icons.space_dashboard, label: 'Home', key: 'home'),
                const _NavItem(icon: Icons.list_alt_outlined, activeIcon: Icons.list_alt, label: 'Tasks', key: 'work'),
                const _NavItem(icon: Icons.calendar_month_outlined, activeIcon: Icons.calendar_month, label: 'Calendar', key: 'calendar'),
                if (auth.canAccessClients)
                  const _NavItem(icon: Icons.people_outline, activeIcon: Icons.people, label: 'Clients', key: 'clients'),
                const _NavItem(icon: Icons.edit_note_outlined, activeIcon: Icons.edit_note, label: 'Studio', key: 'studio'),
                if (auth.canAccessOps)
                  const _NavItem(icon: Icons.settings_outlined, activeIcon: Icons.settings, label: 'Ops', key: 'ops'),
                const _NavItem(icon: Icons.help_outline, activeIcon: Icons.help, label: 'Help', key: 'help'),
              ];
            }
          
            @override
            Widget build(BuildContext context) {
              final auth = context.watch<AuthProvider>();
              final app = context.watch<AppProvider>();
              final isDark = Theme.of(context).brightness == Brightness.dark;
              final navItems = _getNavItems(auth);
          
              if (_selectedIndex >= navItems.length) _selectedIndex = 0;
          
              return Scaffold(
                extendBody: true,
                appBar: _buildAppBar(context, auth, app, isDark),
                body: AnimatedSwitcher(
                  duration: const Duration(milliseconds: 250),
                  child: _buildBody(navItems[_selectedIndex].key, auth),
                ),
                bottomNavigationBar: _buildBottomNav(navItems, isDark),
                floatingActionButton: _buildFAB(),
              );
            }
          
            PreferredSizeWidget _buildAppBar(BuildContext context, AuthProvider auth, AppProvider app, bool isDark) {
              return PreferredSize(
                preferredSize: const Size.fromHeight(64),
                child: ClipRRect(
                  child: BackdropFilter(
                    filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                    child: Container(
                      decoration: BoxDecoration(
                        color: isDark ? const Color(0xFF1C1C1E).withOpacity(0.85) : Colors.white.withOpacity(0.85),
                        border: Border(bottom: BorderSide(color: isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.05))),
                      ),
                      child: SafeArea(
                        child: Padding(
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          child: Row(
                            children: [
                              Container(
                                width: 40,
                                height: 40,
                                decoration: BoxDecoration(borderRadius: BorderRadius.circular(12), gradient: AppTheme.primaryGradient),
                                child: const Icon(Icons.check_circle_outline, color: Colors.white, size: 22),
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text('ComplianceOS', style: GoogleFonts.inter(fontSize: 16, fontWeight: FontWeight.w800)),
                                    Row(
                                      children: [
                                        Container(
                                          padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 2),
                                          decoration: BoxDecoration(
                                            color: AppTheme.primary.withOpacity(0.15),
                                            borderRadius: BorderRadius.circular(4),
                                          ),
                                          child: Text(auth.role,
                                              style: GoogleFonts.inter(fontSize: 10, fontWeight: FontWeight.w700, color: AppTheme.primary)),
                                        ),
                                        const SizedBox(width: 6),
                                        Flexible(
                                          child: Text(
                                            auth.email,
                                            style: GoogleFonts.inter(fontSize: 11, color: AppTheme.gray),
                                            overflow: TextOverflow.ellipsis,
                                          ),
                                        ),
                                      ],
                                    ),
                                  ],
                                ),
                              ),
                              IconButton(
                                onPressed: () => app.toggleTheme(), // persisted in SharedPreferences (AppProvider)
                                icon: Icon(isDark ? Icons.light_mode_rounded : Icons.dark_mode_rounded, color: isDark ? Colors.white70 : Colors.black54),
                                tooltip: isDark ? 'Light mode' : 'Dark mode',
                              ),
                              GestureDetector(
                                onTap: () => _showProfileSheet(context, auth),
                                child: Container(
                                  width: 40,
                                  height: 40,
                                  decoration: BoxDecoration(
                                    shape: BoxShape.circle,
                                    gradient: LinearGradient(colors: [AppTheme.purple.withOpacity(0.8), AppTheme.pink.withOpacity(0.8)]),
                                  ),
                                  child: Center(
                                    child: Text(
                                      (auth.email.isNotEmpty ? auth.email[0] : 'U').toUpperCase(),
                                      style: GoogleFonts.inter(color: Colors.white, fontWeight: FontWeight.w700, fontSize: 16),
                                    ),
                                  ),
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
              );
            }
          
            Widget _buildBody(String key, AuthProvider auth) {
              switch (key) {
                case 'home':
                  return const HomeTab();
                case 'work':
                  return const WorkQueueTab();
                case 'calendar':
                  return const CalendarTab();
                case 'clients':
                  return const ClientsTab();
                case 'studio':
                  return const StudioTab();
                case 'ops':
                  return const OpsTab();
                case 'help':
                  return const HelpTab();
                default:
                  return const HomeTab();
              }
            }
          
            Widget _buildBottomNav(List<_NavItem> items, bool isDark) {
              return ClipRRect(
                child: BackdropFilter(
                  filter: ImageFilter.blur(sigmaX: 20, sigmaY: 20),
                  child: Container(
                    decoration: BoxDecoration(
                      color: isDark ? const Color(0xFF1C1C1E).withOpacity(0.92) : Colors.white.withOpacity(0.92),
                      border: Border(top: BorderSide(color: isDark ? Colors.white.withOpacity(0.1) : Colors.black.withOpacity(0.05))),
                    ),
                    child: SafeArea(
                      child: Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 4, vertical: 6),
                        child: Row(
                          mainAxisAlignment: MainAxisAlignment.spaceAround,
                          children: items.asMap().entries.map((entry) {
                            final index = entry.key;
                            final item = entry.value;
                            final isSelected = index == _selectedIndex;
                            return Expanded(
                              child: GestureDetector(
                                onTap: () => setState(() => _selectedIndex = index),
                                child: AnimatedContainer(
                                  duration: const Duration(milliseconds: 200),
                                  padding: const EdgeInsets.symmetric(vertical: 6),
                                  decoration: BoxDecoration(
                                    color: isSelected ? AppTheme.primary.withOpacity(0.12) : Colors.transparent,
                                    borderRadius: BorderRadius.circular(12),
                                  ),
                                  child: Column(
                                    mainAxisSize: MainAxisSize.min,
                                    children: [
                                      Icon(
                                        isSelected ? item.activeIcon : item.icon,
                                        color: isSelected ? AppTheme.primary : (isDark ? Colors.white54 : Colors.black45),
                                        size: 22,
                                      ),
                                      const SizedBox(height: 3),
                                      Text(
                                        item.label,
                                        style: GoogleFonts.inter(
                                          fontSize: 10,
                                          fontWeight: isSelected ? FontWeight.w700 : FontWeight.w600,
                                          color: isSelected ? AppTheme.primary : (isDark ? Colors.white54 : Colors.black45),
                                        ),
                                      ),
                                    ],
                                  ),
                                ),
                              ),
                            );
                          }).toList(),
                        ),
                      ),
                    ),
                  ),
                ),
              );
            }
          
            Widget _buildFAB() {
              return FloatingActionButton(
                onPressed: () => _showCreateChooser(),
                elevation: 4,
                child: Container(
                  width: 56,
                  height: 56,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(18),
                    gradient: AppTheme.primaryGradient,
                    boxShadow: [BoxShadow(color: AppTheme.primary.withOpacity(0.4), blurRadius: 16, offset: const Offset(0, 6))],
                  ),
                  child: const Icon(Icons.add_rounded, color: Colors.white, size: 28),
                ),
              ).animate().scale(delay: 400.ms, duration: 300.ms);
            }
          
            void _showCreateChooser() {
              showModalBottomSheet(
                context: context,
                backgroundColor: Colors.transparent,
                builder: (ctx) {
                  final isDark = Theme.of(ctx).brightness == Brightness.dark;
                  return Container(
                    padding: const EdgeInsets.all(16),
                    decoration: BoxDecoration(
                      color: isDark ? const Color(0xFF1C1C1E) : Colors.white,
                      borderRadius: const BorderRadius.vertical(top: Radius.circular(28)),
                    ),
                    child: SafeArea(
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        children: [
                          ListTile(
                            leading: const Icon(Icons.add_task_rounded),
                            title: const Text('Create task / series'),
                            onTap: () {
                              Navigator.pop(ctx);
                              Navigator.push(context, MaterialPageRoute(builder: (_) => const CreateTaskScreen(oneOnly: false)));
                            },
                          ),
                          ListTile(
                            leading: const Icon(Icons.flash_on_rounded),
                            title: const Text('Quick: create ONE task'),
                            onTap: () {
                              Navigator.pop(ctx);
                              Navigator.push(context, MaterialPageRoute(builder: (_) => const CreateTaskScreen(oneOnly: true)));
                            },
                          ),
                        ],
                      ),
                    ),
                  );
                },
              );
            }
          
            void _showProfileSheet(BuildContext context, AuthProvider auth) {
              final isDark = Theme.of(context).brightness == Brightness.dark;
              showModalBottomSheet(
                context: context,
                backgroundColor: Colors.transparent,
                isScrollControlled: true,
                builder: (context) => Container(
                  padding: const EdgeInsets.all(24),
                  decoration: BoxDecoration(
                    color: isDark ? const Color(0xFF1C1C1E) : Colors.white,
                    borderRadius: const BorderRadius.vertical(top: Radius.circular(28)),
                  ),
                  child: Column(
                    mainAxisSize: MainAxisSize.min,
                    children: [
                      Container(width: 40, height: 4, decoration: BoxDecoration(color: Colors.grey.withOpacity(0.3), borderRadius: BorderRadius.circular(2))),
                      const SizedBox(height: 24),
                      Container(
                        width: 80,
                        height: 80,
                        decoration: BoxDecoration(shape: BoxShape.circle, gradient: LinearGradient(colors: [AppTheme.purple, AppTheme.pink])),
                        child: Center(
                          child: Text(
                            (auth.email.isNotEmpty ? auth.email[0] : 'U').toUpperCase(),
                            style: GoogleFonts.inter(color: Colors.white, fontWeight: FontWeight.w800, fontSize: 32),
                          ),
                        ),
                      ),
                      const SizedBox(height: 16),
                      Text(auth.displayName.isNotEmpty ? auth.displayName : 'User', style: GoogleFonts.inter(fontSize: 20, fontWeight: FontWeight.w800)),
                      const SizedBox(height: 4),
                      Text(auth.email, style: GoogleFonts.inter(color: AppTheme.gray)),
                      const SizedBox(height: 12),
                      Container(
                        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                        decoration: BoxDecoration(color: AppTheme.primary.withOpacity(0.15), borderRadius: BorderRadius.circular(8)),
                        child: Text(auth.role, style: GoogleFonts.inter(color: AppTheme.primary, fontWeight: FontWeight.w700)),
                      ),
                      const SizedBox(height: 32),
                      SizedBox(
                        width: double.infinity,
                        child: ElevatedButton.icon(
                          onPressed: () {
                            Navigator.pop(context);
                            auth.signOut();
                          },
                          icon: const Icon(Icons.logout_rounded),
                          label: const Text('Sign Out'),
                          style: ElevatedButton.styleFrom(backgroundColor: AppTheme.danger, padding: const EdgeInsets.symmetric(vertical: 14)),
                        ),
                      ),
                      const SizedBox(height: 16),
                    ],
                  ),
                ),
              );
            }
          }
          
          class _NavItem {
            final IconData icon;
            final IconData activeIcon;
            final String label;
            final String key;
            const _NavItem({required this.icon, required this.activeIcon, required this.label, required this.key});
          }
          ''')
          EOF
          
          # If your original workflow already had the remaining build steps, DO NOT duplicate them.
          # Otherwise, append these steps:
          
      - name: Install Dependencies
        run: |
          cd flutter_app
          flutter pub get

      - name: Build APK
        run: |
          cd flutter_app
          flutter build apk --release
          cp build/app/outputs/flutter-apk/app-release.apk ../ComplianceOS-release.apk
          ls -lh ../ComplianceOS-release.apk

      - name: Commit Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add flutter_app/ ComplianceOS-release.apk || true
          git diff --staged --quiet || git commit -m "Build: Flutter APK $(date +'%Y-%m-%d %H:%M')"
          git push || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ComplianceOS-APK
          path: ComplianceOS-release.apk
          retention-days: 30

      - name: Summary
        run: |
          echo "## Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **APK Size:** $(du -h ComplianceOS-release.apk | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "- **Flutter:** $(flutter --version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Notes" >> $GITHUB_STEP_SUMMARY
          echo "- Theme mode is persisted via SharedPreferences (AppProvider)." >> $GITHUB_STEP_SUMMARY
          echo "- Ops/Clients are role-gated (Partner/Manager)." >> $GITHUB_STEP_SUMMARY
